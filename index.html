<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Banking — Username/Password + Class Join</title>

  <script>
    window.tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ------------------- Constants & helpers -------------------
    const ADMIN_USERNAME = 'admin';
    const ADMIN_DEFAULT_PASSWORD = 'admin123';

    const DB_KEY = 'teenbank_participants_v3';   // participants/users
    const CLASSES_KEY = 'teenbank_classes_v1';   // classes store
    const THEME_KEY = 'teenbank_theme';

    // Seed data (no passwords for normal users; admin added at load)
    const DEFAULT_PARTICIPANTS = [
      { id: 1, username: 'ava',  name: 'Ava',  subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 50, memo: 'Starting balance', ts: Date.now()-3_600_000}] },
      { id: 2, username: 'ben',  name: 'Ben',  subscriptionActive: true,  weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 75, memo: 'Starting balance', ts: Date.now()-2_600_000}] },
      { id: 3, username: 'maya', name: 'Maya', subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 30, memo: 'Starting balance', ts: Date.now()-1_600_000}] },
    ];

    function fmtUSD(n){ return (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function now(){ return Date.now(); }

    function computeBalance(user){
      const tx = user.transactions || [];
      return tx.reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    // --- crypto (demo only) ---
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function randomSalt(len=16){
      const arr = new Uint8Array(len); crypto.getRandomValues(arr);
      return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ------------------- Storage + migration -------------------
    function migrateIfNeeded(raw){
      // v2 -> v3: switch from email-based to username-based auth
      const list = raw ? JSON.parse(raw) : DEFAULT_PARTICIPANTS;
      return list.map(u => {
        const copy = {...u};
        if (!copy.username) {
          if (copy.email) {
            copy.username = String(copy.email).split('@')[0].toLowerCase();
          } else if (copy.name) {
            copy.username = String(copy.name).toLowerCase().replace(/\s+/g,'');
          } else {
            copy.username = 'user'+(copy.id||Math.floor(Math.random()*1e6));
          }
        }
        delete copy.email;
        delete copy.demoPassword;
        copy.transactions = Array.isArray(copy.transactions) ? copy.transactions : [];
        copy.weeklyDeductions = Array.isArray(copy.weeklyDeductions) ? copy.weeklyDeductions : [];
        copy.goals = Array.isArray(copy.goals) ? copy.goals : [];
        copy.budgets = typeof copy.budgets === 'object' && copy.budgets ? copy.budgets : {};
        return copy;
      });
    }

    function loadParticipants(){
      try {
        const stored = localStorage.getItem(DB_KEY);
        const arr = migrateIfNeeded(stored);
        if (!arr.find(u => u.username === ADMIN_USERNAME)) {
          arr.push({
            id: Date.now(),
            username: ADMIN_USERNAME,
            name: 'Admin',
            subscriptionActive: false,
            weeklyDeductions: [],
            goals: [],
            budgets: {},
            transactions: [],
          });
        }
        return arr;
      } catch (e){ console.warn('Load fail, using defaults', e); return migrateIfNeeded(); }
    }
    function saveParticipants(list){ localStorage.setItem(DB_KEY, JSON.stringify(list)); }

    function loadClasses(){
      try {
        const raw = localStorage.getItem(CLASSES_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        // ensure shape: {id: '1234', title?: string, members: [usernames]}
        return arr.map(c => ({ id: String(c.id), title: c.title || null, members: Array.isArray(c.members)? c.members: [] }));
      } catch(e){ return []; }
    }
    function saveClasses(list){ localStorage.setItem(CLASSES_KEY, JSON.stringify(list)); }

    // ------------------- UI primitives -------------------
    function Toast({ text, onClose }){
      useEffect(() => { const t = setTimeout(onClose, 1800); return () => clearTimeout(t); }, [onClose]);
      return <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/90 text-white text-sm px-3 py-2 rounded shadow-lg">{text}</div>;
    }

    function ProgressBar({ value, max }){
      const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
      return (
        <div className="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden" role="progressbar" aria-valuenow={pct} aria-valuemin="0" aria-valuemax="100">
          <div className="h-2 bg-indigo-600" style={{ width: pct + '%' }} />
        </div>
      );
    }

    function GoalRow({ g, onContribute }){
      const [contrib, setContrib] = useState('');
      const saved = Number(g.saved)||0; const target = Number(g.target)||0; const remaining = Math.max(0, target - saved);
      return (
        <div className="p-3 rounded border border-slate-200 dark:border-slate-700">
          <div className="flex items-center justify-between gap-2">
            <div>
              <div className="font-medium">{g.name}</div>
              <div className="text-sm text-slate-600 dark:text-slate-300">{fmtUSD(saved)} / {fmtUSD(target)} <span className="text-slate-500">({fmtUSD(remaining)} left)</span></div>
            </div>
            <div className="flex items-center gap-2">
              <input className="border p-1 rounded w-28 dark:bg-slate-800 dark:border-slate-700" type="number" step="0.01" placeholder="$ add" value={contrib} onChange={e=>setContrib(e.target.value)} />
              <button className="bg-emerald-600 text-white px-3 py-1 rounded" onClick={()=>{ const n = parseFloat(contrib); if(!Number.isNaN(n) && n>0){ onContribute(n); setContrib(''); } }}>Contribute</button>
            </div>
          </div>
          <div className="mt-2"><ProgressBar value={saved} max={target} /></div>
        </div>
      );
    }

    // ------------------- Admin Panel -------------------
    function AdminPanel({ participants, classes, onAdjust, onSubscribe, onCancel, onDelete, onRenameClass, onRemoveFromClass }){
      const [q,setQ] = useState('');
      const filtered = React.useMemo(()=>{
        // Only show users NOT in any class in the general list
        const members = new Set(classes.flatMap(c => c.members));
        const base = participants.filter(p => !members.has(p.username));
        const t = q.trim().toLowerCase();
        if(!t) return base;
        return base.filter(p => (p.name+' '+p.username).toLowerCase().includes(t));
      }, [participants, classes, q]); if(!t) return participants;
        return participants.filter(p => (p.name+' '+p.username).toLowerCase().includes(t));
      }, [participants, q]);

      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-6">
          <div>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">Admin · Unassigned Participants</h3>
              <input className="border rounded px-2 py-1 text-sm dark:bg-slate-900 dark:border-slate-700" placeholder="Search name or username" value={q} onChange={e=>setQ(e.target.value)} />
            </div>
            <ul className="divide-y dark:divide-slate-700">
              {filtered.map(p => (
                <li key={p.id} className="py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div className="space-y-1">
                    <div className="font-medium">{p.name} <span className="text-slate-500">(@{p.username})</span></div>
                    <div className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(computeBalance(p))}</strong></div>
                    <div className="text-xs text-slate-500">Subscription: {p.subscriptionActive ? 'Active' : 'Inactive'}</div>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <button className="px-3 py-1 rounded bg-indigo-600 text-white text-xs" onClick={()=>onSubscribe(p.id)}>Activate</button>
                    <button className="px-3 py-1 rounded bg-rose-600 text-white text-xs" onClick={()=>onCancel(p.id)}>Cancel</button>
                    <button className="px-3 py-1 rounded bg-emerald-600 text-white text-xs" onClick={()=>onAdjust(p.id, +5, 'Admin +$5')}>+ $5</button>
                    <button className="px-3 py-1 rounded bg-amber-600 text-white text-xs" onClick={()=>onAdjust(p.id, -5, 'Admin -$5')}>− $5</button>
                    <button className="px-3 py-1 rounded bg-slate-800 text-white text-xs" onClick={()=>onDelete(p.id)}>Delete</button>
                  </div>
                </li>
              ))}
            </ul>
          </div>

          {/* Classes (ADMIN-ONLY VIEW) */}
          <div>
            <h3 className="text-lg font-semibold mb-2">Classes</h3>
            {classes.length === 0 && (
              <p className="text-sm text-slate-500">No classes yet. Students can join by entering a class number on their dashboard.</p>
            )}
            <ul className="space-y-3">
              {classes.map(cls => (
                <li key={cls.id} className="p-3 rounded border border-slate-200 dark:border-slate-700">
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <div className="font-medium">Class #{cls.id}{cls.title ? ` — ${cls.title}` : ''}</div>
                      <div className="text-xs text-slate-500">Members: {cls.members.length}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <input className="border rounded px-2 py-1 text-sm w-44 dark:bg-slate-900 dark:border-slate-700" placeholder="Rename (optional)" onKeyDown={e=>{ if(e.key==='Enter'){ onRenameClass(cls.id, e.currentTarget.value.trim()); e.currentTarget.value=''; } }} />
                      <button className="px-3 py-1 rounded bg-slate-200 dark:bg-slate-700 text-xs" onClick={()=>{
                        const newTitle = prompt('New title for Class #'+cls.id, cls.title||'');
                        if (newTitle !== null) onRenameClass(cls.id, newTitle.trim());
                      }}>Rename</button>
                    </div>
                  </div>
                  <ul className="mt-2 divide-y dark:divide-slate-700">
                    {cls.members.map(m => {
                    const p = participants.find(u => u.username === m);
                    if (!p) {
                      return (
                        <li key={m} className="py-2 flex items-center justify-between">
                          <span className="text-sm">@{m}</span>
                          <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white" onClick={()=>onRemoveFromClass(cls.id, m)}>Remove</button>
                        </li>
                      );
                    }
                    const balance = fmtUSD(computeBalance(p));
                    return (
                      <li key={m} className="py-3">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className="font-medium">{p.name} <span className="text-slate-500">(@{p.username})</span></div>
                            <div className="text-xs text-slate-600 dark:text-slate-300">Balance: <strong>{balance}</strong> · Subscription: {p.subscriptionActive ? 'Active' : 'Inactive'}</div>
                            <div className="mt-1 text-xs text-slate-500">Goals: {p.goals?.length||0} · Weekly deductions: {p.weeklyDeductions?.length||0} · Budgets: {Object.keys(p.budgets||{}).length}</div>
                          </div>
                          <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white self-start" onClick={()=>onRemoveFromClass(cls.id, m)}>Remove</button>
                        </div>
                      </li>
                    );
                  })}
                    {cls.members.length===0 && <li className="py-2 text-sm text-slate-500">No members yet.</li>}
                  </ul>
                </li>
              ))}
            </ul>
          </div>
        </section>
      );
    }

    // ------------------- User Panel -------------------
    function UserPanel({ user, updateUser, applyWeeklyAll, onJoinClass }){
      const [delta, setDelta] = useState('');
      const [memo, setMemo] = useState('');
      const [wdName, setWdName] = useState('');
      const [wdAmt, setWdAmt] = useState('');
      const [goalName, setGoalName] = useState('');
      const [goalTarget, setGoalTarget] = useState('');
      const [cat, setCat] = useState('');
      const [bAmt, setBAmt] = useState('');
      const [classCode, setClassCode] = useState('');

      const balance = useMemo(()=> computeBalance(user), [user.transactions]);

      function pushTx(amount, memo){
        updateUser(u => ({...u, transactions: [...(u.transactions||[]), { amount: Number(amount), memo: memo||null, ts: now() }]}));
      }

      function deposit(){
        const n = parseFloat(delta); if(Number.isNaN(n) || n <= 0) return;
        let remaining = n;
        const updGoals = (user.goals||[]).map(g => {
          if (remaining <= 0) return g;
          const need = Math.max(0, Number(g.target) - Number(g.saved));
          const add = Math.min(need, remaining);
          remaining -= add; return {...g, saved: Number(g.saved)+add};
        });
        updateUser(u => ({...u, goals: updGoals}));
        pushTx(n, memo || 'Deposit');
        setDelta(''); setMemo('');
      }

      function withdraw(){
        const n = parseFloat(delta); if(Number.isNaN(n) || n <= 0) return;
        pushTx(-n, memo || 'Withdraw');
        setDelta(''); setMemo('');
      }

      function undoLast(){
        updateUser(u => ({...u, transactions: (u.transactions||[]).slice(0, -1)}));
      }

      function addWeekly(){
        const n = parseFloat(wdAmt); if(!wdName || Number.isNaN(n) || n<=0) return;
        updateUser(u => ({...u, weeklyDeductions: [...(u.weeklyDeductions||[]), { name: wdName, amount: n }]}));
        pushTx(-n, `Weekly: ${wdName}`);
        setWdName(''); setWdAmt('');
      }

      function removeWeekly(idx){
        updateUser(u => { const arr = [...(u.weeklyDeductions||[])]; arr.splice(idx,1); return {...u, weeklyDeductions: arr}; });
      }

      function addGoal(){
        const t = parseFloat(goalTarget); if(!goalName || Number.isNaN(t) || t<=0) return;
        updateUser(u => ({...u, goals: [...(u.goals||[]), { name: goalName, target: t, saved: 0 }]}));
        setGoalName(''); setGoalTarget('');
      }

      function contributeGoal(idx, amt){
        const n = Number(amt); if(Number.isNaN(n) || n<=0) return;
        updateUser(u => {
          const goals = [...(u.goals||[])];
          const g = {...goals[idx]};
          const maxAdd = Math.min(n, Math.max(0, Number(g.target) - Number(g.saved)));
          if (maxAdd <= 0) return u;
          g.saved = Number(g.saved) + maxAdd; goals[idx] = g;
          return {...u, goals};
        });
        pushTx(-n, 'Goal contribution');
      }

      function upsertBudget(){
        const n = parseFloat(bAmt); if(!cat || Number.isNaN(n) || n<=0) return;
        updateUser(u => ({...u, budgets: { ...(u.budgets||{}), [cat]: n }}));
        setCat(''); setBAmt('');
      }

      function deleteBudget(k){
        updateUser(u => { const b = { ...(u.budgets||{}) }; delete b[k]; return {...u, budgets: b}; });
      }

      function joinClass(classId, username){
        const id = String(classId);
        // Enforce: a student may only be in ONE class until an admin removes them
        const alreadyInSomeClass = classes.some(c => c.members.includes(username));
        if (alreadyInSomeClass) { notify('You are already in a class. Ask an admin to remove you to join a different one.'); return; }
        // ensure class exists
        if (!classes.find(c => c.id === id)) {
          setClasses(prev => [...prev, { id, title: null, members: [] }]);
        }
        setClasses(prev => prev.map(c => {
          if (c.id !== id) return c;
          if (c.members.includes(username)) return c;
          return { ...c, members: [...c.members, username] };
        }));
        notify(`Joined Class #${id}`);
      }
        onJoinClass(code, user.username);
        setClassCode('');
      }

      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-6">
          <div>
            <h3 className="text-lg font-semibold">Welcome, {user.name}</h3>
            <p className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(balance)}</strong></p>
          </div>

          {/* Join Class (students) */}
          <div className="p-3 rounded border border-slate-200 dark:border-slate-700">
            <div className="flex flex-wrap items-center gap-2">
              <label className="text-sm">Join a class:</label>
              <input className="border p-2 rounded w-40 dark:bg-slate-900 dark:border-slate-700" placeholder="Class number" value={classCode} onChange={e=>setClassCode(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={joinClass}>Join</button>
              <span className="text-xs text-slate-500">(Admin can see class rosters. Students cannot.)</span>
            </div>
          </div>

          {/* Transactions */}
          <div className="space-y-2">
            <h4 className="font-medium">Transactions</h4>
            <div className="flex flex-wrap gap-2 items-center">
              <input type="number" step="0.01" placeholder="$ amount" className="border p-2 rounded w-36 dark:bg-slate-900 dark:border-slate-700" value={delta} onChange={e=>setDelta(e.target.value)} />
              <input type="text" placeholder="Memo (optional)" className="border p-2 rounded w-60 dark:bg-slate-900 dark:border-slate-700" value={memo} onChange={e=>setMemo(e.target.value)} />
              <button className="bg-emerald-600 text-white px-3 py-2 rounded" onClick={deposit}>Deposit</button>
              <button className="bg-amber-600 text-white px-3 py-2 rounded" onClick={withdraw}>Withdraw</button>
              <button className="bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 px-3 py-2 rounded" onClick={undoLast}>Undo last</button>
            </div>
            <ul className="divide-y dark:divide-slate-700 bg-slate-50 dark:bg-slate-900 rounded">
              {(user.transactions||[]).slice().reverse().map((t,i)=> (
                <li key={i} className="flex items-center justify-between p-2">
                  <span className="text-sm">{new Date(t.ts||now()).toLocaleString()} — {t.memo || '—'}</span>
                  <span className={"text-sm font-medium "+(t.amount>=0?'text-emerald-700':'text-rose-400')}>{t.amount>=0?'+':''}{Number(t.amount).toFixed(2)}</span>
                </li>
              ))}
              {(user.transactions||[]).length === 0 && <li className="p-2 text-sm text-slate-500">No transactions yet.</li>}
            </ul>
          </div>

          {/* Weekly deductions */}
          <div>
            <h4 className="font-medium mb-2">Weekly Deductions</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Name (e.g., Phone)" value={wdName} onChange={e=>setWdName(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Amount" value={wdAmt} onChange={e=>setWdAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={addWeekly}>Add & Apply</button>
              <button className="bg-slate-800 text-white px-3 py-2 rounded" onClick={applyWeeklyAll}>Run all weekly now</button>
            </div>
            <ul className="space-y-2">
              {(user.weeklyDeductions||[]).map((d,i)=> (
                <li key={i} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                  <span>{d.name} — <strong>{fmtUSD(d.amount)}</strong></span>
                  <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white" onClick={()=>removeWeekly(i)}>Remove</button>
                </li>
              ))}
              {(!user.weeklyDeductions || user.weeklyDeductions.length===0) && (
                <li className="text-sm text-slate-500">No weekly deductions yet.</li>
              )}
            </ul>
          </div>

          {/* Goals */}
          <div>
            <h4 className="font-medium mb-2">Goals</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Goal name (e.g., Bike)" value={goalName} onChange={e=>setGoalName(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Target $" value={goalTarget} onChange={e=>setGoalTarget(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={addGoal}>Add Goal</button>
            </div>
            <div className="space-y-3">
              {(user.goals||[]).map((g, idx) => (
                <GoalRow key={idx} g={g} onContribute={(amt)=>contributeGoal(idx, amt)} />
              ))}
              {(!user.goals || user.goals.length===0) && (
                <div className="text-sm text-slate-500">No goals yet. Add your first goal above.</div>
              )}
            </div>
          </div>

          {/* Budgets */}
          <div>
            <h4 className="font-medium mb-2">Budgets</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Category (e.g., Food)" value={cat} onChange={e=>setCat(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Amount $" value={bAmt} onChange={e=>setBAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={upsertBudget}>Add/Update</button>
            </div>
            <ul className="space-y-2">
              {Object.entries(user.budgets||{}).map(([k,v]) => (
                <li key={k} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                  <span className="font-medium">{k}</span>
                  <div className="flex items-center gap-3">
                    <span>{fmtUSD(v)}</span>
                    <button className="text-xs px-2 py-1 rounded bg-slate-300 dark:bg-slate-700" onClick={()=>deleteBudget(k)}>Delete</button>
                  </div>
                </li>
              ))}
              {Object.keys(user.budgets||{}).length===0 && (
                <li className="text-sm text-slate-500">No budgets yet.</li>
              )}
            </ul>
          </div>
        </section>
      );
    }

    // ------------------- App -------------------
    function App(){
      const [participants, setParticipants] = useState(loadParticipants);
      const [classes, setClasses] = useState(loadClasses);
      const [currentUsername, setCurrentUsername] = useState('');
      const [password, setPassword] = useState('');
      const [theme, setTheme] = useState(localStorage.getItem(THEME_KEY) || 'light');
      const [toast, setToast] = useState(null);
      const [isCreating, setIsCreating] = useState(false);
      const [newName, setNewName] = useState('');
      const [confirmPw, setConfirmPw] = useState('');

      useEffect(()=>{ saveParticipants(participants); }, [participants]);
      useEffect(()=>{ saveClasses(classes); }, [classes]);
      useEffect(()=>{
        document.documentElement.classList.toggle('dark', theme==='dark');
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);

      // Ensure admin has a password
      useEffect(() => {
        (async () => {
          const admin = participants.find(u => u.username === ADMIN_USERNAME);
          if (admin && !admin.passwordHash) {
            const salt = randomSalt();
            const hash = await sha256(salt + ADMIN_DEFAULT_PASSWORD);
            setParticipants(prev => prev.map(u => u.username===ADMIN_USERNAME ? {...u, salt, passwordHash: hash} : u));
          }
        })();
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, []);

      const currentUser = useMemo(()=> participants.find(p => p.username.toLowerCase() === currentUsername.toLowerCase()) || null, [participants, currentUsername]);
      const isAdmin = currentUser && currentUser.username === ADMIN_USERNAME;

      function notify(msg){ setToast(msg); }

      // --- Auth ---
      async function login(username, pw){
        const u = (username||'').trim().toLowerCase();
        if (!u) return notify('Enter your username');
        const user = participants.find(x => x.username.toLowerCase() === u);
        if (!user) return notify('User not found. Create an account first.');
        if (!user.passwordHash || !user.salt) return notify('This account has no password set yet.');
        const hash = await sha256(user.salt + String(pw||''));
        if (hash !== user.passwordHash) return notify('Incorrect password');
        setCurrentUsername(user.username);
        setPassword('');
        notify('Logged in as '+user.name);
      }

      async function createAccount(username, name, pw, pw2){
        const u = (username||'').trim().toLowerCase();
        const display = (name||'').trim();
        if (!u || !display) return notify('Enter a username and display name');
        if (!pw) return notify('Enter a password');
        if (pw !== pw2) return notify('Passwords do not match');
        if (/[^a-z0-9_.-]/i.test(u)) return notify('Username may contain letters, numbers, _ . -');
        if (participants.some(p => p.username.toLowerCase() === u)) return notify('Username already taken');

        const salt = randomSalt();
        const passwordHash = await sha256(salt + pw);
        const user = {
          id: Date.now(),
          username: u,
          name: display,
          salt,
          passwordHash,
          subscriptionActive: false,
          weeklyDeductions: [],
          goals: [],
          budgets: {},
          transactions: [],
        };
        setParticipants(prev => [...prev, user]);
        // Do NOT auto-login; keep them on login screen
        setPassword('');
        setConfirmPw('');
        setNewName('');
        setIsCreating(false);
        notify('Account created. Please log in.');
      }

      function logout(){ setCurrentUsername(''); setPassword(''); }

      // --- Admin ops ---
      function adminAdjust(userId, delta, memo){
        setParticipants(prev => prev.map(u => {
          if (u.id !== userId) return u;
          return {...u, transactions: [...(u.transactions||[]), { amount: Number(delta), memo: memo||null, ts: now() }] };
        }));
      }
      function adminSub(userId){ setParticipants(prev => prev.map(u => u.id===userId? {...u, subscriptionActive:true}:u)); }
      function adminCancel(userId){ setParticipants(prev => prev.map(u => u.id===userId? {...u, subscriptionActive:false}:u)); }
      function adminDelete(userId){
        if(!confirm('Delete participant?')) return;
        const deleted = participants.find(u=>u.id===userId);
        setParticipants(prev => prev.filter(u => u.id!==userId));
        if(currentUser?.id===userId) logout();
        if (deleted) {
          // remove from all classes
          setClasses(prev => prev.map(c => ({...c, members: c.members.filter(m => m !== deleted.username)})));
        }
      }

      // --- Classes ops ---
      function ensureClassExists(classId){
        const id = String(classId);
        if (!classes.find(c => c.id === id)) {
          setClasses(prev => [...prev, { id, title: null, members: [] }]);
        }
      }

      function joinClass(classId, username){
        const id = String(classId);
        ensureClassExists(id);
        setClasses(prev => prev.map(c => {
          if (c.id !== id) return c;
          if (c.members.includes(username)) return c;
          return { ...c, members: [...c.members, username] };
        }));
        notify(`Joined Class #${id}`);
      }

      function renameClass(classId, newTitle){
        const id = String(classId);
        setClasses(prev => prev.map(c => c.id===id ? { ...c, title: newTitle || null } : c));
        notify('Class renamed');
      }

      function removeFromClass(classId, username){
        const id = String(classId);
        setClasses(prev => prev.map(c => c.id===id ? { ...c, members: c.members.filter(m => m !== username) } : c));
      }

      function updateMe(mut){
        setParticipants(prev => prev.map(u => u.username===currentUser.username ? (typeof mut==='function'? mut(u):{...u, ...mut}) : u));
      }
      function applyMyWeeklyNow(){
        const me = currentUser; if(!me) return;
        setParticipants(prev => prev.map(u => {
          if (u.username !== me.username) return u;
          const txs = [...(u.transactions||[])];
          (u.weeklyDeductions||[]).forEach(d => txs.push({ amount: -Number(d.amount), memo: `Weekly: ${d.name}`, ts: now() }));
          return {...u, transactions: txs};
        }));
        notify('Applied weekly deductions');
      }

      // ---------- Screens ----------
      if (!currentUser){
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-6">
            <div className="bg-white dark:bg-slate-800 max-w-md w-full rounded-2xl shadow p-6">
              <div className="flex items-center justify-between mb-3">
                <h1 className="text-2xl font-bold">Student Banking {isCreating ? 'Create Account' : 'Login'}</h1>
                <button className="text-xs px-2 py-1 rounded border dark:border-slate-700" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'Light':'Dark'}</button>
              </div>

              {!isCreating ? (
                <>
                  <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Log in with your <strong>username</strong> and <strong>password</strong>. (Demo only; data stays in your browser.)</p>
                  <label className="text-sm block mb-1">Username</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="yourname" value={currentUsername} onChange={e=>setCurrentUsername(e.target.value)} />
                  <label className="text-sm block mb-1">Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-4 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />
                  <button className="w-full bg-indigo-600 text-white py-2 rounded mb-3" onClick={()=>login(currentUsername, password)}>Login</button>
                  <button className="w-full bg-slate-200 dark:bg-slate-700 py-2 rounded" onClick={()=>setIsCreating(true)}>Create an account</button>

                  <div className="mt-6 flex items-center justify-between text-xs text-slate-500">
                    <button className="underline" onClick={()=>{ localStorage.removeItem(DB_KEY); localStorage.removeItem(CLASSES_KEY); location.reload(); }}>Reset demo</button>
                    <div className="flex items-center gap-2">
                      <button className="underline" onClick={()=>{
                        const blob = new Blob([JSON.stringify({participants, classes},null,2)], { type:'application/json' });
                        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='teenbank_backup.json'; a.click(); URL.revokeObjectURL(url);
                      }}>Export</button>
                      <label className="underline cursor-pointer">
                        Import
                        <input type="file" accept="application/json" className="hidden" onChange={async e=>{
                          const file=e.target.files[0]; if(!file) return; const text=await file.text();
                          try{ const json = JSON.parse(text); if(json.participants) setParticipants(migrateIfNeeded(JSON.stringify(json.participants))); if(json.classes) setClasses(json.classes); }catch(err){ alert('Import failed: '+err.message);} }} />
                      </label>
                    </div>
                  </div>
                  <p className="mt-3 text-xs text-slate-500">Tip: Admin login: <span className="font-mono">@{ADMIN_USERNAME}</span> / <span className="font-mono">{ADMIN_DEFAULT_PASSWORD}</span></p>
                </>
              ) : (
                <>
                  <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Create a new account. Pick a unique username.</p>
                  <label className="text-sm block mb-1">Username</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="yourname" value={currentUsername} onChange={e=>setCurrentUsername(e.target.value)} />
                  <label className="text-sm block mb-1">Display Name</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="e.g., Ava" value={newName} onChange={e=>setNewName(e.target.value)} />
                  <label className="text-sm block mb-1">Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />
                  <label className="text-sm block mb-1">Confirm Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-4 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={confirmPw} onChange={e=>setConfirmPw(e.target.value)} />
                  <button className="w-full bg-emerald-600 text-white py-2 rounded mb-3" onClick={()=>createAccount(currentUsername, newName, password, confirmPw)}>Create Account</button>
                  <button className="w-full bg-slate-200 dark:bg-slate-700 py-2 rounded" onClick={()=>setIsCreating(false)}>Back to login</button>
                </>
              )}
            </div>
          </div>
        );
      }

      // Dashboard
      return (
        <div className="min-h-screen p-6">
          <header className="max-w-5xl mx-auto mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold">Student Banking Dashboard</h1>
              <div className="text-sm text-slate-600 dark:text-slate-300">Logged in as <strong>{currentUser.name}</strong> @{currentUser.username} {isAdmin && <span className="ml-1">(Admin)</span>}</div>
            </div>
            <div className="flex items-center gap-2">
              <button className="px-3 py-2 text-sm rounded border dark:border-slate-700" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'Light':'Dark'}</button>
              <button className="px-3 py-2 text-sm rounded bg-slate-200 dark:bg-slate-700" onClick={()=>{
                const blob = new Blob([JSON.stringify({participants, classes},null,2)], { type:'application/json' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='teenbank_backup.json'; a.click(); URL.revokeObjectURL(url);
              }}>Export</button>
              <label className="px-3 py-2 text-sm rounded bg-slate-200 dark:bg-slate-700 cursor-pointer">Import<input type="file" accept="application/json" className="hidden" onChange={async e=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text(); try{ const json = JSON.parse(text); if(json.participants) setParticipants(migrateIfNeeded(JSON.stringify(json.participants))); if(json.classes) setClasses(json.classes);}catch(err){ alert('Import failed: '+err.message);} }} /></label>
              <button className="px-3 py-2 text-sm rounded bg-slate-800 text-white" onClick={()=>{ setCurrentUsername(''); setPassword(''); }}>Logout</button>
            </div>
          </header>

          <main className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            {isAdmin ? (
              <AdminPanel
                participants={participants}
                classes={classes}
                onAdjust={adminAdjust}
                onSubscribe={adminSub}
                onCancel={adminCancel}
                onDelete={adminDelete}
                onRenameClass={renameClass}
                onRemoveFromClass={removeFromClass}
              />
            ) : (
              <UserPanel
                user={currentUser}
                updateUser={(mut)=> setParticipants(prev => prev.map(u => u.username===currentUser.username ? (typeof mut==='function'? mut(u):{...u, ...mut}) : u)) }
                applyWeeklyAll={applyMyWeeklyNow}
                onJoinClass={joinClass}
              />
            )}

            {/* Side panel */}
            {isAdmin && (
            <aside className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-4">
              <h3 className="text-lg font-semibold">Unassigned Participants</h3>
              <ul className="space-y-2 max-h-[420px] overflow-auto pr-1">
                {participants.filter(p => !classes.some(c => c.members.includes(p.username))).map(p => (
                  <li key={p.id} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                    <div>
                      <div className="font-medium text-sm">{p.name}</div>
                      <div className="text-xs text-slate-500">@{p.username}</div>
                    </div>
                    <div className="text-xs">{fmtUSD(computeBalance(p))}</div>
                  </li>
                ))}
              </ul>
            </aside>
          )}
          </main>

          <footer className="max-w-5xl mx-auto mt-8 text-sm text-slate-500">
            Demo only. Real authentication and multi-user storage require a backend/API. Passwords are hashed client-side for demonstration.
          </footer>

          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
