<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Bank</title>
  <meta name="description" content="A simple subscription-based budgeting simulator for students learning banking basics." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Playfair+Display:wght@600&display=swap"
    rel="stylesheet"
  />
  <script>
    window.tailwind = {
      config: {
        theme: {
          extend: {
            colors: {
              lagoon: {
                50: '#f0fbff',
                100: '#dff3fb',
                200: '#bbe3f4',
                300: '#8bcee9',
                400: '#54b2d9',
                500: '#319ac6',
                600: '#217aa5',
                700: '#1f6488',
              },
              coral: {
                50: '#fff4eb',
                100: '#ffe5d1',
                200: '#ffceaa',
                300: '#ffa877',
                400: '#ff7c40',
                500: '#f2632b',
              },
              sand: {
                50: '#f7f4ef',
                100: '#ebe3d5',
                200: '#d5c3a5',
                300: '#c0a677',
              },
            },
            fontFamily: {
              display: ['\"Playfair Display\"', 'serif'],
              sans: ['\"Manrope\"', 'system-ui', 'sans-serif'],
            },
            boxShadow: {
              aurora: '0 20px 45px -20px rgba(15, 23, 42, 0.35)',
            },
            borderRadius: {
              xl2: '1.5rem',
            },
          },
        },
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full bg-gradient-to-br from-sand-50 via-white to-lagoon-50 text-slate-900 antialiased">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const ADMIN_EMAIL = 'hasslerw748@stu.mw.k12.ny.us';
    const DB_KEY = 'student_bank_v1';
    const CURRENT_USER_KEY = 'student_bank_current_user';
    const DEFAULT_SUBSCRIPTION_AMOUNT = 5;
    const WEEK_MS = 1000 * 60 * 60 * 24 * 7;

    function now() {
      return Date.now();
    }

    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function fmtUSD(value) {
      return (Number(value) || 0).toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
      });
    }

    function safeAmount(value) {
      const num = Number(value);
      if (!isFinite(num)) return 0;
      return Math.round(num * 100) / 100;
    }

    function totalRecurring(list = []) {
      return list.reduce((sum, item) => sum + safeAmount(item.amount), 0);
    }

    function createTransaction({ amount, memo, type }) {
      return {
        id: uid(),
        amount: safeAmount(amount),
        memo: memo || '',
        type: type || 'general',
        ts: now(),
      };
    }

    function computeBalance(user) {
      return (user.transactions || []).reduce((sum, tx) => sum + safeAmount(tx.amount), 0);
    }

    function lastSubscriptionDate(user) {
      const history = (user.transactions || []).filter((tx) => tx.type === 'subscription');
      if (history.length === 0) return null;
      const latest = history.reduce((acc, tx) => (tx.ts > acc.ts ? tx : acc), history[0]);
      return latest.ts;
    }

    function normalizeRecurringList(list = []) {
      if (!Array.isArray(list)) return [];
      return list.map((item) => ({
        id: item.id || uid(),
        label: item.label || item.name || 'Weekly item',
        amount: safeAmount(item.amount),
      })).filter((item) => item.amount !== 0 && item.label);
    }

    function normalizeTransactions(list = []) {
      if (!Array.isArray(list)) return [];
      return list.map((tx) => ({
        id: tx.id || uid(),
        amount: safeAmount(tx.amount),
        memo: tx.memo || '',
        type: tx.type || 'general',
        ts: typeof tx.ts === 'number' ? tx.ts : now(),
      })).filter((tx) => tx.amount !== 0 || tx.memo);
    }

    function normalizeUser(user) {
      return {
        id: user.id || uid(),
        name: user.name || '',
        email: (user.email || '').trim(),
        password: user.password || '',
        classNumber: typeof user.classNumber === 'string' ? user.classNumber.trim() : '',
        createdAt: user.createdAt || now(),
        transactions: normalizeTransactions(user.transactions || []),
        weeklyIncome: normalizeRecurringList(user.weeklyIncome || []),
        weeklyExpenses: normalizeRecurringList(user.weeklyExpenses || user.weeklyDeductions || []),
        subscriptionActive:
          typeof user.subscriptionActive === 'boolean' ? user.subscriptionActive : true,
        subscriptionAmount: typeof user.subscriptionAmount === 'number' && isFinite(user.subscriptionAmount)
          ? safeAmount(user.subscriptionAmount)
          : DEFAULT_SUBSCRIPTION_AMOUNT,
        lastWeeklyRun: user.lastWeeklyRun || null,
        lastSubscriptionPayment: user.lastSubscriptionPayment || lastSubscriptionDate(user) || null,
        notes: user.notes || '',
      };
    }

    function loadUsers() {
      try {
        const raw = localStorage.getItem(DB_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(normalizeUser);
      } catch (error) {
        console.warn('Failed to load users:', error);
        return [];
      }
    }

    function saveUsers(users) {
      localStorage.setItem(DB_KEY, JSON.stringify(users));
    }
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function Toast({ message, onDismiss }) {
      useEffect(() => {
        if (!message) return;
        const id = setTimeout(() => onDismiss && onDismiss(), 2400);
        return () => clearTimeout(id);
      }, [message, onDismiss]);

      if (!message) return null;
      return (
        <div className="fixed bottom-5 left-1/2 -translate-x-1/2 rounded-full bg-lagoon-600 px-6 py-2 text-sm font-semibold text-white shadow-lg ring-2 ring-lagoon-200/70">
          {message}
        </div>
      );
    }

    function Header({ onLogout, isAdmin, userName }) {
      return (
        <header className="relative overflow-hidden rounded-xl2 border border-lagoon-100 bg-white/80 p-6 shadow-aurora backdrop-blur">
          <div className="absolute inset-y-0 right-0 hidden w-1/3 bg-gradient-to-l from-lagoon-100/80 to-transparent sm:block" aria-hidden="true"></div>
          <div className="relative z-10 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <div className="flex items-center gap-3">
                <span className="flex h-12 w-12 items-center justify-center rounded-2xl bg-lagoon-500 text-lg font-semibold text-white shadow-md">SB</span>
                <div>
                  <p className="text-xs uppercase tracking-[0.3em] text-lagoon-600">Student Finance Studio</p>
                  <h1 className="font-display text-3xl text-slate-900">Student Bank</h1>
                </div>
              </div>
              <p className="mt-2 max-w-xl text-sm text-slate-600">
                Practice real-world money habits, track recurring plans, and stay on top of subscriptions in one calm workspace.
              </p>
            </div>
            <div className="flex flex-col items-start gap-3 sm:items-end">
              {userName && (
                <div className="rounded-full border border-lagoon-100 bg-white/70 px-4 py-2 text-xs font-medium text-slate-600 shadow">
                  <span className="text-slate-500">Signed in as</span>
                  <span className="ml-2 text-sm font-semibold text-slate-900">{userName}</span>
                  {isAdmin && <span className="ml-2 rounded-full bg-coral-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-coral-500">Admin</span>}
                </div>
              )}
              {onLogout && (
                <button
                  className="inline-flex items-center justify-center rounded-full bg-lagoon-600 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-lagoon-700"
                  onClick={onLogout}
                >
                  Log out
                </button>
              )}
            </div>
          </div>
        </header>
      );
    }

    function LoginCard({ onAuthenticate }) {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [classNumber, setClassNumber] = useState('');

      function handleSubmit(event) {
        event.preventDefault();
        onAuthenticate({ email, name, password, classNumber });
      }

      return (
        <section className="relative mx-auto max-w-5xl overflow-hidden rounded-xl2 border border-white/60 bg-white/90 shadow-aurora backdrop-blur">
          <div className="absolute -top-32 -left-16 h-72 w-72 rounded-full bg-lagoon-100 blur-3xl" aria-hidden="true"></div>
          <div className="absolute -bottom-32 -right-16 h-72 w-72 rounded-full bg-coral-100 blur-3xl" aria-hidden="true"></div>
          <div className="relative grid gap-0 md:grid-cols-[1.2fr_1fr]">
            <div className="hidden flex-col justify-between border-r border-sand-100 bg-gradient-to-br from-lagoon-50 via-white to-coral-50 p-10 md:flex">
              <div className="space-y-6">
                <span className="inline-flex items-center rounded-full bg-white/70 px-4 py-1 text-xs font-semibold uppercase tracking-wide text-lagoon-600 shadow">Start your practice bank</span>
                <h2 className="font-display text-3xl text-slate-900">Build confident money habits</h2>
                <p className="text-sm leading-relaxed text-slate-600">
                  Student Bank mirrors the essentials of a real account so you can experiment safely. Track balances, recurring plans, and subscriptions while keeping everything private to your device.
                </p>
              </div>
              <dl className="grid grid-cols-2 gap-4 text-sm text-slate-600">
                <div className="rounded-2xl border border-white/60 bg-white/80 px-4 py-3 shadow-sm">
                  <dt className="text-xs uppercase tracking-wide text-lagoon-600">Stay organized</dt>
                  <dd className="mt-1 font-semibold text-slate-900">Deposits & spending history</dd>
                </div>
                <div className="rounded-2xl border border-white/60 bg-white/80 px-4 py-3 shadow-sm">
                  <dt className="text-xs uppercase tracking-wide text-lagoon-600">Automate</dt>
                  <dd className="mt-1 font-semibold text-slate-900">Weekly income & expenses</dd>
                </div>
              </dl>
            </div>
            <div className="p-8 sm:p-10">
              <div className="space-y-2 text-slate-700">
                <p className="text-xs uppercase tracking-[0.3em] text-lagoon-600">Secure sign in</p>
                <h2 className="text-2xl font-semibold text-slate-900">Welcome back</h2>
                <p className="text-sm text-slate-500">Use your school email to sign in. First time here? Enter your name to create an account instantly.</p>
              </div>
              <form className="mt-6 space-y-5" onSubmit={handleSubmit}>
                <div className="space-y-2">
                  <label className="text-sm font-semibold text-slate-700" htmlFor="login-email">Email</label>
                  <input
                    id="login-email"
                    type="email"
                    required
                    className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm transition focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                    value={email}
                    onChange={(event) => setEmail(event.target.value)}
                    placeholder="you@school.edu"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-semibold text-slate-700" htmlFor="login-name">Name</label>
                  <input
                    id="login-name"
                    type="text"
                    className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm transition focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                    value={name}
                    onChange={(event) => setName(event.target.value)}
                    placeholder="Needed the first time you sign in"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-semibold text-slate-700" htmlFor="login-password">Password</label>
                  <input
                    id="login-password"
                    type="password"
                    required
                    minLength={4}
                    className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm transition focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                    value={password}
                    onChange={(event) => setPassword(event.target.value)}
                    placeholder="At least 4 characters"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-semibold text-slate-700" htmlFor="login-class">Class number</label>
                  <input
                    id="login-class"
                    type="text"
                    className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm transition focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                    value={classNumber}
                    onChange={(event) => setClassNumber(event.target.value)}
                    placeholder="Optional — helps your teacher organize rosters"
                  />
                </div>
                <button
                  type="submit"
                  className="w-full rounded-full bg-lagoon-600 px-5 py-3 text-sm font-semibold text-white shadow-lg transition hover:bg-lagoon-700 focus:outline-none focus:ring-2 focus:ring-lagoon-300 focus:ring-offset-2"
                >
                  Sign in or create an account
                </button>
              </form>
            </div>
          </div>
        </section>
      );
    }

    function RecurringList({ title, emptyHint, items, onRemove, disabled = false }) {
      return (
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <h4 className="text-sm font-semibold text-slate-800">{title}</h4>
            {items.length > 0 && (
              <span className="rounded-full bg-lagoon-50 px-3 py-1 text-[11px] font-semibold text-lagoon-700">
                {items.length} item{items.length === 1 ? '' : 's'}
              </span>
            )}
          </div>
          {items.length === 0 ? (
            <p className="text-sm text-slate-500">{emptyHint}</p>
          ) : (
            <ul className="space-y-2">
              {items.map((item) => (
                <li
                  key={item.id}
                  className="flex items-center justify-between gap-4 rounded-2xl border border-lagoon-100 bg-white/80 px-4 py-3 shadow-sm"
                >
                  <div>
                    <div className="text-sm font-semibold text-slate-900">{item.label}</div>
                    <div className="text-xs text-slate-500">{fmtUSD(item.amount)} every week</div>
                  </div>
                  {onRemove && !disabled && (
                    <button
                      className="text-xs font-semibold text-coral-500 transition hover:text-coral-600"
                      onClick={() => onRemove(item.id)}
                    >
                      Remove
                    </button>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    }

    function TransactionHistory({ transactions }) {
      if (!transactions.length) {
        return (
          <p className="text-sm text-slate-500">
            No activity yet. Every deposit, withdrawal, and subscription payment will appear here.
          </p>
        );
      }

      const sorted = [...transactions].sort((a, b) => (b.ts || 0) - (a.ts || 0));

      return (
        <div className="overflow-hidden rounded-2xl border border-lagoon-100 bg-white/80 shadow-sm">
          <table className="min-w-full divide-y divide-slate-100 text-sm text-left text-slate-700">
            <thead className="bg-lagoon-50/80 text-slate-800">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">When</th>
                <th className="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide">Details</th>
                <th className="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide">Amount</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {sorted.map((tx) => (
                <tr key={tx.id} className="transition hover:bg-lagoon-50/40">
                  <td className="whitespace-nowrap px-4 py-3 text-slate-500">
                    {new Date(tx.ts || now()).toLocaleString()}
                  </td>
                  <td className="px-4 py-3 text-slate-900">
                    <div className="font-semibold capitalize text-slate-900">{tx.type.replace('-', ' ')}</div>
                    <div className="text-xs text-slate-500">{tx.memo || '—'}</div>
                  </td>
                  <td className={`px-4 py-3 text-right font-semibold ${tx.amount >= 0 ? 'text-lagoon-600' : 'text-coral-500'}`}>
                    {tx.amount >= 0 ? '+' : ''}
                    {fmtUSD(tx.amount)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function StudentDashboard({ user, onUpdate, onNotify }) {
      const [amount, setAmount] = useState('');
      const [memo, setMemo] = useState('');
      const [incomeLabel, setIncomeLabel] = useState('');
      const [incomeAmount, setIncomeAmount] = useState('');
      const [expenseLabel, setExpenseLabel] = useState('');
      const [expenseAmount, setExpenseAmount] = useState('');
      const [notes, setNotes] = useState(user.notes || '');

      useEffect(() => {
        setNotes(user.notes || '');
      }, [user.notes]);

      const balance = useMemo(() => computeBalance(user), [user.transactions]);
      const totalIncome = useMemo(() => totalRecurring(user.weeklyIncome), [user.weeklyIncome]);
      const totalExpenses = useMemo(() => totalRecurring(user.weeklyExpenses), [user.weeklyExpenses]);
      const weeklySubscription = user.subscriptionActive ? safeAmount(user.subscriptionAmount) : 0;
      const isFrozen = !user.subscriptionActive;
      const lastPaymentTimestamp = user.lastSubscriptionPayment || null;
      const canPaySubscription =
        user.subscriptionActive && (!lastPaymentTimestamp || now() - lastPaymentTimestamp >= WEEK_MS);
      const nextEligiblePayment = lastPaymentTimestamp ? lastPaymentTimestamp + WEEK_MS : null;
      const cannotPayNow = !canPaySubscription;

      function assertActive() {
        if (!isFrozen) return true;
        onNotify('Your subscription is paused, so your account is frozen until the admin reactivates it.');
        return false;
      }

      function addTransaction(change, type, defaultMemo) {
        const delta = safeAmount(change);
        if (delta === 0) return;
        onUpdate((current) => ({
          ...current,
          transactions: [...(current.transactions || []), createTransaction({ amount: delta, memo: memo || defaultMemo, type })],
        }));
        setAmount('');
        setMemo('');
      }

      function withdrawTransaction(change, type, defaultMemo) {
        const delta = safeAmount(change);
        if (delta === 0) return;
        onUpdate((current) => ({
          ...current,
          transactions: [...(current.transactions || []), createTransaction({ amount: -Math.abs(delta), memo: memo || defaultMemo, type })],
        }));
        setAmount('');
        setMemo('');
      }

      function handleDeposit() {
        if (!assertActive()) return;
        const delta = safeAmount(amount);
        if (delta <= 0) return onNotify('Enter an amount greater than $0.00');
        addTransaction(delta, 'deposit', 'Deposit');
        onNotify('Deposit added');
      }

      function handleWithdraw() {
        if (!assertActive()) return;
        const delta = safeAmount(amount);
        if (delta <= 0) return onNotify('Enter an amount greater than $0.00');
        if (delta > balance) {
          onNotify('This would put you below $0. Adjust the amount or deposit first.');
          return;
        }
        withdrawTransaction(delta, 'withdrawal', 'Spending');
        onNotify('Withdrawal recorded');
      }

      function addRecurring(kind) {
        if (!assertActive()) return;
        const label = kind === 'income' ? incomeLabel.trim() : expenseLabel.trim();
        const rawAmount = kind === 'income' ? incomeAmount : expenseAmount;
        const parsed = safeAmount(rawAmount);
        if (!label) return onNotify('Give the recurring item a name.');
        if (parsed <= 0) return onNotify('Enter an amount greater than $0.00');

        onUpdate((current) => {
          const key = kind === 'income' ? 'weeklyIncome' : 'weeklyExpenses';
          const nextList = [...(current[key] || []), { id: uid(), label, amount: parsed }];
          return { ...current, [key]: nextList };
        });

        if (kind === 'income') {
          setIncomeLabel('');
          setIncomeAmount('');
        } else {
          setExpenseLabel('');
          setExpenseAmount('');
        }
        onNotify('Saved to weekly plan');
      }

      function removeRecurring(kind, id) {
        if (!assertActive()) return;
        onUpdate((current) => {
          const key = kind === 'income' ? 'weeklyIncome' : 'weeklyExpenses';
          return {
            ...current,
            [key]: (current[key] || []).filter((item) => item.id !== id),
          };
        });
      }

      function applyWeeklyPlan() {
        if (!assertActive()) return;
        const incomes = user.weeklyIncome || [];
        const expenses = user.weeklyExpenses || [];
        const chargeSubscription = user.subscriptionActive && safeAmount(user.subscriptionAmount) > 0;
        if (!incomes.length && !expenses.length && !chargeSubscription) {
          return onNotify('Add weekly income, weekly expenses, or enable your subscription before running the update.');
        }
        const runTimestamp = now();
        onUpdate((current) => {
          const transactions = [...(current.transactions || [])];
          incomes.forEach((item) => {
            transactions.push(
              createTransaction({
                amount: safeAmount(item.amount),
                memo: `Weekly income · ${item.label}`,
                type: 'weekly-income',
              })
            );
          });
          expenses.forEach((item) => {
            transactions.push(
              createTransaction({
                amount: -Math.abs(safeAmount(item.amount)),
                memo: `Weekly expense · ${item.label}`,
                type: 'weekly-expense',
              })
            );
          });
          let lastSubscriptionPayment = current.lastSubscriptionPayment || null;
          if (chargeSubscription) {
            const subscriptionAmount = safeAmount(current.subscriptionAmount);
            const alreadyPaid =
              lastSubscriptionPayment && runTimestamp - lastSubscriptionPayment < WEEK_MS;
            if (!alreadyPaid) {
              transactions.push(
                createTransaction({
                  amount: -Math.abs(subscriptionAmount),
                  memo: 'Weekly subscription fee',
                  type: 'subscription',
                })
              );
              lastSubscriptionPayment = runTimestamp;
            }
          }
          return {
            ...current,
            transactions,
            lastWeeklyRun: runTimestamp,
            lastSubscriptionPayment,
          };
        });
        onNotify('Weekly plan applied to your balance');
      }

      function paySubscriptionNow() {
        if (!assertActive()) return;
        const timestamp = now();
        const amount = safeAmount(user.subscriptionAmount);
        if (amount <= 0) {
          return onNotify('Your subscription amount is not set. Ask the admin for help.');
        }
        if (user.lastSubscriptionPayment && timestamp - user.lastSubscriptionPayment < WEEK_MS) {
          return onNotify('You already paid within the last 7 days. Try again later.');
        }
        onUpdate((current) => ({
          ...current,
          transactions: [
            ...(current.transactions || []),
            createTransaction({ amount: -Math.abs(amount), memo: 'Subscription payment', type: 'subscription' }),
          ],
          lastSubscriptionPayment: timestamp,
        }));
        onNotify('Subscription payment recorded');
      }

      function handleNotesBlur() {
        if (!assertActive()) {
          setNotes(user.notes || '');
          return;
        }

        const nextNotes = notes || '';
        if ((user.notes || '') === nextNotes) {
          return;
        }
        onUpdate((current) => {
          return {
            ...current,
            notes: nextNotes,
          };
        });
      }

      return (
        <div className="pt-10 sm:pt-12">
          <div className="grid gap-8 xl:grid-cols-[1.65fr_1fr]">
            <section className="space-y-8">
              <div className="space-y-6 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
                <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                  <div>
                    <p className="text-sm uppercase tracking-[0.2em] text-lagoon-600">Balance</p>
                    <h2 className="mt-1 text-3xl font-semibold text-slate-900">{fmtUSD(balance)}</h2>
                    <p className="mt-2 text-sm text-slate-500">Welcome {user.name || 'back'}! Every change saves instantly on this device.</p>
                  </div>
                  <div className="rounded-2xl border border-lagoon-100 bg-lagoon-50/70 px-4 py-3 text-sm text-lagoon-700">
                    <p className="font-semibold">Weekly outlook</p>
                    <p className="text-xs text-slate-500">
                      Income {fmtUSD(totalIncome)} · Expenses {fmtUSD(totalExpenses)} · Subscription {fmtUSD(weeklySubscription)}
                    </p>
                  </div>
                </div>
                {isFrozen && (
                  <div className="rounded-2xl border border-coral-200 bg-coral-50 px-4 py-3 text-xs text-coral-600">
                    Your subscription is paused. Everything is read-only until an admin reactivates it.
                  </div>
                )}
                <div className="grid gap-4 md:grid-cols-2">
                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-700" htmlFor="amount-input">Amount</label>
                    <input
                      id="amount-input"
                      type="number"
                      min="0"
                      step="0.01"
                      value={amount}
                      onChange={(event) => setAmount(event.target.value)}
                      className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="0.00"
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm font-semibold text-slate-700" htmlFor="memo-input">Memo</label>
                    <input
                      id="memo-input"
                      type="text"
                      value={memo}
                      onChange={(event) => setMemo(event.target.value)}
                      className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="What is this for?"
                    />
                  </div>
                </div>
                <div className="flex flex-wrap gap-3">
                  <button
                    className="inline-flex items-center justify-center rounded-full bg-lagoon-600 px-5 py-2.5 text-sm font-semibold text-white shadow transition hover:bg-lagoon-700 disabled:cursor-not-allowed disabled:opacity-60"
                    onClick={handleDeposit}
                    disabled={isFrozen}
                  >
                    Add money
                  </button>
                  <button
                    className="inline-flex items-center justify-center rounded-full border border-lagoon-200 bg-white px-5 py-2.5 text-sm font-semibold text-slate-700 transition hover:border-lagoon-300 disabled:cursor-not-allowed disabled:opacity-60"
                    onClick={handleWithdraw}
                    disabled={isFrozen}
                  >
                    Spend money
                  </button>
                </div>
              </div>

              <div className="space-y-6 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
                <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                  <div>
                    <h3 className="text-xl font-semibold text-slate-900">Weekly plan</h3>
                    <p className="text-sm text-slate-500">Track repeating income and expenses, then post them all at once.</p>
                  </div>
                  <button
                    className="inline-flex items-center justify-center rounded-full bg-lagoon-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-lagoon-700 disabled:cursor-not-allowed disabled:opacity-60"
                    onClick={runWeeklyPlan}
                    disabled={isFrozen}
                  >
                    Apply this week's plan
                  </button>
                </div>
                <div className="grid gap-6 md:grid-cols-2">
                  <div className="space-y-4">
                    <div className="space-y-2">
                      <label className="text-sm font-semibold text-slate-700" htmlFor="income-label">Add weekly income</label>
                      <input
                        id="income-label"
                        type="text"
                        value={incomeLabel}
                        onChange={(event) => setIncomeLabel(event.target.value)}
                        className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={isFrozen}
                        placeholder="Example: Allowance"
                      />
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        value={incomeAmount}
                        onChange={(event) => setIncomeAmount(event.target.value)}
                        className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={isFrozen}
                        placeholder="Amount"
                      />
                    </div>
                    <button
                      className="w-full rounded-full bg-lagoon-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-lagoon-700 disabled:cursor-not-allowed disabled:opacity-60"
                      onClick={addWeeklyIncome}
                      disabled={isFrozen}
                    >
                      Add income
                    </button>
                    <RecurringList
                      title="Weekly income"
                      emptyHint="No repeating income yet. Add your allowance, job, or other regular earnings."
                      items={user.weeklyIncome}
                      onRemove={isFrozen ? null : removeWeeklyIncome}
                      disabled={isFrozen}
                    />
                  </div>
                  <div className="space-y-4">
                    <div className="space-y-2">
                      <label className="text-sm font-semibold text-slate-700" htmlFor="expense-label">Add weekly expense</label>
                      <input
                        id="expense-label"
                        type="text"
                        value={expenseLabel}
                        onChange={(event) => setExpenseLabel(event.target.value)}
                        className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={isFrozen}
                        placeholder="Example: Snacks"
                      />
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        value={expenseAmount}
                        onChange={(event) => setExpenseAmount(event.target.value)}
                        className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={isFrozen}
                        placeholder="Amount"
                      />
                    </div>
                    <button
                      className="w-full rounded-full border border-lagoon-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-lagoon-300 disabled:cursor-not-allowed disabled:opacity-60"
                      onClick={addWeeklyExpense}
                      disabled={isFrozen}
                    >
                      Add expense
                    </button>
                    <RecurringList
                      title="Weekly expenses"
                      emptyHint="No repeating expenses yet. Add snacks, clubs, or anything you pay for regularly."
                      items={user.weeklyExpenses}
                      onRemove={isFrozen ? null : removeWeeklyExpense}
                      disabled={isFrozen}
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-4 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-semibold text-slate-900">Recent activity</h3>
                  <span className="text-xs uppercase tracking-wide text-slate-400">Updated automatically</span>
                </div>
                <TransactionHistory transactions={user.transactions} />
              </div>
            </section>

            <aside className="space-y-6">
              <div className="space-y-5 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
                <div className="space-y-2">
                  <h3 className="text-xl font-semibold text-slate-900">Subscription</h3>
                  <p className="text-sm text-slate-500">Payments are limited to once every seven days.</p>
                  {!user.subscriptionActive && (
                    <p className="rounded-2xl border border-coral-200 bg-coral-50 px-4 py-3 text-xs text-coral-600">
                      Your subscription is paused. Reach out to the admin to reactivate it.
                    </p>
                  )}
                </div>
                <dl className="space-y-3 text-sm text-slate-600">
                  <div className="flex items-center justify-between">
                    <dt>Status</dt>
                    <dd className="font-semibold text-slate-900">{user.subscriptionActive ? 'Active' : 'Paused'}</dd>
                  </div>
                  <div className="flex items-center justify-between">
                    <dt>Weekly cost</dt>
                    <dd className="font-semibold text-lagoon-600">{fmtUSD(user.subscriptionAmount)}</dd>
                  </div>
                  <div className="flex items-center justify-between">
                    <dt>Next payment</dt>
                    <dd className="font-semibold text-slate-900">{nextEligiblePayment ? new Date(nextEligiblePayment).toLocaleDateString() : 'Anytime'}</dd>
                  </div>
                </dl>
                <button
                  className="w-full rounded-full bg-lagoon-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-lagoon-700 disabled:cursor-not-allowed disabled:opacity-60"
                  onClick={paySubscriptionNow}
                  disabled={isFrozen || cannotPayNow}
                >
                  Pay subscription now
                </button>
                {cannotPayNow && (
                  <p className="text-xs text-slate-500">
                    You can pay again once seven days have passed
                    {nextEligiblePayment ? ` (next window opens on ${new Date(nextEligiblePayment).toLocaleDateString()})` : ''}.
                  </p>
                )}
              </div>

              <div className="space-y-3 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
                <div className="flex items-center justify-between">
                  <h3 className="text-xl font-semibold text-slate-900">Notes</h3>
                  <span className="text-xs uppercase tracking-wide text-slate-400">Private to you</span>
                </div>
                <textarea
                  className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-3 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 disabled:cursor-not-allowed disabled:opacity-60"
                  rows="6"
                  value={notes}
                  onChange={(event) => setNotes(event.target.value)}
                  onBlur={handleNotesBlur}
                  disabled={isFrozen}
                  placeholder="Capture reminders, saving goals, or reflections about your week."
                />
              </div>
            </aside>
          </div>
        </div>
      );
    }

    function AdminUserCard({ user, onToggleSubscription, onChangeSubscriptionAmount, onAdjustBalance, onChargeSubscription, onRemoveUser }) {
      const [amount, setAmount] = useState('');
      const [note, setNote] = useState('');
      const [subscription, setSubscription] = useState(user.subscriptionAmount);

      useEffect(() => {
        setSubscription(user.subscriptionAmount);
      }, [user.subscriptionAmount]);

      const balance = useMemo(() => computeBalance(user), [user.transactions]);
      const totalIncome = useMemo(() => totalRecurring(user.weeklyIncome), [user.weeklyIncome]);
      const totalExpenses = useMemo(() => totalRecurring(user.weeklyExpenses), [user.weeklyExpenses]);
      const projectedNet = totalIncome - totalExpenses - (user.subscriptionActive ? safeAmount(user.subscriptionAmount) : 0);
      const lastPayment = user.lastSubscriptionPayment ? new Date(user.lastSubscriptionPayment).toLocaleString() : 'Never';

      return (
        <li className="space-y-6 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
          <div className="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
            <div>
              <h3 className="text-xl font-semibold text-slate-900">{user.name || user.email}</h3>
              <p className="text-xs text-slate-500">{user.email}</p>
              {user.classNumber && <p className="text-xs text-lagoon-600">Class {user.classNumber}</p>}
            </div>
            <div className="flex items-center gap-2">
              <span
                className={`rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wide ${
                  user.subscriptionActive ? 'bg-lagoon-50 text-lagoon-700' : 'bg-slate-200 text-slate-600'
                }`}
              >
                {user.subscriptionActive ? 'Active' : 'Paused'}
              </span>
              <span className="rounded-full bg-lagoon-600/10 px-3 py-1 text-xs font-semibold text-lagoon-700">
                {user.transactions.length} entries
              </span>
            </div>
          </div>

          <div className="grid gap-4 md:grid-cols-2">
            <div className="rounded-2xl border border-lagoon-100 bg-lagoon-50/60 px-4 py-3">
              <p className="text-xs uppercase tracking-wide text-lagoon-700">Balance</p>
              <p className="text-lg font-semibold text-slate-900">{fmtUSD(balance)}</p>
            </div>
            <div className="rounded-2xl border border-sand-100 bg-white/80 px-4 py-3">
              <p className="text-xs uppercase tracking-wide text-slate-500">Weekly plan</p>
              <p className="text-sm text-slate-600">
                +{fmtUSD(totalIncome)} · -{fmtUSD(totalExpenses)} · Subscription {fmtUSD(user.subscriptionAmount)}
              </p>
            </div>
          </div>

          <div className="grid gap-3 md:grid-cols-2">
            <div className="rounded-2xl border border-white/70 bg-white px-4 py-3 text-sm text-slate-600">
              <div className="flex justify-between">
                <span>Projected weekly net</span>
                <span className={`font-semibold ${projectedNet >= 0 ? 'text-lagoon-600' : 'text-coral-500'}`}>
                  {fmtUSD(projectedNet)}
                </span>
              </div>
            </div>
            <div className="rounded-2xl border border-white/70 bg-white px-4 py-3 text-sm text-slate-600">
              <div className="flex justify-between">
                <span>Last subscription payment</span>
                <span className="font-semibold text-slate-900">{lastPayment}</span>
              </div>
            </div>
          </div>

          <div className="grid gap-4 md:grid-cols-2">
            <div className="rounded-2xl border border-white/70 bg-white px-4 py-3 text-sm text-slate-600">
              <h4 className="font-semibold text-slate-900">Weekly income</h4>
              <ul className="mt-2 space-y-1 text-xs">
                {(user.weeklyIncome || []).map((item) => (
                  <li key={item.id} className="flex justify-between">
                    <span>{item.label}</span>
                    <span>{fmtUSD(item.amount)}</span>
                  </li>
                ))}
                {(user.weeklyIncome || []).length === 0 && <li className="text-slate-400">None</li>}
              </ul>
            </div>
            <div className="rounded-2xl border border-white/70 bg-white px-4 py-3 text-sm text-slate-600">
              <h4 className="font-semibold text-slate-900">Weekly expenses</h4>
              <ul className="mt-2 space-y-1 text-xs">
                {(user.weeklyExpenses || []).map((item) => (
                  <li key={item.id} className="flex justify-between">
                    <span>{item.label}</span>
                    <span>{fmtUSD(item.amount)}</span>
                  </li>
                ))}
                {(user.weeklyExpenses || []).length === 0 && <li className="text-slate-400">None</li>}
              </ul>
            </div>
          </div>

          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Subscription amount</label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  step="0.01"
                  value={subscription}
                  onChange={(event) => setSubscription(event.target.value)}
                  className="w-full rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                />
                <button
                  className="rounded-full bg-lagoon-600 px-4 py-2 text-xs font-semibold text-white shadow transition hover:bg-lagoon-700"
                  onClick={() => onChangeSubscriptionAmount(user.id, subscription)}
                >
                  Save
                </button>
              </div>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-700">Quick actions</label>
              <div className="flex flex-wrap gap-2">
                <button
                  className="rounded-full bg-lagoon-600 px-4 py-2 text-xs font-semibold text-white shadow transition hover:bg-lagoon-700"
                  onClick={() => onToggleSubscription(user.id, true)}
                >
                  Activate
                </button>
                <button
                  className="rounded-full border border-lagoon-200 bg-white px-4 py-2 text-xs font-semibold text-slate-700 transition hover:border-lagoon-300"
                  onClick={() => onToggleSubscription(user.id, false)}
                >
                  Pause
                </button>
                <button
                  className="rounded-full border border-coral-200 bg-white px-4 py-2 text-xs font-semibold text-coral-500 transition hover:bg-coral-50"
                  onClick={() => onChargeSubscription(user.id)}
                >
                  Charge now
                </button>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-semibold text-slate-700">Post an adjustment</label>
            <div className="grid gap-2 md:grid-cols-[1fr_2fr_auto]">
              <input
                type="number"
                step="0.01"
                value={amount}
                onChange={(event) => setAmount(event.target.value)}
                className="rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                placeholder="Amount"
              />
              <input
                type="text"
                value={note}
                onChange={(event) => setNote(event.target.value)}
                className="rounded-xl border border-lagoon-100 bg-white px-3 py-2 text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200"
                placeholder="Reason"
              />
              <button
                className="rounded-full bg-lagoon-600 px-4 py-2 text-xs font-semibold text-white shadow transition hover:bg-lagoon-700"
                onClick={() => {
                  const value = safeAmount(amount);
                  if (value === 0) return;
                  onAdjustBalance(user.id, value, note || 'Admin adjustment');
                  setAmount('');
                  setNote('');
                }}
              >
                Post
              </button>
            </div>
          </div>

          <div className="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
            <span>Created {new Date(user.createdAt || now()).toLocaleDateString()}</span>
            <button
              className="text-xs text-coral-500 transition hover:text-coral-600"
              onClick={() => {
                if (window.confirm('Delete this account? All locally stored data will be removed.')) {
                  onRemoveUser(user.id);
                }
              }}
            >
              Delete account
            </button>
          </div>
        </li>
      );
    }

    function AdminDashboard({ users, onToggleSubscription, onChangeSubscriptionAmount, onAdjustBalance, onChargeSubscription, onRemoveUser }) {
      const [query, setQuery] = useState('');
      const [selectedClass, setSelectedClass] = useState('');

      const classes = useMemo(() => {
        const counts = new Map();
        users.forEach((user) => {
          const value = (user.classNumber || '').trim();
          if (!value) return;
          counts.set(value, (counts.get(value) || 0) + 1);
        });
        return Array.from(counts.entries())
          .map(([value, count]) => ({ value, count }))
          .sort((a, b) => a.value.localeCompare(b.value, undefined, { numeric: true, sensitivity: 'base' }));
      }, [users]);

      useEffect(() => {
        if (!selectedClass) return;
        const exists = classes.some((item) => item.value.toLowerCase() === selectedClass.trim().toLowerCase());
        if (!exists) {
          setSelectedClass('');
        }
      }, [classes, selectedClass]);

      const filtered = useMemo(() => {
        const term = query.trim().toLowerCase();
        const normalizedSelection = selectedClass.trim().toLowerCase();
        return users.filter((user) => {
          const userClass = (user.classNumber || '').trim();
          const matchesClass = !normalizedSelection || userClass.toLowerCase() === normalizedSelection;
          if (!matchesClass) return false;
          if (!term) return true;
          return `${user.name} ${user.email} ${userClass}`.toLowerCase().includes(term);
        });
      }, [users, query, selectedClass]);

      return (
        <section className="space-y-6 rounded-xl2 border border-white/70 bg-white/90 p-8 shadow-aurora">
          <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <p className="text-xs uppercase tracking-[0.3em] text-lagoon-600">Administrator</p>
              <h2 className="mt-1 text-2xl font-semibold text-slate-900">Control center</h2>
              <p className="text-sm text-slate-500">
                Review student accounts, manage subscriptions, and keep every classroom organized.
              </p>
            </div>
            <div className="flex w-full flex-col gap-3 sm:flex-row sm:items-center sm:justify-end">
              <div className="rounded-2xl border border-lagoon-100 bg-lagoon-50/60 px-4 py-2 text-xs font-semibold text-lagoon-700 shadow-sm">
                {users.length} total users
              </div>
              <input
                type="search"
                value={query}
                onChange={(event) => setQuery(event.target.value)}
                placeholder="Search by name, email, or class"
                className="w-full rounded-full border border-lagoon-100 bg-white px-4 py-2 text-sm text-slate-900 placeholder-slate-400 shadow-sm focus:border-lagoon-300 focus:outline-none focus:ring-2 focus:ring-lagoon-200 sm:w-72"
              />
            </div>
          </div>

          {classes.length > 0 && (
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={() => setSelectedClass('')}
                className={`rounded-full border px-3 py-1 text-xs font-semibold transition ${
                  selectedClass === ''
                    ? 'border-lagoon-200 bg-lagoon-600/10 text-lagoon-700'
                    : 'border-lagoon-100 text-slate-600 hover:border-lagoon-200'
                }`}
              >
                All classes
              </button>
              {classes.map((item) => (
                <button
                  key={item.value}
                  type="button"
                  onClick={() => setSelectedClass(item.value)}
                  className={`rounded-full border px-3 py-1 text-xs font-semibold transition ${
                    selectedClass.toLowerCase() === item.value.toLowerCase()
                      ? 'border-lagoon-200 bg-lagoon-600/10 text-lagoon-700'
                      : 'border-lagoon-100 text-slate-600 hover:border-lagoon-200'
                  }`}
                >
                  Class {item.value}
                  <span className="ml-2 rounded-full bg-white px-2 py-0.5 text-[10px] font-semibold text-slate-700">
                    {item.count}
                  </span>
                </button>
              ))}
            </div>
          )}

          <ul className="space-y-5">
            {filtered.map((user) => (
              <AdminUserCard
                key={user.id}
                user={user}
                onToggleSubscription={onToggleSubscription}
                onChangeSubscriptionAmount={onChangeSubscriptionAmount}
                onAdjustBalance={onAdjustBalance}
                onChargeSubscription={onChargeSubscription}
                onRemoveUser={onRemoveUser}
              />
            ))}
            {filtered.length === 0 && <li className="text-sm text-slate-500">No matching accounts.</li>}
          </ul>
        </section>
      );
    }
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    function App() {
      const [users, setUsersState] = useState(loadUsers);
      const [currentUserId, setCurrentUserId] = useState(() => localStorage.getItem(CURRENT_USER_KEY));
      const [toast, setToast] = useState(null);

      const setUsers = useCallback((updater) => {
        setUsersState((prev) => {
          const nextValue = typeof updater === 'function' ? updater(prev) : updater;
          if (nextValue === prev) {
            return prev;
          }

          const nextArray = Array.isArray(nextValue) ? nextValue : prev;
          if (nextArray === prev) {
            return prev;
          }

          const normalizedForStorage = nextArray.map(normalizeUser);
          saveUsers(normalizedForStorage);
          return nextArray;
        });
      }, []);

      useEffect(() => {
        if (currentUserId) {
          localStorage.setItem(CURRENT_USER_KEY, currentUserId);
        } else {
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      }, [currentUserId]);

      useEffect(() => {
        function handleStorage(event) {
          if (event.key === DB_KEY) {
            setUsersState(loadUsers());
          }
          if (event.key === CURRENT_USER_KEY) {
            setCurrentUserId(event.newValue || null);
          }
        }

        window.addEventListener('storage', handleStorage);
        return () => window.removeEventListener('storage', handleStorage);
      }, [setUsersState, setCurrentUserId]);

      const currentUser = useMemo(
        () => users.find((user) => user.id === currentUserId) || null,
        [users, currentUserId]
      );

      const isAdmin = currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();

      function notify(message) {
        setToast(message);
      }

      function handleAuthenticate({ email, name, password, classNumber }) {
        const trimmedEmail = (email || '').trim().toLowerCase();
        if (!trimmedEmail || !trimmedEmail.includes('@')) {
          return notify('Enter a valid email address.');
        }
        const trimmedPassword = (password || '').trim();
        if (trimmedPassword.length < 4) {
          return notify('Password must be at least 4 characters.');
        }
        const trimmedClass = (classNumber || '').trim();

        setUsers((prev) => {
          const existing = prev.find((user) => user.email.toLowerCase() === trimmedEmail);
          if (existing) {
            if (existing.password && existing.password !== trimmedPassword) {
              notify('Incorrect password for this account.');
              return prev;
            }
            let nextUsers = prev;
            let message = `Welcome back, ${existing.name || existing.email}!`;
            if (trimmedClass && trimmedClass !== (existing.classNumber || '')) {
              nextUsers = prev.map((user) =>
                user.id === existing.id
                  ? normalizeUser({ ...user, classNumber: trimmedClass })
                  : user
              );
              message = `${message} Class ${trimmedClass} saved.`;
            }
            setCurrentUserId(existing.id);
            notify(message);
            return nextUsers;
          }

          if (!name || !name.trim()) {
            notify('Please tell us your name so we can create your account.');
            return prev;
          }

          const newUser = normalizeUser({
            id: uid(),
            name: name.trim(),
            email: trimmedEmail,
            password: trimmedPassword,
            classNumber: trimmedClass,
            subscriptionActive: true,
            subscriptionAmount: DEFAULT_SUBSCRIPTION_AMOUNT,
            transactions: [],
            weeklyIncome: [],
            weeklyExpenses: [],
          });

          const updated = [...prev, newUser];
          setCurrentUserId(newUser.id);
          notify('Account created. Start tracking your money!');
          return updated;
        });
      }

      function logout() {
        setCurrentUserId(null);
        notify('Logged out safely');
      }

      function updateUser(id, updater) {
        setUsers((prev) =>
          prev.map((user) => {
            if (user.id !== id) return user;
            const next = typeof updater === 'function' ? updater(user) : updater;
            return normalizeUser({ ...user, ...next });
          })
        );
      }

      function removeUser(id) {
        setUsers((prev) => prev.filter((user) => user.id !== id));
        if (currentUserId === id) {
          setCurrentUserId(null);
        }
        notify('Account deleted');
      }

      function toggleSubscription(id, active) {
        updateUser(id, (user) => ({
          subscriptionActive: Boolean(active),
        }));
        notify(active ? 'Subscription activated' : 'Subscription paused');
      }

      function changeSubscriptionAmount(id, value) {
        const parsed = safeAmount(value);
        updateUser(id, () => ({ subscriptionAmount: parsed }));
        notify('Subscription amount saved');
      }

      function adjustBalance(id, amount, memo) {
        const delta = safeAmount(amount);
        if (delta === 0) return;
        updateUser(id, (user) => ({
          transactions: [
            ...(user.transactions || []),
            createTransaction({ amount: delta, memo, type: 'admin-adjustment' }),
          ],
        }));
        notify('Adjustment posted');
      }

      function chargeSubscription(id) {
        const target = users.find((user) => user.id === id);
        if (!target) return;
        if (!target.subscriptionActive) {
          notify('This subscription is paused. Activate it before charging.');
          return;
        }
        const timestamp = now();
        const amount = safeAmount(target.subscriptionAmount || DEFAULT_SUBSCRIPTION_AMOUNT);
        if (amount <= 0) {
          notify('Set a subscription amount greater than $0 before charging.');
          return;
        }
        if (target.lastSubscriptionPayment && timestamp - target.lastSubscriptionPayment < WEEK_MS) {
          notify('This account already paid within the last 7 days.');
          return;
        }
        updateUser(id, (user) => ({
          transactions: [
            ...(user.transactions || []),
            createTransaction({ amount: -Math.abs(amount), memo: 'Subscription fee', type: 'subscription' }),
          ],
          lastSubscriptionPayment: timestamp,
        }));
        notify('Subscription charge recorded');
      }

      const pageClasses = 'bg-gradient-to-br from-sand-50 via-white to-lagoon-50 text-slate-900';

      return (
        <div className={`min-h-screen ${pageClasses}`}>
          <div className="mx-auto flex max-w-7xl flex-col gap-8 px-4 py-10 sm:px-6 lg:px-8">
            <Header
              onLogout={currentUser ? logout : null}
              isAdmin={isAdmin}
              userName={currentUser ? currentUser.name || currentUser.email : null}
            />

            {!currentUser && <LoginCard onAuthenticate={handleAuthenticate} />}

            {currentUser && !isAdmin && (
              <StudentDashboard
                user={currentUser}
                onUpdate={(updater) => updateUser(currentUser.id, updater)}
                onNotify={notify}
              />
            )}

            {currentUser && isAdmin && (
              <AdminDashboard
                users={users}
                onToggleSubscription={toggleSubscription}
                onChangeSubscriptionAmount={changeSubscriptionAmount}
                onAdjustBalance={adjustBalance}
                onChargeSubscription={chargeSubscription}
                onRemoveUser={removeUser}
              />
            )}
          </div>
          <Toast message={toast} onDismiss={() => setToast(null)} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
