<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Banking — Pseudonymous + Classes + Admin (Claims)</title>

  <!-- Tailwind CSS -->
  <script>window.tailwind = { config: { darkMode: false } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat (app + auth + firestore + functions) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
  </style>
</head>

<body class="h-full bg-white text-slate-900">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =========================
    // Firebase Init (YOUR KEYS)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBD0mSQYbzt0hYLPfTRYp6BcoD0fPmxS9o",
      authDomain: "student-bank-62951.firebaseapp.com",
      projectId: "student-bank-62951",
      storageBucket: "student-bank-62951.firebasestorage.app",
      messagingSenderId: "185943826805",
      appId: "1:185943826805:web:43f8f19a8fc3f09522b33c"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const fx   = firebase.functions(); // default region us-central1; adjust if you deploy elsewhere

    // =========================
    // Helpers (no PII)
    // =========================
    function alias() {
      const animals = [
        "Otter","Hawk","Wolf","Lynx","Kestrel","Puma","Fox","Raven","Falcon","Orca",
        "Bison","Elk","Badger","Heron","Salmon","Cedar","Maple","Aspen","Pine","Birch"
      ];
      const a = animals[Math.floor(Math.random() * animals.length)];
      return `${a}-${Math.floor(1000 + Math.random() * 9000)}`;
    }
    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function fmtUSD(n){ return (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    const now = () => Date.now();
    function computeBalance(user){
      const tx = Array.isArray(user.transactions) ? user.transactions : [];
      return tx.reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    // =========================
    // Firestore Accessors
    // =========================
    async function ensureAnonProfile(classId=null) {
      const cred = await auth.signInAnonymously();
      const uid  = cred.user.uid;
      const profileRef = db.collection("profiles").doc(uid);
      const snap = await profileRef.get();
      if (!snap.exists) {
        await profileRef.set({
          uid,
          alias: alias(),
          classId: classId || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastActive: firebase.firestore.FieldValue.serverTimestamp(),
          subscriptionActive: false,
          weeklyDeductions: [],
          goals: [],
          budgets: {},
          transactions: []
        });
      } else {
        await profileRef.update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() });
      }
      return uid;
    }
    async function getMyProfile(uid) {
      const doc = await db.collection("profiles").doc(uid).get();
      return doc.exists ? doc.data() : null;
    }
    async function updateMyProfile(uid, patch) {
      await db.collection("profiles").doc(uid).update({
        ...patch,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    async function addTransaction(uid, amount, memo) {
      const ref = db.collection("profiles").doc(uid);
      await ref.update({
        transactions: firebase.firestore.FieldValue.arrayUnion({
          amount: Number(amount), memo: memo || null, ts: now()
        }),
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    async function removeLastTransaction(uid) {
      const ref = db.collection("profiles").doc(uid);
      const snap = await ref.get();
      if (!snap.exists) return;
      const data = snap.data();
      const tx = Array.isArray(data.transactions) ? data.transactions.slice(0, -1) : [];
      await ref.update({ transactions: tx, lastActive: firebase.firestore.FieldValue.serverTimestamp() });
    }
    async function applyWeeklyNow(uid) {
      const ref = db.collection("profiles").doc(uid);
      const snap = await ref.get();
      if (!snap.exists) return;
      const data = snap.data();
      const txs = Array.isArray(data.transactions) ? [...data.transactions] : [];
      (data.weeklyDeductions || []).forEach(d => {
        txs.push({ amount: -Number(d.amount), memo: `Weekly: ${d.name}`, ts: now() });
      });
      await ref.update({ transactions: txs, lastActive: firebase.firestore.FieldValue.serverTimestamp() });
    }
    async function joinClass(uid, code) {
      const q = await db.collection("classes").where("code","==",String(code)).limit(1).get();
      if (q.empty) {
        const newDoc = await db.collection("classes").add({
          code: String(code),
          title: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await updateMyProfile(uid, { classId: newDoc.id });
        await db.collection("enrollments").add({ uid, classId: newDoc.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        return { created: true, classId: newDoc.id };
      } else {
        const doc = q.docs[0];
        await updateMyProfile(uid, { classId: doc.id });
        await db.collection("enrollments").add({ uid, classId: doc.id, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        return { created: false, classId: doc.id };
      }
    }
    async function setRecoveryKey(uid, plainKey) {
      const hash = await sha256Hex(plainKey);
      await db.collection("recovery").doc(hash).set({ uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      return hash;
    }
    async function resolveRecoveryKey(plainKey) {
      const hash = await sha256Hex(plainKey);
      const doc = await db.collection("recovery").doc(hash).get();
      if (!doc.exists) throw new Error("Invalid recovery key");
      return doc.data().uid;
    }

    // =========================
    // Admin: callable functions
    // =========================
    const callRequestAdmin     = (code)      => fx.httpsCallable('requestAdmin')({ code });
    const callAdminListRoster  = ()          => fx.httpsCallable('adminListRoster')({});
    const callAdminAdjust      = (uid, d,m)  => fx.httpsCallable('adminAdjust')({ uid, delta: d, memo: m||null });
    const callAdminToggleSub   = (uid, b)    => fx.httpsCallable('adminToggleSub')({ uid, active: !!b });
    const callAdminRenameClass = (id, t)     => fx.httpsCallable('adminRenameClass')({ classId: id, title: t||null });
    const callAdminRemoveFrom  = (id, uid)   => fx.httpsCallable('adminRemoveFromClass')({ classId: id, uid });

    // =========================
    // UI primitives
    // =========================
    function Toast({ text, onClose }) {
      useEffect(() => { const t = setTimeout(onClose, 1800); return () => clearTimeout(t); }, [onClose]);
      return <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-800 text-white text-sm px-3 py-2 rounded shadow-lg">{text}</div>;
    }
    function ProgressBar({ value, max }) {
      const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
      return (
        <div className="w-full h-2 bg-blue-100 rounded-full overflow-hidden" role="progressbar" aria-valuenow={pct} aria-valuemin="0" aria-valuemax="100">
          <div className="h-2 bg-blue-600" style={{ width: pct + '%' }} />
        </div>
      );
    }
    function Pill({children}) {
      return <span className="inline-block px-2 py-0.5 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">{children}</span>;
    }

    // =========================
    // Goal Row
    // =========================
    function GoalRow({ g, onContribute }) {
      const [contrib, setContrib] = useState('');
      const saved = Number(g.saved)||0;
      const target = Number(g.target)||0;
      const remaining = Math.max(0, target - saved);
      return (
        <div className="p-3 rounded border border-blue-100 bg-white">
          <div className="flex items-center justify-between gap-2">
            <div>
              <div className="font-medium">{g.name}</div>
              <div className="text-sm text-slate-600">{fmtUSD(saved)} / {fmtUSD(target)} <span className="text-slate-500">({fmtUSD(remaining)} left)</span></div>
            </div>
            <div className="flex items-center gap-2">
              <input className="border border-blue-200 p-1 rounded w-28" type="number" step="0.01" placeholder="$ add" value={contrib} onChange={e=>setContrib(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-1 rounded" onClick={()=>{ const n = parseFloat(contrib); if(!Number.isNaN(n) && n>0){ onContribute(n); setContrib(''); } }}>Contribute</button>
            </div>
          </div>
          <div className="mt-2"><ProgressBar value={saved} max={target} /></div>
        </div>
      );
    }

    // =========================
    // Admin Panel (via Functions)
    // =========================
    function AdminPanel({ roster, onAdjust, onToggleSub, onRenameClass, onRemoveFromClass }) {
      const [q, setQ] = useState('');
      const search = q.trim().toLowerCase();
      const filteredProfiles = useMemo(() => {
        if (!search) return roster.profiles;
        return roster.profiles.filter(p =>
          String(p.alias||'').toLowerCase().includes(search) ||
          String(p.uid||'').slice(-6).includes(search)
        );
      }, [roster, search]);

      const classMap = new Map(roster.classes.map(c => [c.id, c]));

      return (
        <section className="md:col-span-2 bg-white p-5 rounded-2xl shadow-sm space-y-6 border border-blue-100">
          <div>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-blue-800">Admin · Profiles (no PII)</h3>
              <input className="border border-blue-200 rounded px-2 py-1 text-sm" placeholder="Search alias or last 6 UID" value={q} onChange={e=>setQ(e.target.value)} />
            </div>
            <ul className="divide-y divide-blue-100 max-h-[320px] overflow-auto pr-1">
              {filteredProfiles.map(p => {
                const bal = fmtUSD(computeBalance(p));
                const uidTail = String(p.uid||'').slice(-6);
                return (
                  <li key={p.uid} className="py-3 flex items-center justify-between">
                    <div className="space-y-1">
                      <div className="font-medium">{p.alias} <span className="text-slate-500">· uid …{uidTail}</span></div>
                      <div className="text-xs text-slate-600">Balance: <strong>{bal}</strong></div>
                      <div className="text-xs text-slate-500">Subscription: {p.subscriptionActive ? <Pill>Active</Pill> : <Pill>Inactive</Pill>}</div>
                      <div className="text-xs text-slate-500">Class: {p.classId ? (classMap.get(p.classId)?.code ?? p.classId) : '—'}</div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      <button className="px-3 py-1 rounded bg-blue-600 text-white text-xs" onClick={()=>onToggleSub(p.uid, true)}>Activate</button>
                      <button className="px-3 py-1 rounded bg-blue-800 text-white text-xs" onClick={()=>onToggleSub(p.uid, false)}>Cancel</button>
                      <button className="px-3 py-1 rounded bg-blue-50 text-blue-700 border border-blue-200 text-xs" onClick={()=>onAdjust(p.uid, +5, 'Admin +$5')}>+ $5</button>
                      <button className="px-3 py-1 rounded bg-blue-50 text-blue-700 border border-blue-200 text-xs" onClick={()=>onAdjust(p.uid, -5, 'Admin -$5')}>− $5</button>
                    </div>
                  </li>
                );
              })}
            </ul>
          </div>

          <div>
            <h3 className="text-lg font-semibold text-blue-800 mb-2">Classes</h3>
            {roster.classes.length === 0 && <p className="text-sm text-slate-500">No classes yet. Students can join by entering a class code.</p>}
            <ul className="space-y-3">
              {roster.classes.map(cls => {
                const members = roster.enrollments.filter(e => e.classId === cls.id).map(e => e.uid);
                return (
                  <li key={cls.id} className="p-3 rounded border border-blue-100 bg-white">
                    <div className="flex items-center justify-between gap-3">
                      <div>
                        <div className="font-medium">Class {cls.code}{cls.title ? ` — ${cls.title}` : ''}</div>
                        <div className="text-xs text-slate-500">Members: {members.length}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <input className="border border-blue-200 rounded px-2 py-1 text-sm w-44" placeholder="Rename (optional)"
                          onKeyDown={e=>{ if(e.key==='Enter'){ onRenameClass(cls.id, e.currentTarget.value.trim()); e.currentTarget.value=''; } }} />
                        <button className="px-3 py-1 rounded bg-blue-50 border border-blue-200 text-blue-700 text-xs"
                          onClick={()=>{
                            const t = prompt('New title for Class '+cls.code, cls.title||'');
                            if (t !== null) onRenameClass(cls.id, t.trim());
                          }}>Rename</button>
                      </div>
                    </div>
                    <ul className="mt-2 divide-y divide-blue-100">
                      {members.length === 0 && <li className="py-2 text-sm text-slate-500">No members yet.</li>}
                      {members.map(uid => {
                        const p = roster.profiles.find(pp => pp.uid === uid);
                        const bal = p ? fmtUSD(computeBalance(p)) : '—';
                        const alias = p?.alias ?? 'Unknown';
                        return (
                          <li key={uid} className="py-2 flex items-center justify-between">
                            <span className="text-sm">{alias} <span className="text-slate-400">· uid …{String(uid).slice(-6)}</span> · Bal {bal}</span>
                            <button className="text-xs px-2 py-1 rounded bg-blue-800 text-white" onClick={()=>onRemoveFromClass(cls.id, uid)}>Remove</button>
                          </li>
                        );
                      })}
                    </ul>
                  </li>
                );
              })}
            </ul>
          </div>
        </section>
      );
    }

    // =========================
    // User Panel
    // =========================
    function UserPanel({ profile, onUpdate, onJoinClass, onApplyWeekly, onTx, onUndo }) {
      const [delta, setDelta] = useState('');
      const [memo, setMemo] = useState('');
      const [wdName, setWdName] = useState('');
      const [wdAmt, setWdAmt] = useState('');
      const [goalName, setGoalName] = useState('');
      const [goalTarget, setGoalTarget] = useState('');
      const [cat, setCat] = useState('');
      const [bAmt, setBAmt] = useState('');
      const [classCode, setClassCode] = useState('');

      const balance = useMemo(()=> computeBalance(profile), [profile.transactions]);

      function addWeekly(){
        const n = parseFloat(wdAmt); if(!wdName || Number.isNaN(n) || n<=0) return;
        const upd = [...(profile.weeklyDeductions||[]), { name: wdName, amount: n }];
        onUpdate({ weeklyDeductions: upd });
        onTx(-n, `Weekly: ${wdName}`);
        setWdName(''); setWdAmt('');
      }
      function addGoal(){
        const t = parseFloat(goalTarget); if(!goalName || Number.isNaN(t) || t<=0) return;
        const goals = [...(profile.goals||[]), { name: goalName, target: t, saved: 0 }];
        onUpdate({ goals });
        setGoalName(''); setGoalTarget('');
      }
      function contributeGoal(idx, amt){
        const n = Number(amt); if(Number.isNaN(n) || n<=0) return;
        const goals = [...(profile.goals||[])];
        const g = {...goals[idx]};
        const maxAdd = Math.min(n, Math.max(0, Number(g.target) - Number(g.saved)));
        if (maxAdd <= 0) return;
        g.saved = Number(g.saved) + maxAdd; goals[idx] = g;
        onUpdate({ goals });
        onTx(-n, 'Goal contribution');
      }
      function upsertBudget(){
        const n = parseFloat(bAmt); if(!cat || Number.isNaN(n) || n<=0) return;
        const b = { ...(profile.budgets||{}), [cat]: n };
        onUpdate({ budgets: b });
        setCat(''); setBAmt('');
      }
      function deleteBudget(k){
        const b = { ...(profile.budgets||{}) }; delete b[k];
        onUpdate({ budgets: b });
      }
      async function handleJoin(){
        const code = String(classCode).trim();
        if (!/^\d+$/.test(code)) { alert("Enter a numeric class code"); return; }
        await onJoinClass(code);
        setClassCode('');
      }

      return (
        <section className="md:col-span-2 bg-white p-5 rounded-2xl shadow-sm space-y-6 border border-blue-100">
          <div>
            <h3 className="text-lg font-semibold text-blue-800">Welcome, {profile.alias}</h3>
            <p className="text-sm text-slate-700">Balance: <strong>{fmtUSD(balance)}</strong></p>
            <p className="text-xs text-slate-500">UID …{String(profile.uid).slice(-6)} · Class: {profile.classId ? profile.classId : '—'}</p>
          </div>

          <div className="p-3 rounded border border-blue-100 bg-white">
            <div className="flex flex-wrap items-center gap-2">
              <label className="text-sm">Join a class:</label>
              <input className="border border-blue-200 p-2 rounded w-40" placeholder="Class code" value={classCode} onChange={e=>setClassCode(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={handleJoin}>Join</button>
              <span className="text-xs text-slate-500">(No personal info needed.)</span>
            </div>
          </div>

          <div className="space-y-2">
            <h4 className="font-medium text-blue-800">Transactions</h4>
            <div className="flex flex-wrap gap-2 items-center">
              <input type="number" step="0.01" placeholder="$ amount" className="border border-blue-200 p-2 rounded w-36" value={delta} onChange={e=>setDelta(e.target.value)} />
              <input type="text" placeholder="Memo (optional)" className="border border-blue-200 p-2 rounded w-60" value={memo} onChange={e=>setMemo(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={()=>{const n=parseFloat(delta); if(!Number.isNaN(n)&&n>0){ onTx(n, memo || 'Deposit'); setDelta(''); setMemo('');}}}>Deposit</button>
              <button className="bg-blue-800 text-white px-3 py-2 rounded" onClick={()=>{const n=parseFloat(delta); if(!Number.isNaN(n)&&n>0){ onTx(-n, memo || 'Withdraw'); setDelta(''); setMemo('');}}}>Withdraw</button>
              <button className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded" onClick={onUndo}>Undo last</button>
            </div>
            <ul className="divide-y divide-blue-100 bg-white rounded border border-blue-100 max-h-[240px] overflow-auto">
              {(profile.transactions||[]).slice().reverse().map((t,i)=> (
                <li key={i} className="flex items-center justify-between p-2">
                  <span className="text-sm">{new Date(t.ts||now()).toLocaleString()} — {t.memo || '—'}</span>
                  <span className={"text-sm font-medium "+(t.amount>=0?'text-blue-800':'text-blue-700')}>{t.amount>=0?'+':''}{Number(t.amount).toFixed(2)}</span>
                </li>
              ))}
              {(profile.transactions||[]).length === 0 && <li className="p-2 text-sm text-slate-500">No transactions yet.</li>}
            </ul>
          </div>

          <div>
            <h4 className="font-medium text-blue-800 mb-2">Weekly Deductions</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border border-blue-200 p-2 rounded" placeholder="Name (e.g., Phone)" value={wdName} onChange={e=>setWdName(e.target.value)} />
              <input className="border border-blue-200 p-2 rounded w-32" type="number" step="0.01" placeholder="Amount" value={wdAmt} onChange={e=>setWdAmt(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={addWeekly}>Add & Apply</button>
              <button className="bg-blue-800 text-white px-3 py-2 rounded" onClick={onApplyWeekly}>Run all weekly now</button>
            </div>
            <ul className="space-y-2">
              {(profile.weeklyDeductions||[]).map((d,i)=> (
                <li key={i} className="flex items-center justify-between bg-blue-50 border border-blue-100 p-2 rounded">
                  <span>{d.name} — <strong>{fmtUSD(d.amount)}</strong></span>
                  <span className="text-xs text-slate-400">fixed</span>
                </li>
              ))}
              {(!profile.weeklyDeductions || profile.weeklyDeductions.length===0) && (
                <li className="text-sm text-slate-500">No weekly deductions yet.</li>
              )}
            </ul>
          </div>

          <div>
            <h4 className="font-medium text-blue-800 mb-2">Goals</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border border-blue-200 p-2 rounded" placeholder="Goal name (e.g., Bike)" value={goalName} onChange={e=>setGoalName(e.target.value)} />
              <input className="border border-blue-200 p-2 rounded w-32" type="number" step="0.01" placeholder="Target $" value={goalTarget} onChange={e=>setGoalTarget(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={addGoal}>Add Goal</button>
            </div>
            <div className="space-y-3">
              {(profile.goals||[]).map((g, idx) => (
                <GoalRow key={idx} g={g} onContribute={(amt)=>contributeGoal(idx, amt)} />
              ))}
              {(!profile.goals || profile.goals.length===0) && (
                <div className="text-sm text-slate-500">No goals yet. Add your first goal above.</div>
              )}
            </div>
          </div>

          <div>
            <h4 className="font-medium text-blue-800 mb-2">Budgets</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border border-blue-200 p-2 rounded" placeholder="Category (e.g., Food)" value={cat} onChange={e=>setCat(e.target.value)} />
              <input className="border border-blue-200 p-2 rounded w-32" type="number" step="0.01" placeholder="Amount $" value={bAmt} onChange={e=>setBAmt(e.target.value)} />
              <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={upsertBudget}>Add/Update</button>
            </div>
            <ul className="space-y-2">
              {Object.entries(profile.budgets||{}).map(([k,v]) => (
                <li key={k} className="flex items-center justify-between bg-blue-50 border border-blue-100 p-2 rounded">
                  <span className="font-medium">{k}</span>
                  <div className="flex items-center gap-3">
                    <span>{fmtUSD(v)}</span>
                    <button className="text-xs px-2 py-1 rounded bg-blue-800 text-white" onClick={()=>deleteBudget(k)}>Delete</button>
                  </div>
                </li>
              ))}
              {Object.keys(profile.budgets||{}).length===0 && (
                <li className="text-sm text-slate-500">No budgets yet.</li>
              )}
            </ul>
          </div>
        </section>
      );
    }

    // =========================
    // Admin Gate
    // =========================
    function AdminGate({ onOpen, onRoster }) {
      const [code, setCode] = useState('');
      const [msg, setMsg] = useState('');
      const [loading, setLoading] = useState(false);

      async function open() {
        if (!code.trim()) return;
        setLoading(true);
        try {
          // Ask server to set custom claim if code is correct
          await callRequestAdmin(code.trim());
          // Refresh token to pick up new claims
          await auth.currentUser.getIdToken(true);
          setMsg('Admin enabled.');
          onOpen();
          const roster = await callAdminListRoster();
          onRoster(roster.data);
        } catch (e) {
          setMsg('Invalid or unauthorized admin code.');
        } finally {
          setLoading(false);
        }
      }

      return (
        <div className="p-4 rounded-2xl border border-blue-100 bg-white">
          <div className="font-semibold text-blue-800 mb-1">Admin View</div>
          <p className="text-sm text-slate-600 mb-2">Enter admin code (checked on server). No secrets in the browser.</p>
          <div className="flex gap-2">
            <input className="border border-blue-200 p-2 rounded w-64" placeholder="Admin code" value={code} onChange={e=>setCode(e.target.value)} />
            <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={open} disabled={loading}>{loading ? 'Checking…' : 'Open'}</button>
          </div>
          {msg && <p className="text-xs text-slate-500 mt-2">{msg}</p>}
        </div>
      );
    }

    // =========================
    // App
    // =========================
    function App() {
      const [uid, setUid] = useState(null);
      const [profile, setProfile] = useState(null);
      const [toast, setToast] = useState(null);

      const [adminOpen, setAdminOpen] = useState(false);
      const [roster, setRoster] = useState({ profiles: [], classes: [], enrollments: [] });

      useEffect(() => {
        (async () => {
          const uid = await ensureAnonProfile();
          setUid(uid);
          const p = await getMyProfile(uid);
          setProfile(p);
        })();
      }, []);

      useEffect(() => {
        if (!uid) return;
        const unsub = db.collection("profiles").doc(uid).onSnapshot(snap => {
          if (snap.exists) setProfile({ ...snap.data(), uid: snap.data().uid });
        });
        return () => unsub && unsub();
      }, [uid]);

      function notify(msg){ setToast(msg); }

      async function updateMine(patch) { await updateMyProfile(uid, patch); }
      async function tx(delta, memo) { await addTransaction(uid, delta, memo); }
      async function undo() { await removeLastTransaction(uid); }
      async function applyWeeklyAll() { await applyWeeklyNow(uid); notify('Applied weekly deductions'); }
      async function join(code) {
        const res = await joinClass(uid, code);
        notify(res.created ? `Created and joined class ${code}` : `Joined class ${code}`);
      }
      async function onRecovered(recoveredUid) {
        setUid(recoveredUid);
        const p = await getMyProfile(recoveredUid);
        setProfile(p);
        notify('Recovered profile loaded');
      }

      // Admin actions via functions
      async function adminRefreshRoster() {
        const r = await callAdminListRoster();
        setRoster(r.data);
      }
      async function adminAdjust(uid, delta, memo) {
        await callAdminAdjust(uid, delta, memo);
        await adminRefreshRoster();
      }
      async function adminToggleSub(uid, active) {
        await callAdminToggleSub(uid, active);
        await adminRefreshRoster();
      }
      async function adminRenameClass(classId, title) {
        await callAdminRenameClass(classId, title);
        await adminRefreshRoster();
      }
      async function adminRemoveFromClass(classId, targetUid) {
        await callAdminRemoveFrom(classId, targetUid);
        await adminRefreshRoster();
      }

      if (!profile) {
        return (
          <div className="min-h-screen flex items-center justify-center p-6 bg-white">
            <div className="bg-white max-w-md w-full rounded-2xl shadow p-6 border border-blue-100">
              <h1 className="text-2xl font-bold text-blue-800 mb-2">Student Banking</h1>
              <p className="text-sm text-slate-600">Creating a pseudonymous account…</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen p-6 bg-white">
          <header className="max-w-5xl mx-auto mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-blue-800">Student Banking Dashboard</h1>
              <div className="text-sm text-slate-600">Signed in as <strong>{profile.alias}</strong> · uid …{String(profile.uid).slice(-6)}</div>
            </div>
            <div className="flex items-center gap-2">
              {!adminOpen && <AdminGate onOpen={()=>setAdminOpen(true)} onRoster={setRoster} />}
              {adminOpen && <Pill>Admin View ON</Pill>}
            </div>
          </header>

          <main className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            {adminOpen ? (
              <>
                <AdminPanel
                  roster={roster}
                  onAdjust={adminAdjust}
                  onToggleSub={adminToggleSub}
                  onRenameClass={adminRenameClass}
                  onRemoveFromClass={adminRemoveFromClass}
                />
                <aside className="bg-white p-5 rounded-2xl shadow-sm space-y-4 border border-blue-100">
                  <h3 className="text-lg font-semibold text-blue-800">Admin Tools</h3>
                  <button className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded" onClick={adminRefreshRoster}>Refresh Roster</button>
                </aside>
              </>
            ) : (
              <>
                <UserPanel
                  profile={profile}
                  onUpdate={updateMine}
                  onJoinClass={join}
                  onApplyWeekly={applyWeeklyAll}
                  onTx={tx}
                  onUndo={undo}
                />
                <aside className="bg-white p-5 rounded-2xl shadow-sm space-y-4 border border-blue-100">
                  <h3 className="text-lg font-semibold text-blue-800">Account Tools</h3>
                  <div className="p-4 rounded-2xl border border-blue-100 bg-white">
                    <div className="font-semibold text-blue-800 mb-1">Recovery Key</div>
                    <RecoveryCard uid={profile.uid} currentAlias={profile.alias} />
                    <RecoveryLinkCard onLinked={onRecovered} />
                  </div>
                  <div className="p-4 rounded-2xl border border-blue-100 bg-white">
                    <div className="font-semibold text-blue-800 mb-1">Privacy</div>
                    <p className="text-sm text-slate-600">No names, DOB, or emails are stored. Your identity is a random alias and UID.</p>
                  </div>
                </aside>
              </>
            )}
          </main>

          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
