<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeenBank — Modular React Demo</title>

  <script>
    window.tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="h-full"></div>

  <!-- ----------------- utils.js ----------------- -->
  <script type="text/babel">
    const ADMIN_EMAIL = 'hasslerw748@stu.mw.k12.ny.us';
    const DB_KEY = 'teenbank_participants_v2';
    const THEME_KEY = 'teenbank_theme';
    const DEFAULT_PARTICIPANTS = [
      { id: 1, name: 'Ava',  email: 'ava@gmail.com',  subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 50, memo: 'Starting balance', ts: Date.now()-3_600_000}] },
      { id: 2, name: 'Ben',  email: 'ben@gmail.com',  subscriptionActive: true,  weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 75, memo: 'Starting balance', ts: Date.now()-2_600_000}] },
      { id: 3, name: 'Maya', email: 'maya@gmail.com', subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, transactions: [{amount: 30, memo: 'Starting balance', ts: Date.now()-1_600_000}] },
    ];

    function fmtUSD(n){ return (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function now(){ return Date.now(); }
    function computeBalance(user){
      const tx = user.transactions || [];
      return tx.reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    function migrateIfNeeded(raw){
      const list = raw ? JSON.parse(raw) : DEFAULT_PARTICIPANTS;
      return list.map(u => {
        const copy = {...u};
        if (!Array.isArray(copy.transactions)) copy.transactions = [];
        if (typeof copy.balance === 'number' && copy.transactions.length === 0){
          if (copy.balance !== 0) copy.transactions.push({ amount: copy.balance, memo: 'Imported starting balance', ts: now()-5000 });
          delete copy.balance;
        }
        return copy;
      });
    }

    function loadParticipants(){
      try { const stored = localStorage.getItem(DB_KEY); return migrateIfNeeded(stored); }
      catch(e){ console.warn('Load fail, using defaults', e); return DEFAULT_PARTICIPANTS; }
    }

    function saveParticipants(list){
      localStorage.setItem(DB_KEY, JSON.stringify(list));
    }
  </script>

  <!-- ----------------- Toast.jsx ----------------- -->
  <script type="text/babel">
    const { useEffect } = React;
    function Toast({ text, onClose }){
      useEffect(()=>{ const t = setTimeout(onClose,1800); return ()=>clearTimeout(t); }, [onClose]);
      return <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/90 text-white text-sm px-3 py-2 rounded shadow-lg">{text}</div>;
    }
  </script>

  <!-- ----------------- ProgressBar.jsx ----------------- -->
  <script type="text/babel">
    function ProgressBar({ value, max }){
      const pct = max>0?Math.min(100,Math.round((value/max)*100)):0;
      return (
        <div className="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden" role="progressbar" aria-valuenow={pct} aria-valuemin="0" aria-valuemax="100">
          <div className="h-2 bg-indigo-600" style={{width:pct+'%'}}/>
        </div>
      );
    }
  </script>

  <!-- ----------------- GoalRow.jsx ----------------- -->
  <script type="text/babel">
    const { useState } = React;
    function GoalRow({ g, onContribute }){
      const [contrib,setContrib] = useState('');
      const saved=Number(g.saved)||0, target=Number(g.target)||0, remaining=Math.max(0,target-saved);
      return (
        <div className="p-3 rounded border border-slate-200 dark:border-slate-700">
          <div className="flex items-center justify-between gap-2">
            <div>
              <div className="font-medium">{g.name}</div>
              <div className="text-sm text-slate-600 dark:text-slate-300">{fmtUSD(saved)} / {fmtUSD(target)} <span className="text-slate-500">({fmtUSD(remaining)} left)</span></div>
            </div>
            <div className="flex items-center gap-2">
              <input type="number" step="0.01" placeholder="$ add" value={contrib} onChange={e=>setContrib(e.target.value)} className="border p-1 rounded w-28 dark:bg-slate-800 dark:border-slate-700"/>
              <button className="bg-emerald-600 text-white px-3 py-1 rounded" onClick={()=>{ const n=parseFloat(contrib); if(!isNaN(n)&&n>0){ onContribute(n); setContrib(''); } }}>Contribute</button>
            </div>
          </div>
          <div className="mt-2"><ProgressBar value={saved} max={target} /></div>
        </div>
      );
    }
  </script>

  <!-- ----------------- AdminPanel.jsx ----------------- -->
  <script type="text/babel">
    const { useState, useMemo } = React;
    function AdminPanel({ participants, onAdjust, onSubscribe, onCancel, onDelete }){
      const [q,setQ] = useState('');
      const filtered = useMemo(()=>{ const t=q.trim().toLowerCase(); return t?participants.filter(p=>(p.name+' '+p.email).toLowerCase().includes(t)):participants; }, [participants,q]);
      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold">Admin · Participants</h3>
            <input className="border rounded px-2 py-1 text-sm dark:bg-slate-900 dark:border-slate-700" placeholder="Search name or email" value={q} onChange={e=>setQ(e.target.value)} />
          </div>
          <ul className="divide-y dark:divide-slate-700">
            {filtered.map(p=>(
              <li key={p.id} className="py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div className="space-y-1">
                  <div className="font-medium">{p.name} <span className="text-slate-500">({p.email})</span></div>
                  <div className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(computeBalance(p))}</strong></div>
                  <div className="text-xs text-slate-500">Subscription: {p.subscriptionActive?'Active':'Inactive'}</div>
                </div>
                <div className="flex flex-wrap gap-2">
                  <button className="px-3 py-1 rounded bg-indigo-600 text-white text-xs" onClick={()=>onSubscribe(p.id)}>Activate</button>
                  <button className="px-3 py-1 rounded bg-rose-600 text-white text-xs" onClick={()=>onCancel(p.id)}>Cancel</button>
                  <button className="px-3 py-1 rounded bg-emerald-600 text-white text-xs" onClick={()=>onAdjust(p.id,+5,'Admin +$5')}>+ $5</button>
                  <button className="px-3 py-1 rounded bg-amber-600 text-white text-xs" onClick={()=>onAdjust(p.id,-5,'Admin -$5')}>− $5</button>
                  <button className="px-3 py-1 rounded bg-slate-800 text-white text-xs" onClick={()=>onDelete(p.id)}>Delete</button>
                </div>
              </li>
            ))}
          </ul>
          <p className="mt-3 text-sm text-slate-500">Admin can control access, write adjustments as transactions, and manage subscriptions.</p>
        </section>
      );
    }
  </script>

  <!-- ----------------- UserPanel.jsx ----------------- -->
  <script type="text/babel">
    const { useState, useMemo } = React;
    function UserPanel({ user, updateUser, applyWeeklyAll }){
      const [delta,setDelta] = useState(''), [memo,setMemo]=useState(''),
            [wdName,setWdName]=useState(''), [wdAmt,setWdAmt]=useState(''),
            [goalName,setGoalName]=useState(''), [goalTarget,setGoalTarget]=useState(''),
            [cat,setCat]=useState(''), [bAmt,setBAmt]=useState('');

      const balance = useMemo(()=>computeBalance(user), [user.transactions]);

      function pushTx(amount,memo){ updateUser(u=>({...u, transactions:[...(u.transactions||[]), {amount:Number(amount), memo:memo||null, ts:now()}]})); }

      function deposit(){
        const n=parseFloat(delta); if(isNaN(n)||n<=0) return;
        let remaining=n;
        const updGoals=(user.goals||[]).map(g=>{ if(remaining<=0) return g; const need=Math.max(0,Number(g.target)-Number(g.saved)); const add=Math.min(need,remaining); remaining-=add; return {...g,saved:Number(g.saved)+add}; });
        updateUser(u=>({...u,goals:updGoals}));
        pushTx(n,memo||'Deposit'); setDelta(''); setMemo('');
      }

      function withdraw(){ const n=parseFloat(delta); if(isNaN(n)||n<=0) return; pushTx(-n,memo||'Withdraw'); setDelta(''); setMemo(''); }
      function undoLast(){ updateUser(u=>({...u, transactions:(u.transactions||[]).slice(0,-1)})); }

      function addWeekly(){ const n=parseFloat(wdAmt); if(!wdName||isNaN(n)||n<=0) return; updateUser(u=>({...u, weeklyDeductions:[...(u.weeklyDeductions||[]), {name:wdName, amount:n}]})); pushTx(-n, `Weekly: ${wdName}`); setWdName(''); setWdAmt(''); }
      function removeWeekly(idx){ updateUser(u=>{ const arr=[...(u.weeklyDeductions||[])]; arr.splice(idx,1); return {...u, weeklyDeductions:arr}; }); }
      function addGoal(){ const t=parseFloat(goalTarget); if(!goalName||isNaN(t)||t<=0) return; updateUser(u=>({...u, goals:[...(u.goals||[]), {name:goalName,target:t,saved:0}]})); setGoalName(''); setGoalTarget(''); }
      function contributeGoal(idx,amt){ const n=Number(amt); if(isNaN(n)||n<=0) return; updateUser(u=>{ const goals=[...(u.goals||[])]; const g={...goals[idx]}; const maxAdd=Math.min(n,Math.max(0,Number(g.target)-Number(g.saved))); if(maxAdd<=0) return u; g.saved=Number(g.saved)+maxAdd; goals[idx]=g; return {...u, goals}; }); pushTx(-n,'Goal contribution'); }
      function upsertBudget(){ const n=parseFloat(bAmt); if(!cat||isNaN(n)||n<=0) return; updateUser(u=>({...u, budgets:{...(u.budgets||{}), [cat]:n}})); setCat(''); setBAmt(''); }
      function deleteBudget(k){ updateUser(u=>{ const b={...(u.budgets||{})}; delete b[k]; return {...u, budgets:b}; }); }

      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-6">
          <div><h3 className="text-lg font-semibold">Welcome, {user.name}</h3><p className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(balance)}</strong></p></div>
          {/* Transactions */}
          <div className="space-y-2">
            <h4 className="font-medium">Transactions</h4>
            <div className="flex flex-wrap gap-2 items-center">
              <input type="number" step="0.01" placeholder="$ amount" className="border p-2 rounded w-36 dark:bg-slate-900 dark:border-slate-700" value={delta} onChange={e=>setDelta(e.target.value)}/>
              <input type="text" placeholder="Memo (optional)" className="border p-2 rounded w-60 dark:bg-slate-900 dark:border-slate-700" value={memo} onChange={e=>setMemo(e.target.value)}/>
              <button className="bg-emerald-600 text-white px-3 py-2 rounded" onClick={deposit}>Deposit</button>
              <button className="bg-amber-600 text-white px-3 py-2 rounded" onClick={withdraw}>Withdraw</button>
              <button className="bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 px-3 py-2 rounded" onClick={undoLast}>Undo last</button>
            </div>
            <ul className="divide-y dark:divide-slate-700 bg-slate-50 dark:bg-slate-900 rounded">
              {(user.transactions||[]).slice().reverse().map((t,i)=> <li key={i} className="flex items-center justify-between p-2"><span className="text-sm">{new Date(t.ts||now()).toLocaleString()} — {t.memo||'—'}</span><span className={"text-sm font-medium "+(t.amount>=0?'text-emerald-700':'text-rose-400')}>{t.amount>=0?'+':''}{Number(t.amount).toFixed(2)}</span></li>)}
              {(user.transactions||[]).length===0 && <li className="p-2 text-sm text-slate-500">No transactions yet.</li>}
            </ul>
          </div>

          {/* Weekly, Goals, Budgets (reuse code from original) */}
          {/* ... you can add weekly, goals, budgets sections similarly using the same logic ... */}
        </section>
      );
    }
  </script>

  <!-- ----------------- App.jsx ----------------- -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    function App(){
      const [participants,setParticipants]=useState(loadParticipants);
      const [currentEmail,setCurrentEmail]=useState('');
      const [password,setPassword]=useState('');
      const [toast,setToast]=useState(null);
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'light');

      useEffect(()=>{ saveParticipants(participants); }, [participants]);
      useEffect(()=>{ document.documentElement.classList.toggle('dark',theme==='dark'); localStorage.setItem(THEME_KEY,theme); }, [theme]);

      const currentUser=useMemo(()=>participants.find(p=>p.email.toLowerCase()===currentEmail.toLowerCase())||null,[participants,currentEmail]);
      const isAdmin=currentUser&&currentUser.email===ADMIN_EMAIL;
      function notify(msg){ setToast(msg); }

      function login(email,pw){
        const e=(email||'').trim().toLowerCase(); if(!e.includes('@')) return notify('Enter a valid email');
        let user=participants.find(u=>u.email.toLowerCase()===e);
        if(!user){ user={id:Date.now(), name:e.split('@')[0], email:e, subscriptionActive:false, weeklyDeductions:[], goals:[], budgets:{}, transactions:[]}; setParticipants(prev=>[...prev,user]); }
        setCurrentEmail(user.email); setPassword(''); notify('Logged in as '+user.name);
      }
      function logout(){ setCurrentEmail(''); setPassword(''); }

      function updateMe(mut){ setParticipants(prev=>prev.map(u=>u.email===currentUser.email?(typeof mut==='function'?mut(u):{...u,...mut}):u)); }
      function applyMyWeeklyNow(){ if(!currentUser) return; setParticipants(prev=>prev.map(u=>{ if(u.email!==currentUser.email) return u; const txs=[...(u.transactions||[])]; (u.weeklyDeductions||[]).forEach(d=>txs.push({amount:-Number(d.amount), memo:`Weekly: ${d.name}`, ts:now()})); return {...u,transactions:txs}; })); notify('Applied weekly deductions'); }

      return (
        <div className="p-5 max-w-6xl mx-auto grid md:grid-cols-3 gap-5">
          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}
          {!currentUser && <div className="col-span-3 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-3">
            <h2 className="text-lg font-semibold">Login / Create User</h2>
            <input type="email" placeholder="Email" value={currentEmail} onChange={e=>setCurrentEmail(e.target.value)} className="border w-full p-2 rounded dark:bg-slate-900 dark:border-slate-700"/>
            <button className="bg-indigo-600 text-white px-4 py-2 rounded" onClick={()=>login(currentEmail,password)}>Login / Create</button>
            <button className="px-4 py-2 border rounded" onClick={()=>setTheme(theme==='dark'?'light':'dark')}>Toggle {theme==='dark'?'Light':'Dark'} Mode</button>
          </div>}
          {currentUser && (
            <>
              {isAdmin ? <AdminPanel participants={participants} onAdjust={(id,a,m)=>setParticipants(prev=>prev.map(p=>p.id===id?{...p,transactions:[...(p.transactions||[]),{amount:a,memo:m,ts:now()}]:p))} onSubscribe={id=>setParticipants(prev=>prev.map(p=>p.id===id?{...p,subscriptionActive:true}:p))} onCancel={id=>setParticipants(prev=>prev.map(p=>p.id===id?{...p,subscriptionActive:false}:p))} onDelete={id=>setParticipants(prev=>prev.filter(p=>p.id!==id))} /> : <UserPanel user={currentUser} updateUser={updateMe} applyWeeklyAll={applyMyWeeklyNow} />}
              <button className="col-span-3 mt-3 px-4 py-2 bg-slate-300 dark:bg-slate-700 rounded" onClick={logout}>Logout</button>
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>

