<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TeenBank Demo</title>
  <!-- Tailwind CDN (for quick prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel (so we can write JSX in one file) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    // TeenBank - Single-file React prototype with simulated Gmail login, admin/user profiles,
    // a shared localStorage "database", balances, weekly deductions, goals, budgets, and password login.
    // NOTE: This is FRONTEND ONLY. Real auth (OAuth 2.0) + secure database require a backend.

    const { useEffect, useMemo, useState } = React;

    const ADMIN_EMAIL = 'hasslerw748@stu.mw.k12.ny.us';

    const DEFAULT_PARTICIPANTS = [
      { id: 1, name: 'Ava',  email: 'ava@gmail.com',  subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, balance: 50,  password: '' },
      { id: 2, name: 'Ben',  email: 'ben@gmail.com',  subscriptionActive: true,  weeklyDeductions: [], goals: [], budgets: {}, balance: 75,  password: '' },
      { id: 3, name: 'Maya', email: 'maya@gmail.com', subscriptionActive: false, weeklyDeductions: [], goals: [], budgets: {}, balance: 30,  password: '' },
    ];

    const DB_KEY = 'teenbank_participants';

    function loadParticipants() {
      try {
        const stored = localStorage.getItem(DB_KEY);
        return stored ? JSON.parse(stored) : DEFAULT_PARTICIPANTS;
      } catch (e) {
        console.warn('Failed to parse participants:', e);
        return DEFAULT_PARTICIPANTS;
      }
    }

    function saveParticipants(list) {
      localStorage.setItem(DB_KEY, JSON.stringify(list));
    }

    function formatCurrency(n) {
      const num = Number(n) || 0;
      return num.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function ProgressBar({ value, max }) {
      const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
      return (
        <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
          <div className="h-2 bg-indigo-600" style={{ width: pct + '%' }} />
        </div>
      );
    }

    function AdminPanel({ participants, onUpdate, onSubscribe, onCancel, onDelete }) {
      const [search, setSearch] = useState('');

      const filtered = useMemo(() => {
        const q = search.trim().toLowerCase();
        if (!q) return participants;
        return participants.filter(p => (p.name + ' ' + p.email).toLowerCase().includes(q));
      }, [participants, search]);

      return (
        <section className="md:col-span-2 bg-white p-5 rounded-2xl shadow-sm">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold">Admin · Participant Management</h3>
            <input
              className="border rounded px-2 py-1 text-sm"
              placeholder="Search name or email"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>

          <ul className="divide-y">
            {filtered.map((p) => (
              <li key={p.id} className="py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div className="space-y-1">
                  <div className="font-medium">{p.name} <span className="text-slate-500">({p.email})</span></div>
                  <div className="text-sm text-slate-600">Balance: <strong>{formatCurrency(p.balance)}</strong></div>
                  <div className="text-xs text-slate-500">Subscription: {p.subscriptionActive ? 'Active' : 'Inactive'}</div>
                </div>
                <div className="flex flex-wrap gap-2">
                  <button className="px-3 py-1 rounded bg-indigo-600 text-white text-xs" onClick={() => onSubscribe(p.id)}>Activate</button>
                  <button className="px-3 py-1 rounded bg-rose-600 text-white text-xs" onClick={() => onCancel(p.id)}>Cancel</button>
                  <button className="px-3 py-1 rounded bg-emerald-600 text-white text-xs" onClick={() => onUpdate(p.id, { balance: p.balance + 5 })}>+ $5</button>
                  <button className="px-3 py-1 rounded bg-amber-600 text-white text-xs" onClick={() => onUpdate(p.id, { balance: Math.max(0, p.balance - 5) })}>− $5</button>
                  <button className="px-3 py-1 rounded bg-slate-200 text-slate-900 text-xs" onClick={() => onUpdate(p.id, { password: '' })}>Reset PW</button>
                  <button className="px-3 py-1 rounded bg-slate-800 text-white text-xs" onClick={() => onDelete(p.id)}>Delete</button>
                </div>
              </li>
            ))}
          </ul>
          <p className="mt-3 text-sm text-slate-500">Admin can control access, adjust balances, and manage subscriptions. Deleting removes the profile from localStorage.</p>
        </section>
      );
    }

    function UserPanel({ user, onParticipantsChange, setUser }) {
      const [balanceDelta, setBalanceDelta] = useState('');
      const [deductionName, setDeductionName] = useState('');
      const [deductionAmt, setDeductionAmt] = useState('');
      const [goalName, setGoalName] = useState('');
      const [goalTarget, setGoalTarget] = useState('');
      const [budgetCat, setBudgetCat] = useState('');
      const [budgetAmt, setBudgetAmt] = useState('');
      const [pw, setPw] = useState('');

      const updateParticipants = (updater) => {
        onParticipantsChange((prev) => {
          const next = typeof updater === 'function' ? updater(prev) : updater;
          return next;
        });
      };

      function updateBalance(delta) {
        const amount = parseFloat(delta);
        if (Number.isNaN(amount) || !Number.isFinite(amount)) return;

        updateParticipants((prev) => {
          return prev.map((u) => {
            if (u.id !== user.id) return u;

            // 1) update balance
            let newBalance = (Number(u.balance) || 0) + amount;
            if (!Array.isArray(u.goals) || u.goals.length === 0 || amount <= 0) {
              // withdraws or no goals: no auto-allocation
              return { ...u, balance: newBalance };
            }

            // 2) auto-allocate deposits to goals in order
            let remaining = amount;
            const updatedGoals = u.goals.map((g) => {
              if (remaining <= 0) return g;
              const need = Math.max(0, (Number(g.target) || 0) - (Number(g.saved) || 0));
              const contrib = Math.min(need, remaining);
              remaining -= contrib;
              return { ...g, saved: (Number(g.saved) || 0) + contrib };
            });

            return { ...u, balance: newBalance, goals: updatedGoals };
          });
        });
        setBalanceDelta('');
      }

      function addWeeklyDeduction(name, amount) {
        const amt = parseFloat(amount);
        if (!name || Number.isNaN(amt)) return;
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          const updated = { ...u };
          updated.weeklyDeductions = [...(u.weeklyDeductions || []), { name, amount: amt }];
          updated.balance = (Number(u.balance) || 0) - amt; // immediate apply, per prototype
          return updated;
        }));
        setDeductionName('');
        setDeductionAmt('');
      }

      function removeDeduction(idx) {
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          const copy = { ...u };
          copy.weeklyDeductions = [...(u.weeklyDeductions || [])];
          copy.weeklyDeductions.splice(idx, 1);
          return copy;
        }));
      }

      function addGoal(name, target) {
        const tgt = parseFloat(target);
        if (!name || Number.isNaN(tgt)) return;
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          return { ...u, goals: [...(u.goals || []), { name, target: tgt, saved: 0 }] };
        }));
        setGoalName('');
        setGoalTarget('');
      }

      function contributeToGoal(idx, amount) {
        const amt = parseFloat(amount);
        if (Number.isNaN(amt) || amt <= 0) return;
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          const goals = [...(u.goals || [])];
          const g = { ...goals[idx] };
          const maxAdd = Math.min(amt, Math.max(0, g.target - g.saved));
          if (maxAdd <= 0) return u;
          g.saved += maxAdd;
          goals[idx] = g;
          return { ...u, goals, balance: (Number(u.balance) || 0) - maxAdd };
        }));
      }

      function addBudget(cat, amt) {
        const val = parseFloat(amt);
        if (!cat || Number.isNaN(val)) return;
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          return { ...u, budgets: { ...(u.budgets || {}), [cat]: val } };
        }));
        setBudgetCat('');
        setBudgetAmt('');
      }

      function deleteBudget(cat) {
        updateParticipants((prev) => prev.map((u) => {
          if (u.id !== user.id) return u;
          const copy = { ...(u.budgets || {}) };
          delete copy[cat];
          return { ...u, budgets: copy };
        }));
      }

      function setPassword(newPw) {
        updateParticipants((prev) => prev.map((u) => (u.id === user.id ? { ...u, password: newPw } : u)));
        setUser((prev) => ({ ...prev, password: newPw }));
        setPw('');
      }

      return (
        <section className="md:col-span-2 bg-white p-5 rounded-2xl shadow-sm space-y-6">
          <div>
            <h3 className="text-lg font-semibold">Welcome, {user.name}</h3>
            <p className="text-sm text-slate-600">Balance: <strong>{formatCurrency(user.balance)}</strong></p>
          </div>

          {/* Balance update */}
          <div className="space-y-2">
            <div className="flex flex-wrap items-center gap-2">
              <input type="number" step="0.01" placeholder="Add/Subtract $" value={balanceDelta} onChange={(e) => setBalanceDelta(e.target.value)} className="border p-2 rounded w-40" />
              <button className="bg-emerald-600 text-white px-3 py-2 rounded" onClick={() => updateBalance(balanceDelta)}>Apply</button>
              <p className="text-xs text-slate-500">Positive deposits auto-allocate to goals from top to bottom.</p>
            </div>
          </div>

          {/* Weekly deductions */}
          <div>
            <h4 className="font-medium mb-2">Weekly Deductions</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded" placeholder="Name (e.g., Phone)" value={deductionName} onChange={(e) => setDeductionName(e.target.value)} />
              <input className="border p-2 rounded w-32" type="number" step="0.01" placeholder="Amount" value={deductionAmt} onChange={(e) => setDeductionAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={() => addWeeklyDeduction(deductionName, deductionAmt)}>Add & Apply</button>
            </div>
            <ul className="space-y-2">
              {(user.weeklyDeductions || []).map((d, i) => (
                <li key={i} className="flex items-center justify-between bg-slate-100 p-2 rounded">
                  <span>{d.name} — <strong>{formatCurrency(d.amount)}</strong></span>
                  <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white" onClick={() => removeDeduction(i)}>Remove</button>
                </li>
              ))}
              {(!user.weeklyDeductions || user.weeklyDeductions.length === 0) && (
                <li className="text-sm text-slate-500">No weekly deductions yet.</li>
              )}
            </ul>
          </div>

          {/* Goals */}
          <div>
            <h4 className="font-medium mb-2">Goals</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded" placeholder="Goal name (e.g., Bike)" value={goalName} onChange={(e) => setGoalName(e.target.value)} />
              <input className="border p-2 rounded w-32" type="number" step="0.01" placeholder="Target $" value={goalTarget} onChange={(e) => setGoalTarget(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={() => addGoal(goalName, goalTarget)}>Add Goal</button>
            </div>
            <div className="space-y-3">
              {(user.goals || []).map((g, idx) => {
                const saved = Number(g.saved) || 0;
                const target = Number(g.target) || 0;
                const remaining = Math.max(0, target - saved);
                const [contrib, setContrib] = React.useState('');
                return (
                  <div key={idx} className="p-3 rounded border">
                    <div className="flex items-center justify-between gap-2">
                      <div>
                        <div className="font-medium">{g.name}</div>
                        <div className="text-sm text-slate-600">{formatCurrency(saved)} / {formatCurrency(target)} <span className="text-slate-500">({formatCurrency(remaining)} left)</span></div>
                      </div>
                      <div className="flex items-center gap-2">
                        <input className="border p-1 rounded w-28" type="number" step="0.01" placeholder="$ add" value={contrib} onChange={(e) => setContrib(e.target.value)} />
                        <button className="bg-emerald-600 text-white px-3 py-1 rounded" onClick={() => { contributeToGoal(idx, contrib); setContrib(''); }}>Contribute</button>
                      </div>
                    </div>
                    <div className="mt-2"><ProgressBar value={saved} max={target} /></div>
                  </div>
                );
              })}
              {(!user.goals || user.goals.length === 0) && (
                <div className="text-sm text-slate-500">No goals yet. Add your first goal above.</div>
              )}
            </div>
          </div>

          {/* Budgets */}
          <div>
            <h4 className="font-medium mb-2">Budgets</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded" placeholder="Category (e.g., Food)" value={budgetCat} onChange={(e) => setBudgetCat(e.target.value)} />
              <input className="border p-2 rounded w-32" type="number" step="0.01" placeholder="Amount $" value={budgetAmt} onChange={(e) => setBudgetAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={() => addBudget(budgetCat, budgetAmt)}>Add/Update</button>
            </div>
            <ul className="space-y-2">
              {Object.entries(user.budgets || {}).map(([cat, amt]) => (
                <li key={cat} className="flex items-center justify-between bg-slate-100 p-2 rounded">
                  <span className="font-medium">{cat}</span>
                  <div className="flex items-center gap-3">
                    <span>{formatCurrency(amt)}</span>
                    <button className="text-xs px-2 py-1 rounded bg-slate-300" onClick={() => deleteBudget(cat)}>Delete</button>
                  </div>
                </li>
              ))}
              {Object.keys(user.budgets || {}).length === 0 && (
                <li className="text-sm text-slate-500">No budgets yet.</li>
              )}
            </ul>
          </div>

          {/* Password */}
          <div>
            <h4 className="font-medium mb-2">Password (demo)</h4>
            <div className="flex flex-wrap gap-2 items-center">
              <input className="border p-2 rounded w-64" type="password" placeholder={user.password ? 'Update password' : 'Set a password'} value={pw} onChange={(e) => setPw(e.target.value)} />
              <button className="bg-slate-800 text-white px-3 py-2 rounded" onClick={() => setPassword(pw)}>{user.password ? 'Update' : 'Set'} Password</button>
              <span className="text-xs text-slate-500">Client-side only; not secure.</span>
            </div>
          </div>
        </section>
      );
    }

    function App() {
      const [participants, setParticipants] = useState(loadParticipants);
      const [currentUser, setCurrentUser] = useState(null);
      const [message, setMessage] = useState('');

      // Login form state
      const [loginEmail, setLoginEmail] = useState('');
      const [loginPassword, setLoginPassword] = useState('');

      useEffect(() => {
        saveParticipants(participants);
      }, [participants]);

      const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

      function handleLogin() {
        const email = loginEmail.trim().toLowerCase();
        if (!email || !email.includes('@')) {
          setMessage('Please enter a valid email.');
          return;
        }
        let user = participants.find((u) => u.email.toLowerCase() === email);
        if (!user) {
          user = {
            id: Date.now(),
            name: email.split('@')[0],
            email,
            subscriptionActive: false,
            weeklyDeductions: [],
            goals: [],
            budgets: {},
            balance: 0,
            password: '',
          };
          setParticipants((prev) => [...prev, user]);
        } else if (user.password && loginPassword !== user.password) {
          setMessage('Incorrect password for existing account.');
          return;
        }
        setCurrentUser(user);
        setMessage('Logged in as ' + user.name);
        setLoginPassword('');
      }

      function logout() {
        setCurrentUser(null);
        setLoginEmail('');
        setLoginPassword('');
      }

      function simulateSubscribe(userId) {
        setParticipants((prev) => prev.map((u) => (u.id === userId ? { ...u, subscriptionActive: true } : u)));
        const u = participants.find((x) => x.id === userId);
        setMessage('Subscription activated for ' + (u?.name || 'user'));
      }

      function simulateCancel(userId) {
        setParticipants((prev) => prev.map((u) => (u.id === userId ? { ...u, subscriptionActive: false } : u)));
        const u = participants.find((x) => x.id === userId);
        setMessage('Subscription canceled for ' + (u?.name || 'user'));
      }

      function adminUpdateUser(userId, patch) {
        setParticipants((prev) => prev.map((u) => (u.id === userId ? { ...u, ...patch } : u)));
        if (currentUser && currentUser.id === userId) {
          setCurrentUser((prev) => ({ ...prev, ...patch }));
        }
      }

      function adminDeleteUser(userId) {
        if (!confirm('Delete this participant? This cannot be undone.')) return;
        setParticipants((prev) => prev.filter((u) => u.id !== userId));
        if (currentUser && currentUser.id === userId) logout();
      }

      function exportData() {
        const blob = new Blob([JSON.stringify(participants, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'teenbank_data.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function resetDemo() {
        if (!confirm('Reset demo data to defaults? This clears local changes.')) return;
        setParticipants(DEFAULT_PARTICIPANTS);
        setCurrentUser(null);
        setMessage('Demo data reset.');
      }

      // --------- RENDER ---------
      if (!currentUser) {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-6">
            <div className="bg-white max-w-md w-full rounded-2xl shadow p-6">
              <h1 className="text-2xl font-bold mb-1">TeenBank Login (Demo)</h1>
              <p className="text-sm text-slate-600 mb-4">Enter your email to simulate a Gmail login. If an existing user has a password set, you'll need it.</p>
              <label className="text-sm text-slate-700 block mb-1">Email</label>
              <input type="email" className="border w-full p-2 rounded mb-3" placeholder="you@gmail.com" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} />
              <label className="text-sm text-slate-700 block mb-1">Password (if set)</label>
              <input type="password" className="border w-full p-2 rounded mb-4" placeholder="••••••••" value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)} />
              <button className="w-full bg-indigo-600 text-white py-2 rounded" onClick={handleLogin}>Login</button>
              {message && <p className="mt-3 text-slate-600 text-sm">{message}</p>}
              <div className="mt-6 flex items-center justify-between text-xs text-slate-500">
                <button className="underline" onClick={resetDemo}>Reset demo</button>
                <button className="underline" onClick={exportData}>Export data</button>
              </div>
            </div>
            <p className="mt-6 text-xs text-slate-500">Demo only. Real Gmail login requires OAuth & a backend. Data stored in your browser's localStorage.</p>
          </div>
        );
      }

      return (
        <div className="min-h-screen p-6">
          <header className="max-w-5xl mx-auto mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold">TeenBank Dashboard</h1>
              <div className="text-sm text-slate-600">Logged in as <strong>{currentUser.name}</strong> {isAdmin && <span className="ml-1">(Admin)</span>}</div>
            </div>
            <div className="flex items-center gap-2">
              <button className="px-3 py-2 text-sm rounded bg-slate-200" onClick={exportData}>Export</button>
              <button className="px-3 py-2 text-sm rounded bg-slate-800 text-white" onClick={logout}>Logout</button>
            </div>
          </header>

          <main className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            {isAdmin ? (
              <AdminPanel
                participants={participants}
                onUpdate={adminUpdateUser}
                onSubscribe={simulateSubscribe}
                onCancel={simulateCancel}
                onDelete={adminDeleteUser}
              />
            ) : (
              <UserPanel user={currentUser} onParticipantsChange={setParticipants} setUser={setCurrentUser} />
            )}

            {/* Side panel */}
            <aside className="bg-white p-5 rounded-2xl shadow-sm space-y-4">
              <h3 className="text-lg font-semibold">Participants</h3>
              <ul className="space-y-2 max-h-[420px] overflow-auto pr-1">
                {participants.map((p) => (
                  <li key={p.id} className="flex items-center justify-between bg-slate-100 p-2 rounded">
                    <div>
                      <div className="font-medium text-sm">{p.name}</div>
                      <div className="text-xs text-slate-500">{p.email}</div>
                    </div>
                    <div className="text-xs">{formatCurrency(p.balance)}</div>
                  </li>
                ))}
              </ul>
              <div className="text-xs text-slate-500">Tip: Log in with <span className="font-mono">{ADMIN_EMAIL}</span> to see the admin view.</div>
            </aside>
          </main>

          <footer className="max-w-5xl mx-auto mt-8 text-sm text-slate-500">
            Demo only. Real auth, multi-user persistence, and payment logic require a backend/API. This prototype stores data in localStorage.
          </footer>

          {message && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white text-sm px-3 py-2 rounded">
              {message}
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
