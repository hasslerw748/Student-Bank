import React, { useMemo, useState } from "react";

// TeenBank – very base website (React, plain JS)
// - In‑memory data only (no backend)
// - Flows: Onboarding, Accounts, Transactions, Recurring, Budgets, Statements
// - No timing, no auth, no leaderboard
// - Minimal but clean UI using Tailwind classes (provided by the preview runtime)

// -------------------- In‑Memory Store --------------------
let __id = 0;
const uid = (p = "id") => `${p}_${++__id}`;
const toMonthKey = (d) => `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, "0")}`;

const initialUser = {
  id: uid("user"),
  name: "Will Hassler",
  email: "will@example.com",
  onboarding: { step: "start", checklist: {} },
};

const initialState = {
  users: [initialUser],
  accounts: [
    { id: uid("acct"), userId: initialUser.id, name: "Checking", currency: "USD", createdAt: new Date() },
  ],
  transactions: [],
  recurring: [],
  budgets: [],
  classes: [
    { id: uid("class"), name: "Financial Literacy 101", code: "FL101" },
    { id: uid("class"), name: "Smart Budgeting", code: "BUDGET" },
  ],
  classMemberships: [],
};

function clone(x){ return JSON.parse(JSON.stringify(x)); }

function addDays(date, days){ const d = new Date(date); d.setUTCDate(d.getUTCDate() + days); return d; }
function addMonths(date, months){ const d = new Date(date); d.setUTCMonth(d.getUTCMonth() + months); return d; }
function advance(freq, from){
  switch (freq) {
    case "daily": return addDays(from, 1);
    case "weekly": return addDays(from, 7);
    case "biweekly": return addDays(from, 14);
    case "monthly": return addMonths(from, 1);
    case "quarterly": return addMonths(from, 3);
    default: return from;
  }
}

// -------------------- Domain Helpers --------------------
function getBalance(state, accountId){
  return state.transactions
    .filter(t => t.accountId === accountId)
    .reduce((sum, t) => sum + (t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? t.amountMinor : -t.amountMinor), 0);
}

function currencyFmt(minor, ccy = "USD"){ return new Intl.NumberFormat(undefined, { style: "currency", currency: ccy }).format((minor ?? 0)/100); }

// -------------------- UI Building Blocks --------------------
const Card = ({ title, children, footer, className = "" }) => (
  <div className={`rounded-2xl shadow p-4 bg-white/5 border border-white/10 ${className}`}>
    {title && <div className="text-lg font-semibold mb-2">{title}</div>}
    <div className="text-sm">{children}</div>
    {footer && <div className="mt-3 pt-3 border-t border-white/10 text-xs opacity-80">{footer}</div>}
  </div>
);

const Field = ({ label, children }) => (
  <label className="block mb-3">
    <div className="mb-1 text-xs uppercase tracking-wide opacity-80">{label}</div>
    {children}
  </label>
);

const Button = ({ children, onClick, className = "", type = "button" }) => (
  <button type={type} onClick={onClick} className={`px-3 py-2 rounded-xl shadow hover:shadow-md bg-white/10 border border-white/15 text-sm ${className}`}>{children}</button>
);

const Tab = ({ active, onClick, children }) => (
  <button onClick={onClick} className={`px-3 py-2 rounded-xl text-sm ${active ? "bg-white/15 border border-white/20" : "hover:bg-white/10"}`}>{children}</button>
);

// -------------------- Feature Panels --------------------
function Onboarding({ state, setState }){
  const user = state.users[0];
  const steps = ["start","verify_identity","connect_parent","create_account","set_budgets","done"];
  const idx = steps.indexOf(user.onboarding.step);
  const next = () => {
    const nextStep = steps[Math.min(idx + 1, steps.length - 1)];
    const copy = clone(state);
    copy.users[0].onboarding.step = nextStep;
    setState(copy);
  };
  return (
    <Card title="Onboarding">
      <div className="space-y-3">
        <div>Current step: <span className="font-semibold">{user.onboarding.step}</span></div>
        <div className="flex gap-2 flex-wrap">
          {steps.map((s, i) => (
            <div key={s} className={`px-2 py-1 rounded ${i <= idx ? "bg-green-500/20" : "bg-white/10"}`}>{s}</div>
          ))}
        </div>
        {user.onboarding.step !== "done" ? (
          <Button onClick={next}>Continue</Button>
        ) : (
          <div className="text-green-400">Onboarding complete ✔</div>
        )}
      </div>
    </Card>
  );
}

function Classes({ state, setState }){
  const user = state.users[0];
  const [code, setCode] = useState("");
  const [status, setStatus] = useState(null);

  const join = () => {
    const trimmed = code.trim().toUpperCase();
    if (!trimmed) {
      setStatus({ type: "error", message: "Enter a class code to join." });
      return;
    }
    const cls = state.classes.find(c => c.code.toUpperCase() === trimmed);
    if (!cls) {
      setStatus({ type: "error", message: "We couldn't find a class with that code." });
      return;
    }
    const already = state.classMemberships.some(m => m.classId === cls.id && m.userId === user.id);
    if (already) {
      setStatus({ type: "info", message: `You're already enrolled in ${cls.name}.` });
      return;
    }
    const copy = clone(state);
    copy.classMemberships.push({ id: uid("membership"), classId: cls.id, userId: user.id, joinedAt: new Date() });
    setState(copy);
    setCode("");
    setStatus({ type: "success", message: `Welcome to ${cls.name}!` });
  };

  const classesWithMembers = state.classes.map(cls => ({
    ...cls,
    members: state.classMemberships
      .filter(m => m.classId === cls.id)
      .map(m => state.users.find(u => u.id === m.userId))
      .filter(Boolean),
  }));

  const statusColor = status?.type === "success" ? "text-green-300" : status?.type === "error" ? "text-red-300" : "text-blue-200";

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="Join a Class">
        <Field label="Class Code">
          <input value={code} onChange={e=>setCode(e.target.value)} placeholder="FL101" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15 uppercase tracking-wide"/>
        </Field>
        <Button onClick={join}>Join Class</Button>
        {status && <div className={`mt-3 text-sm ${statusColor}`}>{status.message}</div>}
      </Card>

      <Card title="Class Directory" footer="Admin view of available classes and current members.">
        <div className="space-y-3 max-h-80 overflow-auto pr-1">
          {classesWithMembers.map(cls => (
            <div key={cls.id} className="bg-white/5 rounded-xl p-3">
              <div className="flex items-center justify-between mb-2">
                <div>
                  <div className="font-semibold">{cls.name}</div>
                  <div className="text-xs opacity-70">Code: {cls.code}</div>
                </div>
                <div className="text-xs opacity-70">{cls.members.length} member{cls.members.length === 1 ? "" : "s"}</div>
              </div>
              {cls.members.length > 0 ? (
                <ul className="list-disc ml-5 space-y-1 text-sm">
                  {cls.members.map(m => (
                    <li key={m.id}>{m.name}</li>
                  ))}
                </ul>
              ) : (
                <div className="text-xs opacity-70">No students joined yet.</div>
              )}
            </div>
          ))}
          {classesWithMembers.length === 0 && <div className="opacity-70">No classes have been created.</div>}
        </div>
      </Card>
    </div>
  );
}

function Accounts({ state, setState }){
  const user = state.users[0];
  const accts = state.accounts.filter(a => a.userId === user.id);
  const [name, setName] = useState("");
  const [ccy, setCcy] = useState("USD");

  const create = () => {
    if (!name.trim()) return;
    const copy = clone(state);
    copy.accounts.push({ id: uid("acct"), userId: user.id, name, currency: ccy, createdAt: new Date() });
    setState(copy); setName("");
  };

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="Your Accounts">
        <div className="space-y-2">
          {accts.map(a => (
            <div key={a.id} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
              <div>
                <div className="font-medium">{a.name}</div>
                <div className="text-xs opacity-70">{a.currency}</div>
              </div>
              <div className="font-semibold">{currencyFmt(getBalance(state, a.id), a.currency)}</div>
            </div>
          ))}
          {accts.length === 0 && <div className="opacity-70">No accounts yet.</div>}
        </div>
      </Card>

      <Card title="Open Account">
        <Field label="Name">
          <input value={name} onChange={e=>setName(e.target.value)} placeholder="Savings" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/>
        </Field>
        <Field label="Currency">
          <select value={ccy} onChange={e=>setCcy(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">
            {["USD","EUR","GBP","CHF","CAD","AUD"].map(x=> <option key={x} value={x}>{x}</option>)}
          </select>
        </Field>
        <Button onClick={create}>Create</Button>
      </Card>
    </div>
  );
}

function Transactions({ state, setState }){
  const user = state.users[0];
  const accts = state.accounts.filter(a => a.userId === user.id);
  const [accountId, setAccountId] = useState(accts[0]?.id);
  const [amount, setAmount] = useState("");
  const [desc, setDesc] = useState("");
  const [category, setCategory] = useState("other");

  const post = (kind) => {
    if (!accountId) return;
    const cents = Math.round(parseFloat(amount || "0") * 100);
    if (!(cents > 0)) return;
    const copy = clone(state);
    copy.transactions.push({
      id: uid("tx"), accountId, type: kind, amountMinor: cents, description: desc || (kind === "deposit" ? "Deposit" : "Withdrawal"), category: (kind === "deposit" ? "income" : category), createdAt: new Date()
    });
    setState(copy); setAmount(""); setDesc("");
  };

  const list = state.transactions
    .filter(t => !accountId || t.accountId === accountId)
    .slice(-50)
    .reverse();

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="New Transaction">
        <Field label="Account">
          <select value={accountId} onChange={e=>setAccountId(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">
            {accts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
          </select>
        </Field>
        <Field label="Amount">
          <input value={amount} onChange={e=>setAmount(e.target.value)} placeholder="12.34" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/>
        </Field>
        <Field label="Description">
          <input value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Groceries" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/>
        </Field>
        <Field label="Category (for withdrawals)">
          <select value={category} onChange={e=>setCategory(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">
            {["savings","food","transport","shopping","entertainment","school","fees","other"].map(x=> <option key={x} value={x}>{x}</option>)}
          </select>
        </Field>
        <div className="flex gap-2">
          <Button onClick={()=>post("deposit")}>Deposit</Button>
          <Button onClick={()=>post("withdrawal")} className="">Withdraw</Button>
        </div>
      </Card>

      <Card title="Recent Activity">
        <div className="space-y-2 max-h-80 overflow-auto pr-1">
          {list.map(t => (
            <div key={t.id} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
              <div>
                <div className="font-medium">{t.description}</div>
                <div className="text-xs opacity-70">{new Date(t.createdAt).toLocaleString()} · {t.category || "—"}</div>
              </div>
              <div className={`font-semibold ${t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? "text-green-400" : "text-red-300"}`}>
                {t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? "+" : "-"}{currencyFmt(t.amountMinor)}
              </div>
            </div>
          ))}
          {list.length === 0 && <div className="opacity-70">No transactions yet.</div>}
        </div>
      </Card>
    </div>
  );
}

function Recurring({ state, setState }){
  const user = state.users[0];
  const accts = state.accounts.filter(a => a.userId === user.id);
  const [accountId, setAccountId] = useState(accts[0]?.id);
  const [name, setName] = useState("");
  const [sign, setSign] = useState("+");
  const [amount, setAmount] = useState("");
  const [freq, setFreq] = useState("weekly");
  const [nextRun, setNextRun] = useState(() => new Date().toISOString().slice(0,10));
  const [category, setCategory] = useState("other");

  const add = () => {
    const cents = Math.round(parseFloat(amount || "0")*100);
    if (!accountId || !name.trim() || !(cents>0)) return;
    const copy = clone(state);
    copy.recurring.push({ id: uid("rc"), userId: user.id, accountId, name, sign, amountMinor: cents, frequency: freq, nextRun: new Date(nextRun), category, active: true });
    setState(copy); setName(""); setAmount("");
  };

  const runDue = () => {
    const now = new Date();
    const copy = clone(state);
    for (const r of copy.recurring) {
      if (!r.active) continue;
      while (new Date(r.nextRun) <= now) {
        if (r.sign === "+") {
          copy.transactions.push({ id: uid("tx"), accountId: r.accountId, type: "deposit", amountMinor: r.amountMinor, description: r.name, category: r.category || "income", createdAt: new Date() });
        } else {
          copy.transactions.push({ id: uid("tx"), accountId: r.accountId, type: "withdrawal", amountMinor: r.amountMinor, description: r.name, category: r.category || "other", createdAt: new Date() });
        }
        r.nextRun = advance(r.frequency, new Date(r.nextRun));
      }
    }
    setState(copy);
  };

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title="Add Recurring">
        <Field label="Account">
          <select value={accountId} onChange={e=>setAccountId(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">
            {accts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
          </select>
        </Field>
        <div className="grid grid-cols-2 gap-3">
          <Field label="Name"><input value={name} onChange={e=>setName(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/></Field>
          <Field label="Amount"><input value={amount} onChange={e=>setAmount(e.target.value)} placeholder="25.00" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/></Field>
          <Field label="Type"><select value={sign} onChange={e=>setSign(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"><option value="+">Income (+)</option><option value="-">Expense (-)</option></select></Field>
          <Field label="Frequency"><select value={freq} onChange={e=>setFreq(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">{["daily","weekly","biweekly","monthly","quarterly"].map(x=> <option key={x} value={x}>{x}</option>)}</select></Field>
          <Field label="Next Run"><input type="date" value={nextRun} onChange={e=>setNextRun(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/></Field>
          <Field label="Category"><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">{["income","savings","food","transport","shopping","entertainment","school","fees","other"].map(x=> <option key={x} value={x}>{x}</option>)}</select></Field>
        </div>
        <div className="flex gap-2">
          <Button onClick={add}>Add</Button>
          <Button onClick={runDue}>Post Due Items</Button>
        </div>
      </Card>

      <Card title="Existing Rules">
        <div className="space-y-2 max-h-80 overflow-auto pr-1">
          {state.recurring.filter(r => r.userId === user.id).map(r => (
            <div key={r.id} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
              <div>
                <div className="font-medium">{r.name}</div>
                <div className="text-xs opacity-70">{r.sign}{currencyFmt(r.amountMinor)} · {r.frequency} · next {new Date(r.nextRun).toLocaleDateString()}</div>
              </div>
              <div className="text-xs opacity-70">{state.accounts.find(a=>a.id===r.accountId)?.name}</div>
            </div>
          ))}
          {state.recurring.length === 0 && <div className="opacity-70">No recurring rules.</div>}
        </div>
      </Card>
    </div>
  );
}

function Budgets({ state, setState }){
  const user = state.users[0];
  const month = toMonthKey(new Date());
  const existing = state.budgets.find(b => b.userId === user.id && b.month === month);
  const [food, setFood] = useState((existing?.limitsMinor?.food ?? 0)/100 || "");
  const [transport, setTransport] = useState((existing?.limitsMinor?.transport ?? 0)/100 || "");

  const upsert = () => {
    const copy = clone(state);
    let b = copy.budgets.find(x => x.userId === user.id && x.month === month);
    if (!b) { b = { id: uid("bdg"), userId: user.id, month, currency: "USD", limitsMinor: {}, alerts: [] }; copy.budgets.push(b); }
    if (food) b.limitsMinor.food = Math.round(parseFloat(food)*100);
    if (transport) b.limitsMinor.transport = Math.round(parseFloat(transport)*100);
    setState(copy);
  };

  const spend = useMemo(() => {
    const copy = { income:0,savings:0,food:0,transport:0,shopping:0,entertainment:0,school:0,fees:0,other:0 };
    const [y,m] = month.split("-").map(Number);
    const start = new Date(Date.UTC(y, m-1, 1));
    const end = new Date(Date.UTC(y, m, 1));
    for (const t of state.transactions) {
      if (!(t.createdAt && new Date(t.createdAt) >= start && new Date(t.createdAt) < end)) continue;
      const isExpense = t.type === "withdrawal" || t.type === "transfer_out" || t.type === "fee";
      if (isExpense) copy[t.category || "other"] += t.amountMinor;
    }
    return copy;
  }, [state.transactions]);

  const alerts = useMemo(() => {
    const b = state.budgets.find(x => x.userId === user.id && x.month === month);
    if (!b) return [];
    const out = [];
    for (const [cat, limit] of Object.entries(b.limitsMinor || {})){
      const spent = (spend[cat]||0);
      if (!limit || limit <= 0) continue;
      const pct = (spent/limit)*100;
      if (pct >= 100) out.push(`${cat} budget exceeded`);
      else if (pct >= 80) out.push(`${cat} hit 80% of budget`);
      else if (pct >= 50) out.push(`${cat} hit 50% of budget`);
    }
    return out;
  }, [state.budgets, state.transactions]);

  return (
    <div className="grid md:grid-cols-2 gap-4">
      <Card title={`Set Budgets (${month})`}>
        <div className="grid grid-cols-2 gap-3">
          <Field label="Food ($)"><input value={food} onChange={e=>setFood(e.target.value)} placeholder="80" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/></Field>
          <Field label="Transport ($)"><input value={transport} onChange={e=>setTransport(e.target.value)} placeholder="40" className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15"/></Field>
        </div>
        <div className="mt-2"><Button onClick={upsert}>Save Budgets</Button></div>
      </Card>

      <Card title="This Month">
        <div className="space-y-2">
          {Object.entries(spend).map(([k,v]) => (
            <div key={k} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
              <div className="capitalize">{k}</div>
              <div>{currencyFmt(v)}</div>
            </div>
          ))}
          {alerts.length>0 && (
            <div className="mt-2 p-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30">
              <div className="font-medium mb-1">Alerts</div>
              <ul className="list-disc ml-5 space-y-1 text-sm">
                {alerts.map((a,i)=>(<li key={i}>{a}</li>))}
              </ul>
            </div>
          )}
        </div>
      </Card>
    </div>
  );
}

function Statements({ state }){
  const user = state.users[0];
  const accts = state.accounts.filter(a => a.userId === user.id);
  const [accountId, setAccountId] = useState(accts[0]?.id);
  const month = toMonthKey(new Date());
  const [y, m] = month.split("-").map(Number);
  const from = new Date(Date.UTC(y, m-1, 1));
  const to = new Date(Date.UTC(y, m, 1));

  const tx = state.transactions
    .filter(t => (!accountId || t.accountId === accountId) && new Date(t.createdAt) >= from && new Date(t.createdAt) < to)
    .sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));

  const opening = state.transactions
    .filter(t => (!accountId || t.accountId === accountId) && new Date(t.createdAt) < from)
    .reduce((sum,t)=> sum + (t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? t.amountMinor : -t.amountMinor), 0);
  const closing = opening + tx.reduce((sum,t)=> sum + (t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? t.amountMinor : -t.amountMinor), 0);

  return (
    <Card title="Monthly Statement">
      <Field label="Account">
        <select value={accountId} onChange={e=>setAccountId(e.target.value)} className="w-full px-3 py-2 rounded-xl bg-white/10 border border-white/15">
          {accts.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
        </select>
      </Field>
      <div className="text-sm opacity-80 mb-2">Period: {from.toISOString().slice(0,10)} → {to.toISOString().slice(0,10)}</div>
      <div className="grid grid-cols-2 gap-3 mb-3">
        <Card title="Opening" className=""><div className="text-xl font-semibold">{currencyFmt(opening)}</div></Card>
        <Card title="Closing" className=""><div className="text-xl font-semibold">{currencyFmt(closing)}</div></Card>
      </div>
      <div className="space-y-2 max-h-80 overflow-auto pr-1">
        {tx.map(t => (
          <div key={t.id} className="flex items-center justify-between bg-white/5 rounded-xl p-2">
            <div>
              <div className="font-medium">{t.description}</div>
              <div className="text-xs opacity-70">{new Date(t.createdAt).toLocaleString()} · {t.category || "—"}</div>
            </div>
            <div className={`font-semibold ${t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? "text-green-400" : "text-red-300"}`}>
              {t.type === "deposit" || t.type === "transfer_in" || t.type === "interest" ? "+" : "-"}{currencyFmt(t.amountMinor)}
            </div>
          </div>
        ))}
        {tx.length===0 && <div className="opacity-70">No activity this period.</div>}
      </div>
    </Card>
  );
}

// -------------------- App Shell --------------------
function Tabs({ tab, setTab }){
  const items = ["Onboarding","Classes","Accounts","Transactions","Recurring","Budgets","Statements"];
  return (
    <div className="flex flex-wrap gap-2 mb-4">
      {items.map(name => (
        <Tab key={name} active={tab===name} onClick={()=>setTab(name)}>{name}</Tab>
      ))}
    </div>
  );
}

export default function TeenBankApp(){
  const [state, setState] = useState(initialState);
  const [tab, setTab] = useState("Onboarding");

  return (
    <div className="min-h-screen text-white p-4 md:p-8 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
      <div className="max-w-5xl mx-auto">
        <header className="mb-6 flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">TeenBank</h1>
            <p className="text-sm opacity-80">Very base website model · in‑memory</p>
          </div>
        </header>

        <Tabs tab={tab} setTab={setTab} />

        {tab === "Onboarding" && <Onboarding state={state} setState={setState} />}
        {tab === "Classes" && <Classes state={state} setState={setState} />}
        {tab === "Accounts" && <Accounts state={state} setState={setState} />}
        {tab === "Transactions" && <Transactions state={state} setState={setState} />}
        {tab === "Recurring" && <Recurring state={state} setState={setState} />}
        {tab === "Budgets" && <Budgets state={state} setState={setState} />}
        {tab === "Statements" && <Statements state={state} />}

        <footer className="mt-8 text-xs opacity-70">© {new Date().getFullYear()} TeenBank (prototype)</footer>
      </div>
    </div>
  );
}
