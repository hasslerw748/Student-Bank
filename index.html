<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Banking</title>

  <!-- Tailwind -->
  <script>window.tailwind = { config: { darkMode: false } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat SDKs (works in simple script tags) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
  </style>
</head>

<body class="h-full bg-white text-slate-900">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ---------------- FIREBASE CONFIG (YOUR PROJECT) ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyD7jHtDJI3IWHY0hfxc0UP4BDg8O0X5jWs",
      authDomain: "student-banking-3c89e.firebaseapp.com",
      projectId: "student-banking-3c89e",
      storageBucket: "student-banking-3c89e.firebasestorage.app",
      messagingSenderId: "230255175950",
      appId: "1:230255175950:web:e4d9668becd67e5bf4cf5f",
      measurementId: "G-2T7F6P5FFV"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---------------- HELPERS ----------------
    const ADMIN_CODE = "teacher123"; // change this for your class

    function makeAlias() {
      const words = ["Otter", "Hawk", "Wolf", "Lynx", "Raven", "Falcon", "Cedar", "Maple", "Bison", "Heron"];
      const w = words[Math.floor(Math.random() * words.length)];
      const num = Math.floor(1000 + Math.random() * 9000);
      return `${w}-${num}`;
    }

    function fmtUSD(n) {
      return (Number(n) || 0).toLocaleString(undefined, { style: "currency", currency: "USD" });
    }

    function computeBalance(profile) {
      const tx = Array.isArray(profile.transactions) ? profile.transactions : [];
      return tx.reduce((sum, t) => sum + Number(t.amount || 0), 0);
    }

    function Toast({ text, onClose }) {
      useEffect(() => {
        const t = setTimeout(onClose, 1800);
        return () => clearTimeout(t);
      }, [onClose]);
      return (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-800 text-white text-sm px-3 py-2 rounded shadow-lg">
          {text}
        </div>
      );
    }

    // ---------------- MAIN APP ----------------
    function App() {
      const [profile, setProfile] = useState(null);
      const [uid, setUid] = useState(null);
      const [loading, setLoading] = useState(true);
      const [initError, setInitError] = useState("");
      const [toast, setToast] = useState(null);

      const [isAdmin, setIsAdmin] = useState(false);
      const [adminCodeInput, setAdminCodeInput] = useState("");
      const [roster, setRoster] = useState([]);

      // sign in anonymously and create profile if needed
      useEffect(() => {
        (async () => {
          try {
            const cred = await auth.signInAnonymously();
            const u = cred.user;
            setUid(u.uid);

            const ref = db.collection("profiles").doc(u.uid);
            const snap = await ref.get();

            if (!snap.exists) {
              await ref.set({
                uid: u.uid,
                alias: makeAlias(),
                classCode: null,
                transactions: [],
                weekly: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }

            // subscribe to my profile document
            ref.onSnapshot(doc => {
              if (doc.exists) setProfile(doc.data());
            });

            setLoading(false);
          } catch (err) {
            console.error(err);
            setInitError(err.message || "Error connecting to database.");
            setLoading(false);
          }
        })();
      }, []);

      // simple notifications
      function notify(msg) {
        setToast(msg);
      }

      // ----- student actions -----
      async function addTx(amount, memo) {
        if (!uid) return;
        const n = Number(amount);
        if (!n) return;
        const ref = db.collection("profiles").doc(uid);
        await ref.update({
          transactions: firebase.firestore.FieldValue.arrayUnion({
            amount: n,
            memo: memo || null,
            ts: Date.now()
          })
        });
      }

      async function undoLast() {
        if (!uid || !profile || !profile.transactions?.length) return;
        const arr = [...profile.transactions];
        arr.pop();
        await db.collection("profiles").doc(uid).update({ transactions: arr });
      }

      async function joinClass(code) {
        if (!uid) return;
        const clean = String(code || "").trim();
        if (!clean) return;
        await db.collection("profiles").doc(uid).update({ classCode: clean });
        notify("Joined class " + clean);
      }

      // ----- admin view -----
      async function tryAdmin() {
        if (adminCodeInput.trim() === ADMIN_CODE) {
          setIsAdmin(true);
          // load all profiles (rules must allow read; for testing use simple rules)
          db.collection("profiles").onSnapshot(snap => {
            const list = [];
            snap.forEach(d => list.push(d.data()));
            setRoster(list);
          });
          notify("Admin view enabled");
        } else {
          notify("Wrong admin code");
        }
      }

      const balance = useMemo(() => profile ? computeBalance(profile) : 0, [profile]);

      // ----- UI STATES -----
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-white">
            <div className="bg-white border border-blue-100 rounded-2xl p-6 shadow">
              <h1 className="text-2xl font-bold text-blue-800 mb-2">Student Banking</h1>
              <p className="text-sm text-slate-600">Creating your private account…</p>
            </div>
          </div>
        );
      }

      if (initError) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-white">
            <div className="bg-white border border-red-200 rounded-2xl p-6 shadow">
              <h1 className="text-2xl font-bold text-blue-800 mb-2">Student Banking</h1>
              <p className="text-sm text-red-600">
                Error talking to Firebase: {initError}
              </p>
              <p className="text-xs text-slate-500 mt-2">
                Double-check: Anonymous auth is enabled, Firestore is in Native mode, and rules allow read/write for signed-in users.
              </p>
            </div>
          </div>
        );
      }

      if (!profile) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-white">
            <div className="bg-white border border-blue-100 rounded-2xl p-6 shadow">
              <h1 className="text-2xl font-bold text-blue-800 mb-2">Student Banking</h1>
              <p className="text-sm text-slate-600">Loading your account…</p>
            </div>
          </div>
        );
      }

      // ----- MAIN DASHBOARD -----
      return (
        <div className="min-h-screen bg-white p-6">
          <header className="max-w-5xl mx-auto mb-6 flex items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-blue-800">Student Banking Dashboard</h1>
              <p className="text-sm text-slate-600">
                Alias: <strong>{profile.alias}</strong>{" "}
                · ID …{String(profile.uid || uid).slice(-6)}{" "}
                · Class: {profile.classCode || "none"}
              </p>
              <p className="text-xs text-slate-500">
                No names, emails, or birthdays are stored — only this alias.
              </p>
            </div>

            <div className="flex flex-col items-end gap-2">
              {!isAdmin && (
                <div className="flex gap-1 items-center">
                  <input
                    className="border border-blue-200 rounded px-2 py-1 text-xs"
                    placeholder="Admin code"
                    value={adminCodeInput}
                    onChange={e => setAdminCodeInput(e.target.value)}
                  />
                  <button
                    className="bg-blue-600 text-white px-2 py-1 rounded text-xs"
                    onClick={tryAdmin}
                  >
                    Admin
                  </button>
                </div>
              )}
              {isAdmin && (
                <span className="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs border border-blue-200">
                  Admin view
                </span>
              )}
            </div>
          </header>

          <main className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* Student panel */}
            <section className="md:col-span-2 bg-white border border-blue-100 rounded-2xl p-5 shadow-sm space-y-6">
              {/* Balance */}
              <div>
                <h2 className="text-lg font-semibold text-blue-800 mb-1">Your Account</h2>
                <p className="text-sm text-slate-700">
                  Balance: <strong>{fmtUSD(balance)}</strong>
                </p>
              </div>

              {/* Class join */}
              <ClassJoin onJoin={joinClass} current={profile.classCode} />

              {/* Transactions */}
              <Transactions profile={profile} onAdd={addTx} onUndo={undoLast} />

              {/* Simple note */}
              <div className="text-xs text-slate-500">
                Tip: Use this to track class rewards, fines, or savings. Everything is tied to your alias, so it works on any device.
              </div>
            </section>

            {/* Admin / side panel */}
            <aside className="bg-white border border-blue-100 rounded-2xl p-5 shadow-sm space-y-4">
              <h2 className="text-lg font-semibold text-blue-800">Info</h2>
              <p className="text-xs text-slate-600">
                This site only stores:
                <br />• Random alias
                <br />• Class code
                <br />• Fake bank amounts/transactions
              </p>
              <p className="text-xs text-slate-600">
                Teachers can enter the admin code to see a roster of aliases and balances. No identifying info is shown.
              </p>

              {isAdmin && (
                <AdminRoster roster={roster} />
              )}
            </aside>
          </main>

          {toast && <Toast text={toast} onClose={() => setToast(null)} />}
        </div>
      );
    }

    // ------------- Subcomponents -------------

    function ClassJoin({ onJoin, current }) {
      const [code, setCode] = useState("");

      return (
        <div className="p-3 rounded-2xl border border-blue-100 bg-blue-50/40 flex flex-wrap items-center gap-2">
          <span className="text-sm text-blue-900">Join / change class code:</span>
          <input
            className="border border-blue-200 rounded px-2 py-1 text-sm w-28"
            placeholder="e.g. 1A"
            value={code}
            onChange={e => setCode(e.target.value)}
          />
          <button
            className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm"
            onClick={() => { if (code.trim()) { onJoin(code); setCode(""); } }}
          >
            Save
          </button>
          <span className="text-xs text-slate-500">
            Current: {current || "none"}
          </span>
        </div>
      );
    }

    function Transactions({ profile, onAdd, onUndo }) {
      const [amount, setAmount] = useState("");
      const [memo, setMemo] = useState("");

      const list = (profile.transactions || []).slice().reverse();

      function add(deltaSign) {
        const n = parseFloat(amount);
        if (Number.isNaN(n) || n <= 0) return;
        const val = deltaSign * n;
        onAdd(val, memo || (val > 0 ? "Deposit" : "Withdraw"));
        setAmount("");
        setMemo("");
      }

      return (
        <div className="space-y-2">
          <h3 className="font-medium text-blue-800">Transactions</h3>
          <div className="flex flex-wrap gap-2 items-center">
            <input
              type="number"
              step="0.01"
              className="border border-blue-200 rounded px-2 py-1 text-sm w-24"
              placeholder="$"
              value={amount}
              onChange={e => setAmount(e.target.value)}
            />
            <input
              type="text"
              className="border border-blue-200 rounded px-2 py-1 text-sm w-40"
              placeholder="Memo (optional)"
              value={memo}
              onChange={e => setMemo(e.target.value)}
            />
            <button
              className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm"
              onClick={() => add(+1)}
            >
              Deposit
            </button>
            <button
              className="bg-blue-800 text-white px-3 py-1.5 rounded text-sm"
              onClick={() => add(-1)}
            >
              Withdraw
            </button>
            <button
              className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1.5 rounded text-xs"
              onClick={onUndo}
            >
              Undo last
            </button>
          </div>

          <ul className="mt-2 max-h-56 overflow-y-auto border border-blue-100 rounded bg-white divide-y divide-blue-50">
            {list.length === 0 && (
              <li className="p-2 text-xs text-slate-500">No transactions yet.</li>
            )}
            {list.map((t, i) => (
              <li key={i} className="p-2 flex items-center justify-between text-xs">
                <span>
                  {new Date(t.ts || Date.now()).toLocaleString()} — {t.memo || "—"}
                </span>
                <span className={t.amount >= 0 ? "text-green-700 font-semibold" : "text-red-700 font-semibold"}>
                  {t.amount >= 0 ? "+" : ""}{Number(t.amount).toFixed(2)}
                </span>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function AdminRoster({ roster }) {
      const sorted = [...roster].sort((a, b) => {
        const ca = a.classCode || "";
        const cb = b.classCode || "";
        if (ca === cb) return (a.alias || "").localeCompare(b.alias || "");
        return ca.localeCompare(cb);
      });

      return (
        <div className="mt-2 border border-blue-100 rounded-2xl p-3 bg-blue-50/40">
          <h3 className="font-semibold text-blue-800 text-sm mb-2">Roster (aliases only)</h3>
          <div className="max-h-64 overflow-y-auto space-y-1 text-[10px]">
            {sorted.length === 0 && (
              <div className="text-slate-500">No students yet.</div>
            )}
            {sorted.map(p => (
              <div key={p.uid} className="flex justify-between gap-2">
                <span>
                  {p.classCode || "—"} · {p.alias} · …{String(p.uid).slice(-4)}
                </span>
                <span>{fmtUSD(computeBalance(p))}</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ---------------- RENDER ----------------
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
