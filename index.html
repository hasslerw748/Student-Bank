<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Banking — Username/Password + Class Join</title>

  <script>window.tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 (UMD) + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ------------------- Constants & helpers -------------------
    const ADMIN_USERNAME = 'admin';
    const ADMIN_DEFAULT_PASSWORD = 'admin123';

    const DB_KEY = 'teenbank_participants_v4';   // participants/users
    const CLASSES_KEY = 'teenbank_classes_v2';   // classes store
    const THEME_KEY = 'teenbank_theme';

    const DEFAULT_PARTICIPANTS = [];

    function fmtUSD(n){ return (Number(n)||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    const now = () => Date.now();

    function computeBalance(user){
      const tx = user.transactions || [];
      return tx.reduce((s,t)=> s + Number(t.amount||0), 0);
    }

    // --- simple hashing (demo) ---
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function randomSalt(len=16){
      const arr = new Uint8Array(len); crypto.getRandomValues(arr);
      return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // ------------------- Storage + migration -------------------
    function migrateParticipants(raw){
      const list = raw ? JSON.parse(raw) : DEFAULT_PARTICIPANTS;
      return list.map(u => ({
        id: u.id ?? Date.now(),
        username: u.username ?? (u.name ? String(u.name).toLowerCase().replace(/\s+/g,'') : 'user'+Math.floor(Math.random()*1e6)),
        name: u.name ?? (u.username ?? 'User'),
        salt: u.salt ?? null,
        passwordHash: u.passwordHash ?? null,
        subscriptionActive: !!u.subscriptionActive,
        weeklyDeductions: Array.isArray(u.weeklyDeductions) ? u.weeklyDeductions : [],
        goals: Array.isArray(u.goals) ? u.goals : [],
        budgets: typeof u.budgets === 'object' && u.budgets ? u.budgets : {},
        transactions: Array.isArray(u.transactions) ? u.transactions : [],
      }));
    }

    function loadParticipants(){
      try {
        const stored = localStorage.getItem(DB_KEY);
        const arr = migrateParticipants(stored);
        // Ensure admin exists
        if (!arr.find(u => u.username === ADMIN_USERNAME)) {
          arr.push({
            id: Date.now(),
            username: ADMIN_USERNAME,
            name: 'Admin',
            salt: null,
            passwordHash: null,
            subscriptionActive: false,
            weeklyDeductions: [],
            goals: [],
            budgets: {},
            transactions: [],
          });
        }
        return arr;
      } catch (e){ console.warn('Load fail, using defaults', e); return migrateParticipants(); }
    }
    const saveParticipants = (list) => localStorage.setItem(DB_KEY, JSON.stringify(list));

    function loadClasses(){
      try {
        const raw = localStorage.getItem(CLASSES_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return arr.map(c => ({ id: String(c.id), title: c.title || null, members: Array.isArray(c.members)? c.members: [] }));
      } catch(e){ return []; }
    }
    const saveClasses = (list) => localStorage.setItem(CLASSES_KEY, JSON.stringify(list));

    // ------------------- UI primitives -------------------
    function Toast({ text, onClose }){
      useEffect(() => { const t = setTimeout(onClose, 1800); return () => clearTimeout(t); }, [onClose]);
      return <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/90 text-white text-sm px-3 py-2 rounded shadow-lg">{text}</div>;
    }

    function ProgressBar({ value, max }){
      const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
      return (
        <div className="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden" role="progressbar" aria-valuenow={pct} aria-valuemin="0" aria-valuemax="100">
          <div className="h-2 bg-indigo-600" style={{ width: pct + '%' }} />
        </div>
      );
    }

    function GoalRow({ g, onContribute }){
      const [contrib, setContrib] = useState('');
      const saved = Number(g.saved)||0; const target = Number(g.target)||0; const remaining = Math.max(0, target - saved);
      return (
        <div className="p-3 rounded border border-slate-200 dark:border-slate-700">
          <div className="flex items-center justify-between gap-2">
            <div>
              <div className="font-medium">{g.name}</div>
              <div className="text-sm text-slate-600 dark:text-slate-300">{fmtUSD(saved)} / {fmtUSD(target)} <span className="text-slate-500">({fmtUSD(remaining)} left)</span></div>
            </div>
            <div className="flex items-center gap-2">
              <input className="border p-1 rounded w-28 dark:bg-slate-800 dark:border-slate-700" type="number" step="0.01" placeholder="$ add" value={contrib} onChange={e=>setContrib(e.target.value)} />
              <button className="bg-emerald-600 text-white px-3 py-1 rounded" onClick={()=>{ const n = parseFloat(contrib); if(!Number.isNaN(n) && n>0){ onContribute(n); setContrib(''); } }}>Contribute</button>
            </div>
          </div>
          <div className="mt-2"><ProgressBar value={saved} max={target} /></div>
        </div>
      );
    }

    // ------------------- Admin Panel -------------------
    function AdminPanel({ participants, classes, onAdjust, onSubscribe, onCancel, onDelete, onRenameClass, onRemoveFromClass }){
      const [q,setQ] = useState('');
      const filtered = React.useMemo(()=>{
        const members = new Set(classes.flatMap(c => c.members));
        const base = participants.filter(p => !members.has(p.username));
        const t = q.trim().toLowerCase();
        if(!t) return base;
        return base.filter(p => (p.name+' '+p.username).toLowerCase().includes(t));
      }, [participants, classes, q]);

      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-6">
          <div>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">Admin · Unassigned Participants</h3>
              <input className="border rounded px-2 py-1 text-sm dark:bg-slate-900 dark:border-slate-700" placeholder="Search name or username" value={q} onChange={e=>setQ(e.target.value)} />
            </div>
            <ul className="divide-y dark:divide-slate-700">
              {filtered.map(p => (
                <li key={p.id} className="py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div className="space-y-1">
                    <div className="font-medium">{p.name} <span className="text-slate-500">(@{p.username})</span></div>
                    <div className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(computeBalance(p))}</strong></div>
                    <div className="text-xs text-slate-500">Subscription: {p.subscriptionActive ? 'Active' : 'Inactive'}</div>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <button className="px-3 py-1 rounded bg-indigo-600 text-white text-xs" onClick={()=>onSubscribe(p.id)}>Activate</button>
                    <button className="px-3 py-1 rounded bg-rose-600 text-white text-xs" onClick={()=>onCancel(p.id)}>Cancel</button>
                    <button className="px-3 py-1 rounded bg-emerald-600 text-white text-xs" onClick={()=>onAdjust(p.id, +5, 'Admin +$5')}>+ $5</button>
                    <button className="px-3 py-1 rounded bg-amber-600 text-white text-xs" onClick={()=>onAdjust(p.id, -5, 'Admin -$5')}>− $5</button>
                    <button className="px-3 py-1 rounded bg-slate-800 text-white text-xs" onClick={()=>onDelete(p.id)}>Delete</button>
                  </div>
                </li>
              ))}
            </ul>
          </div>

          <div>
            <h3 className="text-lg font-semibold mb-2">Classes</h3>
            {classes.length === 0 && (
              <p className="text-sm text-slate-500">No classes yet. Students can join by entering a class number.</p>
            )}
            <ul className="space-y-3">
              {classes.map(cls => (
                <li key={cls.id} className="p-3 rounded border border-slate-200 dark:border-slate-700">
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <div className="font-medium">Class #{cls.id}{cls.title ? ` — ${cls.title}` : ''}</div>
                      <div className="text-xs text-slate-500">Members: {cls.members.length}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <input className="border rounded px-2 py-1 text-sm w-44 dark:bg-slate-900 dark:border-slate-700" placeholder="Rename (optional)" onKeyDown={e=>{ if(e.key==='Enter'){ onRenameClass(cls.id, e.currentTarget.value.trim()); e.currentTarget.value=''; } }} />
                      <button className="px-3 py-1 rounded bg-slate-200 dark:bg-slate-700 text-xs" onClick={()=>{
                        const newTitle = prompt('New title for Class #'+cls.id, cls.title||'');
                        if (newTitle !== null) onRenameClass(cls.id, newTitle.trim());
                      }}>Rename</button>
                    </div>
                  </div>
                  <ul className="mt-2 divide-y dark:divide-slate-700">
                    {cls.members.map(m => {
                      const p = participants.find(u => u.username === m);
                      if (!p) {
                        return (
                          <li key={m} className="py-2 flex items-center justify-between">
                            <span className="text-sm">@{m}</span>
                            <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white" onClick={()=>onRemoveFromClass(cls.id, m)}>Remove</button>
                          </li>
                        );
                      }
                      const balance = fmtUSD(computeBalance(p));
                      return (
                        <li key={m} className="py-3">
                          <div className="flex items-start justify-between gap-3">
                            <div>
                              <div className="font-medium">{p.name} <span className="text-slate-500">(@{p.username})</span></div>
                              <div className="text-xs text-slate-600 dark:text-slate-300">Balance: <strong>{balance}</strong> · Subscription: {p.subscriptionActive ? 'Active' : 'Inactive'}</div>
                              <div className="mt-1 text-xs text-slate-500">Goals: {p.goals?.length||0} · Weekly deductions: {p.weeklyDeductions?.length||0} · Budgets: {Object.keys(p.budgets||{}).length}</div>
                            </div>
                            <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white self-start" onClick={()=>onRemoveFromClass(cls.id, m)}>Remove</button>
                          </div>
                        </li>
                      );
                    })}
                    {cls.members.length===0 && <li className="py-2 text-sm text-slate-500">No members yet.</li>}
                  </ul>
                </li>
              ))}
            </ul>
          </div>
        </section>
      );
    }

    // ------------------- User Panel -------------------
    function UserPanel({ user, updateUser, applyWeeklyAll, onJoinClass }){
      const [delta, setDelta] = useState('');
      const [memo, setMemo] = useState('');
      const [wdName, setWdName] = useState('');
      const [wdAmt, setWdAmt] = useState('');
      const [goalName, setGoalName] = useState('');
      const [goalTarget, setGoalTarget] = useState('');
      const [cat, setCat] = useState('');
      const [bAmt, setBAmt] = useState('');
      const [classCode, setClassCode] = useState('');

      const balance = useMemo(()=> computeBalance(user), [user.transactions]);

      function pushTx(amount, memo){
        updateUser(u => ({...u, transactions: [...(u.transactions||[]), { amount: Number(amount), memo: memo||null, ts: now() }]}));
      }

      function deposit(){
        const n = parseFloat(delta); if(Number.isNaN(n) || n <= 0) return;
        let remaining = n;
        const updGoals = (user.goals||[]).map(g => {
          if (remaining <= 0) return g;
          const need = Math.max(0, Number(g.target) - Number(g.saved));
          const add = Math.min(need, remaining);
          remaining -= add; return {...g, saved: Number(g.saved)+add};
        });
        updateUser(u => ({...u, goals: updGoals}));
        pushTx(n, memo || 'Deposit');
        setDelta(''); setMemo('');
      }

      function withdraw(){
        const n = parseFloat(delta); if(Number.isNaN(n) || n <= 0) return;
        pushTx(-n, memo || 'Withdraw');
        setDelta(''); setMemo('');
      }

      function undoLast(){
        updateUser(u => ({...u, transactions: (u.transactions||[]).slice(0, -1)}));
      }

      function addWeekly(){
        const n = parseFloat(wdAmt); if(!wdName || Number.isNaN(n) || n<=0) return;
        updateUser(u => ({...u, weeklyDeductions: [...(u.weeklyDeductions||[]), { name: wdName, amount: n }]}));
        pushTx(-n, `Weekly: ${wdName}`);
        setWdName(''); setWdAmt('');
      }

      function removeWeekly(idx){
        updateUser(u => { const arr = [...(u.weeklyDeductions||[])]; arr.splice(idx,1); return {...u, weeklyDeductions: arr}; });
      }

      function addGoal(){
        const t = parseFloat(goalTarget); if(!goalName || Number.isNaN(t) || t<=0) return;
        updateUser(u => ({...u, goals: [...(u.goals||[]), { name: goalName, target: t, saved: 0 }]}));
        setGoalName(''); setGoalTarget('');
      }

      function contributeGoal(idx, amt){
        const n = Number(amt); if(Number.isNaN(n) || n<=0) return;
        updateUser(u => {
          const goals = [...(u.goals||[])];
          const g = {...goals[idx]};
          const maxAdd = Math.min(n, Math.max(0, Number(g.target) - Number(g.saved)));
          if (maxAdd <= 0) return u;
          g.saved = Number(g.saved) + maxAdd; goals[idx] = g;
          return {...u, goals};
        });
        pushTx(-n, 'Goal contribution');
      }

      function upsertBudget(){
        const n = parseFloat(bAmt); if(!cat || Number.isNaN(n) || n<=0) return;
        updateUser(u => ({...u, budgets: { ...(u.budgets||{}), [cat]: n }}));
        setCat(''); setBAmt('');
      }

      function deleteBudget(k){
        updateUser(u => { const b = { ...(u.budgets||{}) }; delete b[k]; return {...u, budgets: b}; });
      }

      function handleJoinClick(){
        const code = String(classCode).trim();
        if (!code || /[^0-9]/.test(code)) { alert('Enter a numeric class number'); return; }
        onJoinClass(code, user.username);
        setClassCode('');
      }

      return (
        <section className="md:col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-6">
          <div>
            <h3 className="text-lg font-semibold">Welcome, {user.name}</h3>
            <p className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(balance)}</strong></p>
          </div>

          <div className="p-3 rounded border border-slate-200 dark:border-slate-700">
            <div className="flex flex-wrap items-center gap-2">
              <label className="text-sm">Join a class:</label>
              <input className="border p-2 rounded w-40 dark:bg-slate-900 dark:border-slate-700" placeholder="Class number" value={classCode} onChange={e=>setClassCode(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={handleJoinClick}>Join</button>
              <span className="text-xs text-slate-500">(Only admins can view rosters.)</span>
            </div>
          </div>

          <div className="space-y-2">
            <h4 className="font-medium">Transactions</h4>
            <div className="flex flex-wrap gap-2 items-center">
              <input type="number" step="0.01" placeholder="$ amount" className="border p-2 rounded w-36 dark:bg-slate-900 dark:border-slate-700" value={delta} onChange={e=>setDelta(e.target.value)} />
              <input type="text" placeholder="Memo (optional)" className="border p-2 rounded w-60 dark:bg-slate-900 dark:border-slate-700" value={memo} onChange={e=>setMemo(e.target.value)} />
              <button className="bg-emerald-600 text-white px-3 py-2 rounded" onClick={deposit}>Deposit</button>
              <button className="bg-amber-600 text-white px-3 py-2 rounded" onClick={withdraw}>Withdraw</button>
              <button className="bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 px-3 py-2 rounded" onClick={undoLast}>Undo last</button>
            </div>
            <ul className="divide-y dark:divide-slate-700 bg-slate-50 dark:bg-slate-900 rounded">
              {(user.transactions||[]).slice().reverse().map((t,i)=> (
                <li key={i} className="flex items-center justify-between p-2">
                  <span className="text-sm">{new Date(t.ts||now()).toLocaleString()} — {t.memo || '—'}</span>
                  <span className={"text-sm font-medium "+(t.amount>=0?'text-emerald-700':'text-rose-400')}>{t.amount>=0?'+':''}{Number(t.amount).toFixed(2)}</span>
                </li>
              ))}
              {(user.transactions||[]).length === 0 && <li className="p-2 text-sm text-slate-500">No transactions yet.</li>}
            </ul>
          </div>

          <div>
            <h4 className="font-medium mb-2">Weekly Deductions</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Name (e.g., Phone)" value={wdName} onChange={e=>setWdName(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Amount" value={wdAmt} onChange={e=>setWdAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={addWeekly}>Add & Apply</button>
              <button className="bg-slate-800 text-white px-3 py-2 rounded" onClick={applyWeeklyAll}>Run all weekly now</button>
            </div>
            <ul className="space-y-2">
              {(user.weeklyDeductions||[]).map((d,i)=> (
                <li key={i} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                  <span>{d.name} — <strong>{fmtUSD(d.amount)}</strong></span>
                  <button className="text-xs px-2 py-1 rounded bg-rose-600 text-white" onClick={()=>removeWeekly(i)}>Remove</button>
                </li>
              ))}
              {(!user.weeklyDeductions || user.weeklyDeductions.length===0) && (
                <li className="text-sm text-slate-500">No weekly deductions yet.</li>
              )}
            </ul>
          </div>

          <div>
            <h4 className="font-medium mb-2">Goals</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Goal name (e.g., Bike)" value={goalName} onChange={e=>setGoalName(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Target $" value={goalTarget} onChange={e=>setGoalTarget(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={addGoal}>Add Goal</button>
            </div>
            <div className="space-y-3">
              {(user.goals||[]).map((g, idx) => (
                <GoalRow key={idx} g={g} onContribute={(amt)=>contributeGoal(idx, amt)} />
              ))}
              {(!user.goals || user.goals.length===0) && (
                <div className="text-sm text-slate-500">No goals yet. Add your first goal above.</div>
              )}
            </div>
          </div>

          <div>
            <h4 className="font-medium mb-2">Budgets</h4>
            <div className="flex flex-wrap gap-2 mb-3">
              <input className="border p-2 rounded dark:bg-slate-900 dark:border-slate-700" placeholder="Category (e.g., Food)" value={cat} onChange={e=>setCat(e.target.value)} />
              <input className="border p-2 rounded w-32 dark:bg-slate-900 dark:border-slate-700" type="number" step="0.01" placeholder="Amount $" value={bAmt} onChange={e=>setBAmt(e.target.value)} />
              <button className="bg-indigo-600 text-white px-3 py-2 rounded" onClick={upsertBudget}>Add/Update</button>
            </div>
            <ul className="space-y-2">
              {Object.entries(user.budgets||{}).map(([k,v]) => (
                <li key={k} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                  <span className="font-medium">{k}</span>
                  <div className="flex items-center gap-3">
                    <span>{fmtUSD(v)}</span>
                    <button className="text-xs px-2 py-1 rounded bg-slate-300 dark:bg-slate-700" onClick={()=>deleteBudget(k)}>Delete</button>
                  </div>
                </li>
              ))}
              {Object.keys(user.budgets||{}).length===0 && (
                <li className="text-sm text-slate-500">No budgets yet.</li>
              )}
            </ul>
          </div>
        </section>
      );
    }

    // ------------------- In-browser TeenBank "AI" (no server needed) -------------------
    function teenbankAI(input, history=[]) {
      const text = String(input||'').trim();
      if (!text) return "Ask me anything about budgeting or simple business math.";

      // helpers
      const num = (s) => parseFloat((s||'').replace(/[$,]/g,''));
      const findMoney = () => {
        const m = text.match(/[-+]?\d{1,3}(?:,\d{3})*(?:\.\d+)?|[-+]?\d+(?:\.\d+)?/g);
        return (m||[]).map(num).filter(v => !Number.isNaN(v));
      };
      const money = findMoney();

      // Budget split (50/30/20 or custom)
      if (/split|budget|50\/?30\/?20|percent|percentage/i.test(text)) {
        const amount = money.find(v=>v>0) ?? 100;
        const needs = amount*0.5, wants = amount*0.3, save = amount*0.2;
        return [
          `Try 50/30/20 on ${fmtUSD(amount)}:`,
          `• Needs (50%): ${fmtUSD(needs)}`,
          `• Wants (30%): ${fmtUSD(wants)}`,
          `• Save (20%): ${fmtUSD(save)}`,
          `Want me to tailor by your rent, food, and goal?`
        ].join('\n');
      }

      // Savings goal timeline: "save 500 by 3 months", or "$10/week"
      if (/save|goal|by|per\s*(week|month)/i.test(text)) {
        const amt = money[0];
        const per = /per\s*week/i.test(text) ? 'week' : /per\s*month/i.test(text) ? 'month' : null;
        const rate = per==='week' ? (money[1] ?? 10) : per==='month' ? (money[1] ?? 40) : null;
        if (amt && per && rate) {
          const weeks = per==='week' ? Math.ceil(amt/rate) : Math.ceil((amt/rate)*4);
          return `If you save ${fmtUSD(rate)} per ${per}, you’ll hit ${fmtUSD(amt)} in about ${weeks} weeks. Want an auto-deposit plan?`;
        }
        if (amt && money[1]) {
          const perWeek = money[1];
          const w = Math.ceil(amt/perWeek);
          return `At ${fmtUSD(perWeek)}/week, you’ll reach ${fmtUSD(amt)} in ~${w} weeks. Want me to split that per day?`;
        }
      }

      // Break-even: fixed, variable, price
      if (/break\s*-?\s*even|fixed|variable|margin/i.test(text)) {
        // Try to infer fixed cost (largest), price (middle), variable (smallest)
        const sorted = [...money].sort((a,b)=>a-b);
        if (sorted.length >= 3) {
          const variable = sorted[0], price = sorted[1], fixed = sorted[sorted.length-1];
          if (price > variable) {
            const qty = Math.ceil(fixed / (price - variable));
            return `Break-even ≈ ${qty} units.\nFormula: fixed ÷ (price − variable) = ${fixed} ÷ (${price} − ${variable}).`;
          }
        }
        return `Give me fixed cost, price per unit, and variable cost per unit. I’ll compute break-even units.`;
      }

      // Profit = revenue - expenses
      if (/profit|revenue|expenses/i.test(text)) {
        if (money.length >= 2) {
          const rev = money[0], exp = money[1];
          return `Profit = Revenue − Expenses = ${fmtUSD(rev)} − ${fmtUSD(exp)} = ${fmtUSD(rev-exp)}.`;
        }
        return `Tell me your revenue and expenses and I’ll compute profit (and margin).`;
      }

      // Simple interest or quick compound estimate
      if (/interest|apr|rate|compound/i.test(text)) {
        const P = money[0] ?? 1000;
        const r = (money[1] ?? 5)/100; // %
        const t = (money[2] ?? 1);     // years
        if (/compound/i.test(text)) {
          const n = /month/i.test(text) ? 12 : /quarter/i.test(text) ? 4 : 1;
          const A = P * Math.pow(1 + r/n, n*t);
          return `Compound estimate: ${fmtUSD(P)} → ${fmtUSD(A)} in ${t} year(s) at ${(r*100).toFixed(2)}% (${n}×/yr).`;
        } else {
          const I = P * r * t;
          return `Simple interest: I = P·r·t = ${fmtUSD(P)} × ${(r*100).toFixed(2)}% × ${t} = ${fmtUSD(I)}. Total ≈ ${fmtUSD(P+I)}.`;
        }
      }

      // Percent-of questions like "what is 15% of 80"
      if (/%\s*of|\bpercent of\b/i.test(text)) {
        const pct = money.find(v => v<=100 && v>0) ?? 10;
        const base = money.find(v => v>100) ?? money[1] ?? 100;
        return `${pct}% of ${fmtUSD(base)} is ${fmtUSD(base * (pct/100))}.`;
      }

      // Fallback
      return `Tell me your income and a goal, or ask "break-even", "50/30/20", or "how do I split $X?". I’ll calculate it step-by-step.`;
    }

    // ------------------- Student Chatbox Panel (card-style, matches account boxes) -------------------
    function ChatboxPanel() {
      const [input, setInput] = React.useState('');
      const [messages, setMessages] = React.useState([
        { role: 'assistant', content: "Hi! I’m TeenBank’s helper. Ask about budgeting, saving, or simple business math—I’ll show steps." }
      ]);
      const [loading, setLoading] = React.useState(false);

      async function send() {
        if (!input.trim()) return;
        const userMsg = { role: 'user', content: input };
        setMessages(m => [...m, userMsg]);
        setInput('');
        setLoading(true);
        // NO network call — instant in-browser reply:
        setTimeout(() => {
          try {
            const reply = teenbankAI(userMsg.content, messages);
            setMessages(m => [...m, { role: 'assistant', content: reply }]);
          } finally {
            setLoading(false);
          }
        }, 200);
      }

      return (
        <section
          className="md:col-span-1 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm flex flex-col"
          style={{ minHeight: '28rem' }}
        >
          <h3 className="text-lg font-semibold mb-3">TeenBank Help</h3>

          <div className="flex-1 overflow-y-auto rounded border border-slate-200 dark:border-slate-700 p-3 space-y-2 bg-slate-50 dark:bg-slate-900">
            {messages.map((m, i) => (
              <div key={i} className={m.role === 'user' ? 'text-right' : 'text-left'}>
                <span
                  className={`inline-block px-3 py-2 rounded-xl ${
                    m.role === 'user'
                      ? 'bg-indigo-600 text-white'
                      : 'bg-gray-200 dark:bg-slate-700 text-gray-900 dark:text-slate-100'
                  }`}
                >
                  {m.content}
                </span>
              </div>
            ))}
            {loading && <div className="text-xs text-gray-500">Typing...</div>}
          </div>

          <div className="mt-3 flex">
            <input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && send()}
              placeholder="Ask about budgeting or saving..."
              className="flex-1 border rounded-l-xl px-3 py-2 text-sm text-gray-900 dark:text-slate-100 dark:bg-slate-900 dark:border-slate-700"
            />
            <button
              onClick={send}
              className="bg-indigo-600 text-white px-4 py-2 rounded-r-xl text-sm"
            >
              Send
            </button>
          </div>

          <p className="mt-2 text-xs text-slate-500">
            Try: “Split $120 with 50/30/20” · “Break-even with 500 fixed, 20 price, 8 variable” · “Interest on $1000 at 5% for 2 years”
          </p>
        </section>
      );
    }

    // ------------------- App -------------------
    function App(){
      const [participants, setParticipants] = useState(loadParticipants);
      const [classes, setClasses] = useState(loadClasses);
      const [loginUser, setLoginUser] = useState('');
      const [password, setPassword] = useState(''); 
      const [authedUser, setAuthedUser] = useState('');
      const [theme, setTheme] = useState(localStorage.getItem(THEME_KEY) || 'light');
      const [toast, setToast] = useState(null);
      const [isCreating, setIsCreating] = useState(false);
      const [newName, setNewName] = useState('');
      const [confirmPw, setConfirmPw] = useState('');

      useEffect(()=>{ saveParticipants(participants); }, [participants]);
      useEffect(()=>{ saveClasses(classes); }, [classes]);
      useEffect(()=>{
        document.documentElement.classList.toggle('dark', theme==='dark');
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);

      // Ensure admin has a password
      useEffect(() => {
        (async () => {
          const admin = participants.find(u => u.username === ADMIN_USERNAME);
          if (admin && (!admin.passwordHash || !admin.salt)) {
            const salt = admin.salt || randomSalt();
            const hash = await sha256(salt + ADMIN_DEFAULT_PASSWORD);
            setParticipants(prev => prev.map(u => u.username===ADMIN_USERNAME ? { ...u, salt, passwordHash: hash } : u));
          }
        })();
      }, []);

      // Clean up any previously seeded fake class code
      useEffect(() => { setClasses(prev => prev.filter(c => c.id !== '76431')); }, []);

      const currentUser = useMemo(()=> participants.find(p => p.username.toLowerCase() === authedUser.toLowerCase()) || null, [participants, authedUser]);
      const isAdmin = currentUser && currentUser.username === ADMIN_USERNAME;

      function notify(msg){ setToast(msg); }

      // --- Auth ---
      async function login(username, pw){
        const u = (username||'').trim().toLowerCase();
        if (!u) return notify('Enter your username');
        const user = participants.find(x => x.username.toLowerCase() === u);
        if (!user) return notify('User not found. Create an account first.');
        if (!user.passwordHash || !user.salt) return notify('This account has no password set yet.');
        const hash = await sha256(user.salt + String(pw||''));
        if (hash !== user.passwordHash) return notify('Incorrect password');
        setAuthedUser(user.username);
        setPassword('');
        notify('Logged in');
      }

      async function createAccount(username, name, pw, pw2){
        const u = (username||'').trim().toLowerCase();
        const display = (name||'').trim();
        if (!u || !display) return notify('Enter a username and display name');
        if (!pw) return notify('Enter a password');
        if (pw !== pw2) return notify('Passwords do not match');
        if (/[^a-z0-9_.-]/i.test(u)) return notify('Username may contain letters, numbers, _ . -');
        if (participants.some(p => p.username.toLowerCase() === u)) return notify('Username already taken');

        const salt = randomSalt();
        const passwordHash = await sha256(salt + pw);
        const user = {
          id: Date.now(),
          username: u,
          name: display,
          salt,
          passwordHash,
          subscriptionActive: false,
          weeklyDeductions: [],
          goals: [],
          budgets: {},
          transactions: [],
        };
        setParticipants(prev => [...prev, user]);
        setPassword('');
        setConfirmPw('');
        setNewName('');
        setIsCreating(false);
        notify('Account created. Please log in.');
      }

      function logout(){ setAuthedUser(''); setPassword(''); }

      // --- Admin ops ---
      function adminAdjust(userId, delta, memo){
        setParticipants(prev => prev.map(u => {
          if (u.id !== userId) return u;
          return {...u, transactions: [...(u.transactions||[]), { amount: Number(delta), memo: memo||null, ts: now() }] };
        }));
      }
      function adminSub(userId){ setParticipants(prev => prev.map(u => u.id===userId? {...u, subscriptionActive:true}:u)); }
      function adminCancel(userId){ setParticipants(prev => prev.map(u => u.id===userId? {...u, subscriptionActive:false}:u)); }
      function adminDelete(userId){
        if(!confirm('Delete participant?')) return;
        const deleted = participants.find(u=>u.id===userId);
        setParticipants(prev => prev.filter(u => u.id!==userId));
        if(currentUser?.id===userId) logout();
        if (deleted) {
          setClasses(prev => prev.map(c => ({...c, members: c.members.filter(m => m !== deleted.username)})));
        }
      }

      // --- Classes ops ---
      function joinClass(classId, username){
        const id = String(classId);
        if (!/^[0-9]+$/.test(id)) { notify('Class codes must be numbers'); return; }
        const alreadyInSome = classes.some(c => c.members.includes(username));
        if (alreadyInSome) { notify('User is already in a class. Remove them first to reassign.'); return; }
        if (!classes.find(c => c.id === id)) {
          setClasses(prev => [...prev, { id, title: null, members: [] }]);
        }
        setClasses(prev => prev.map(c => c.id===id ? { ...c, members: c.members.includes(username) ? c.members : [...c.members, username] } : c));
        notify(`Joined Class #${id}`);
      }
      function renameClass(classId, newTitle){
        const id = String(classId);
        setClasses(prev => prev.map(c => c.id===id ? { ...c, title: (newTitle||null) } : c));
      }
      function removeFromClass(classId, username){
        const id = String(classId);
        setClasses(prev => prev.map(c => c.id===id ? { ...c, members: c.members.filter(m => m !== username) } : c));
      }

      function updateMe(mut){
        setParticipants(prev => prev.map(u => u.username===currentUser.username ? (typeof mut==='function'? mut(u):{...u, ...mut}) : u));
      }
      function applyMyWeeklyNow(){
        const me = currentUser; if(!me) return;
        setParticipants(prev => prev.map(u => {
          if (u.username !== me.username) return u;
          const txs = [...(u.transactions||[])];
          (u.weeklyDeductions||[]).forEach(d => txs.push({ amount: -Number(d.amount), memo: `Weekly: ${d.name}`, ts: now() }));
          return {...u, transactions: txs};
        }));
        notify('Applied weekly deductions');
      }

      // ---------- Screens ----------
      if (!currentUser){
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-6">
            <div className="bg-white dark:bg-slate-800 max-w-md w-full rounded-2xl shadow p-6">
              <div className="flex items-center justify-between mb-3">
                <h1 className="text-2xl font-bold">Student Banking {isCreating ? 'Create Account' : 'Login'}</h1>
                <button className="text-xs px-2 py-1 rounded border dark:border-slate-700" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'Light':'Dark'}</button>
              </div>

              {!isCreating ? (
                <>
                  <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Log in with your <strong>username</strong> and <strong>password</strong>.</p>

                  <label className="text-sm block mb-1">Username</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="yourname" value={loginUser} onChange={e=>setLoginUser(e.target.value)} />

                  <label className="text-sm block mb-1">Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-4 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />

                  <button className="w-full bg-indigo-600 text-white py-2 rounded mb-3" onClick={()=>login(loginUser, password)}>Login</button>
                  <button className="w-full bg-slate-200 dark:bg-slate-700 py-2 rounded" onClick={()=>setIsCreating(true)}>Create an account</button>
                </>
              ) : (
                <>
                  <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">Create a new account. Pick a unique username.</p>

                  <label className="text-sm block mb-1">Username</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="yourname" value={loginUser} onChange={e=>setLoginUser(e.target.value)} />

                  <label className="text-sm block mb-1">Display Name</label>
                  <input className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="e.g., Ava" value={newName} onChange={e=>setNewName(e.target.value)} />

                  <label className="text-sm block mb-1">Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-3 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />

                  <label className="text-sm block mb-1">Confirm Password</label>
                  <input type="password" className="border w-full p-2 rounded mb-4 dark:bg-slate-900 dark:border-slate-700" placeholder="••••••••" value={confirmPw} onChange={e=>setConfirmPw(e.target.value)} />

                  <button className="w-full bg-emerald-600 text-white py-2 rounded mb-3" onClick={()=>createAccount(loginUser, newName, password, confirmPw)}>Create Account</button>
                  <button className="w-full bg-slate-200 dark:bg-slate-700 py-2 rounded" onClick={()=>setIsCreating(false)}>Back to login</button>
                </>
              )}
            </div>
          </div>
        );
      }

      // Dashboard
      return (
        <div className="min-h-screen p-6">
          <header className="max-w-5xl mx-auto mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold">Student Banking Dashboard</h1>
              <div className="text-sm text-slate-600 dark:text-slate-300">Logged in as <strong>{currentUser.name}</strong> @{currentUser.username} {isAdmin && <span className="ml-1">(Admin)</span>}</div>
            </div>
            <div className="flex items-center gap-2">
              <button className="px-3 py-2 text-sm rounded border dark:border-slate-700" onClick={()=>setTheme(t=>t==='dark'?'light':'dark')}>{theme==='dark'?'Light':'Dark'}</button>
              <button className="px-3 py-2 text-sm rounded bg-slate-800 text-white" onClick={()=>{ setAuthedUser(''); setPassword(''); }}>Logout</button>
            </div>
          </header>

          <main className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
            {isAdmin ? (
              <AdminPanel
                participants={participants}
                classes={classes}
                onAdjust={adminAdjust}
                onSubscribe={adminSub}
                onCancel={adminCancel}
                onDelete={adminDelete}
                onRenameClass={renameClass}
                onRemoveFromClass={removeFromClass}
              />
            ) : (
              <UserPanel
                user={currentUser}
                updateUser={(mut)=> setParticipants(prev => prev.map(u => u.username===currentUser.username ? (typeof mut==='function'? mut(u):{...u, ...mut}) : u)) }
                applyWeeklyAll={applyMyWeeklyNow}
                onJoinClass={joinClass}
              />
            )}

            {/* Chatbox as a matching card in the right column (students only) */}
            {!isAdmin && <ChatboxPanel />}

            {isAdmin && (
              <aside className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm space-y-4">
                <h3 className="text-lg font-semibold">Unassigned Participants</h3>
                <ul className="space-y-2 max-h-[420px] overflow-auto pr-1">
                  {participants.filter(p => !classes.some(c => c.members.includes(p.username))).map(p => (
                    <li key={p.id} className="flex items-center justify-between bg-slate-100 dark:bg-slate-900 p-2 rounded">
                      <div>
                        <div className="font-medium text-sm">{p.name}</div>
                        <div className="text-xs text-slate-500">@{p.username}</div>
                      </div>
                      <div className="text-xs">{fmtUSD(computeBalance(p))}</div>
                    </li>
                  ))}
                </ul>
              </aside>
            )}
          </main>

          {toast && <Toast text={toast} onClose={()=>setToast(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
