<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Bank</title>
  <meta name="description" content="A simple subscription-based budgeting simulator for students learning banking basics." />
  <script>
    window.tailwind = {
      config: {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              display: ['\"Inter\"', 'system-ui', 'sans-serif'],
            },
          },
        },
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const ADMIN_EMAIL = 'hasslerw748@stu.mw.k12.ny.us';
    const DB_KEY = 'student_bank_v1';
    const THEME_KEY = 'student_bank_theme';
    const CURRENT_USER_KEY = 'student_bank_current_user';
    const DEFAULT_SUBSCRIPTION_AMOUNT = 5;
    const WEEK_MS = 1000 * 60 * 60 * 24 * 7;

    function now() {
      return Date.now();
    }

    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function fmtUSD(value) {
      return (Number(value) || 0).toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
      });
    }

    function safeAmount(value) {
      const num = Number(value);
      if (!isFinite(num)) return 0;
      return Math.round(num * 100) / 100;
    }

    function totalRecurring(list = []) {
      return list.reduce((sum, item) => sum + safeAmount(item.amount), 0);
    }

    function createTransaction({ amount, memo, type }) {
      return {
        id: uid(),
        amount: safeAmount(amount),
        memo: memo || '',
        type: type || 'general',
        ts: now(),
      };
    }

    function computeBalance(user) {
      return (user.transactions || []).reduce((sum, tx) => sum + safeAmount(tx.amount), 0);
    }

    function lastSubscriptionDate(user) {
      const history = (user.transactions || []).filter((tx) => tx.type === 'subscription');
      if (history.length === 0) return null;
      const latest = history.reduce((acc, tx) => (tx.ts > acc.ts ? tx : acc), history[0]);
      return latest.ts;
    }

    function normalizeRecurringList(list = []) {
      if (!Array.isArray(list)) return [];
      return list.map((item) => ({
        id: item.id || uid(),
        label: item.label || item.name || 'Weekly item',
        amount: safeAmount(item.amount),
      })).filter((item) => item.amount !== 0 && item.label);
    }

    function normalizeTransactions(list = []) {
      if (!Array.isArray(list)) return [];
      return list.map((tx) => ({
        id: tx.id || uid(),
        amount: safeAmount(tx.amount),
        memo: tx.memo || '',
        type: tx.type || 'general',
        ts: typeof tx.ts === 'number' ? tx.ts : now(),
      })).filter((tx) => tx.amount !== 0 || tx.memo);
    }

    function normalizeUser(user) {
      return {
        id: user.id || uid(),
        name: user.name || '',
        email: (user.email || '').trim(),
        password: user.password || '',
        classNumber: typeof user.classNumber === 'string' ? user.classNumber.trim() : '',
        createdAt: user.createdAt || now(),
        transactions: normalizeTransactions(user.transactions || []),
        weeklyIncome: normalizeRecurringList(user.weeklyIncome || []),
        weeklyExpenses: normalizeRecurringList(user.weeklyExpenses || user.weeklyDeductions || []),
        subscriptionActive: Boolean(user.subscriptionActive),
        subscriptionAmount: typeof user.subscriptionAmount === 'number' && isFinite(user.subscriptionAmount)
          ? safeAmount(user.subscriptionAmount)
          : DEFAULT_SUBSCRIPTION_AMOUNT,
        lastWeeklyRun: user.lastWeeklyRun || null,
        lastSubscriptionPayment: user.lastSubscriptionPayment || lastSubscriptionDate(user) || null,
        notes: user.notes || '',
      };
    }

    function loadUsers() {
      try {
        const raw = localStorage.getItem(DB_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(normalizeUser);
      } catch (error) {
        console.warn('Failed to load users:', error);
        return [];
      }
    }

    function saveUsers(users) {
      localStorage.setItem(DB_KEY, JSON.stringify(users));
    }
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    function Toast({ message, onDismiss }) {
      useEffect(() => {
        if (!message) return;
        const id = setTimeout(() => onDismiss && onDismiss(), 2400);
        return () => clearTimeout(id);
      }, [message, onDismiss]);

      if (!message) return null;
      return (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded shadow-lg text-sm">
          {message}
        </div>
      );
    }

    function Header({ onLogout, onToggleTheme, theme, isAdmin, userName }) {
      return (
        <header className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 className="text-2xl font-semibold">Student Bank</h1>
            <p className="text-sm text-slate-600 dark:text-slate-300">
              A safe place for high schoolers to practice tracking money and subscriptions.
            </p>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <button
              className="px-3 py-1.5 rounded border border-slate-300 dark:border-slate-700 text-sm"
              onClick={onToggleTheme}
            >
              Toggle {theme === 'dark' ? 'Light' : 'Dark'} Mode
            </button>
            {userName && (
              <span className="text-sm text-slate-600 dark:text-slate-300">
                Signed in as <strong>{userName}</strong>{isAdmin && ' (Admin)'}
              </span>
            )}
            {onLogout && (
              <button
                className="px-3 py-1.5 rounded bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 text-sm"
                onClick={onLogout}
              >
                Log out
              </button>
            )}
          </div>
        </header>
      );
    }

    function LoginCard({ onAuthenticate, onToggleTheme, theme }) {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [password, setPassword] = useState('');
      const [classNumber, setClassNumber] = useState('');

      function handleSubmit(event) {
        event.preventDefault();
        onAuthenticate({ email, name, password, classNumber });
      }

      return (
        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-6 max-w-xl mx-auto">
          <h2 className="text-xl font-semibold mb-1">Welcome!</h2>
          <p className="text-sm text-slate-600 dark:text-slate-300 mb-4">
            Sign in with your school email. If it is your first time here, choose a password and tell us your name to create an
            account.
          </p>
          <form className="space-y-4" onSubmit={handleSubmit}>
            <div className="space-y-1">
              <label className="text-sm font-medium" htmlFor="login-email">Email</label>
              <input
                id="login-email"
                type="email"
                required
                className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                value={email}
                onChange={(event) => setEmail(event.target.value)}
                placeholder="you@school.edu"
              />
            </div>
            <div className="space-y-1">
              <label className="text-sm font-medium" htmlFor="login-name">Name</label>
              <input
                id="login-name"
                type="text"
                className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                value={name}
                onChange={(event) => setName(event.target.value)}
                placeholder="Only needed when creating an account"
              />
            </div>
            <div className="space-y-1">
              <label className="text-sm font-medium" htmlFor="login-password">Password</label>
              <input
                id="login-password"
                type="password"
                required
                minLength={4}
                className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                value={password}
                onChange={(event) => setPassword(event.target.value)}
                placeholder="Choose something easy to remember"
              />
            </div>
            <div className="space-y-1">
              <label className="text-sm font-medium" htmlFor="login-class">Class number</label>
              <input
                id="login-class"
                type="text"
                className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                value={classNumber}
                onChange={(event) => setClassNumber(event.target.value)}
                placeholder="Optional — enter the class you belong to"
              />
            </div>
            <div className="flex items-center justify-between">
              <button
                type="button"
                className="text-sm text-slate-600 dark:text-slate-300"
                onClick={onToggleTheme}
              >
                Switch to {theme === 'dark' ? 'Light' : 'Dark'} Mode
              </button>
              <button
                type="submit"
                className="inline-flex items-center justify-center rounded bg-indigo-600 px-4 py-2 text-white text-sm font-medium"
              >
                Sign in / Create account
              </button>
            </div>
          </form>
        </div>
      );
    }

    function RecurringList({ title, emptyHint, items, onRemove, disabled = false }) {
      return (
        <div>
          <h4 className="text-sm font-semibold text-slate-700 dark:text-slate-200 mb-2">{title}</h4>
          {items.length === 0 ? (
            <p className="text-sm text-slate-500">{emptyHint}</p>
          ) : (
            <ul className="space-y-2">
              {items.map((item) => (
                <li key={item.id} className="flex items-center justify-between gap-4 rounded bg-slate-50 dark:bg-slate-900 px-3 py-2">
                  <div>
                    <div className="text-sm font-medium">{item.label}</div>
                    <div className="text-xs text-slate-500">{fmtUSD(item.amount)} every week</div>
                  </div>
                  {onRemove && !disabled && (
                    <button
                      className="text-xs text-rose-600 hover:underline"
                      onClick={() => onRemove(item.id)}
                    >
                      Remove
                    </button>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>
      );
    }

    function TransactionHistory({ transactions }) {
      if (!transactions.length) {
        return <p className="text-sm text-slate-500">No activity yet. Every deposit, withdrawal, and subscription payment will appear here.</p>;
      }

      const sorted = [...transactions].sort((a, b) => (b.ts || 0) - (a.ts || 0));

      return (
        <div className="overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700">
          <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700 text-sm">
            <thead className="bg-slate-50 dark:bg-slate-800/60">
              <tr>
                <th className="px-3 py-2 text-left font-medium">When</th>
                <th className="px-3 py-2 text-left font-medium">Details</th>
                <th className="px-3 py-2 text-right font-medium">Amount</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-200 dark:divide-slate-800">
              {sorted.map((tx) => (
                <tr key={tx.id}>
                  <td className="px-3 py-2 whitespace-nowrap text-slate-600 dark:text-slate-300">
                    {new Date(tx.ts || now()).toLocaleString()}
                  </td>
                  <td className="px-3 py-2 text-slate-700 dark:text-slate-200">
                    <div className="font-medium capitalize">{tx.type.replace('-', ' ')}</div>
                    <div className="text-xs text-slate-500">{tx.memo || '—'}</div>
                  </td>
                  <td className={`px-3 py-2 text-right font-medium ${tx.amount >= 0 ? 'text-emerald-600' : 'text-rose-500'}`}>
                    {tx.amount >= 0 ? '+' : ''}{fmtUSD(tx.amount)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    function StudentDashboard({ user, onUpdate, onNotify }) {
      const [amount, setAmount] = useState('');
      const [memo, setMemo] = useState('');
      const [incomeLabel, setIncomeLabel] = useState('');
      const [incomeAmount, setIncomeAmount] = useState('');
      const [expenseLabel, setExpenseLabel] = useState('');
      const [expenseAmount, setExpenseAmount] = useState('');

      const balance = useMemo(() => computeBalance(user), [user.transactions]);
      const totalIncome = useMemo(() => totalRecurring(user.weeklyIncome), [user.weeklyIncome]);
      const totalExpenses = useMemo(() => totalRecurring(user.weeklyExpenses), [user.weeklyExpenses]);
      const weeklySubscription = user.subscriptionActive ? safeAmount(user.subscriptionAmount) : 0;
      const projectedNet = totalIncome - totalExpenses - weeklySubscription;
      const lastPayment = user.lastSubscriptionPayment ? new Date(user.lastSubscriptionPayment).toLocaleString() : 'No payments yet';
      const isFrozen = !user.subscriptionActive;
      const canPaySubscription =
        user.subscriptionActive && (!user.lastSubscriptionPayment || now() - user.lastSubscriptionPayment >= WEEK_MS);
      const nextPaymentDate =
        user.lastSubscriptionPayment && new Date(user.lastSubscriptionPayment + WEEK_MS).toLocaleString();

      function assertActive() {
        if (!isFrozen) return true;
        onNotify('Your subscription is paused, so your account is frozen until the admin reactivates it.');
        return false;
      }

      function addTransaction(change, type, defaultMemo) {
        const delta = safeAmount(change);
        if (delta === 0) return;
        onUpdate((current) => ({
          ...current,
          transactions: [...(current.transactions || []), createTransaction({ amount: delta, memo: memo || defaultMemo, type })],
        }));
        setAmount('');
        setMemo('');
      }

      function withdrawTransaction(change, type, defaultMemo) {
        const delta = safeAmount(change);
        if (delta === 0) return;
        onUpdate((current) => ({
          ...current,
          transactions: [...(current.transactions || []), createTransaction({ amount: -Math.abs(delta), memo: memo || defaultMemo, type })],
        }));
        setAmount('');
        setMemo('');
      }

      function handleDeposit() {
        if (!assertActive()) return;
        const delta = safeAmount(amount);
        if (delta <= 0) return onNotify('Enter an amount greater than $0.00');
        addTransaction(delta, 'deposit', 'Deposit');
        onNotify('Deposit added');
      }

      function handleWithdraw() {
        if (!assertActive()) return;
        const delta = safeAmount(amount);
        if (delta <= 0) return onNotify('Enter an amount greater than $0.00');
        if (delta > balance) {
          onNotify('This would put you below $0. Adjust the amount or deposit first.');
          return;
        }
        withdrawTransaction(delta, 'withdrawal', 'Spending');
        onNotify('Withdrawal recorded');
      }

      function addRecurring(kind) {
        if (!assertActive()) return;
        const label = kind === 'income' ? incomeLabel.trim() : expenseLabel.trim();
        const rawAmount = kind === 'income' ? incomeAmount : expenseAmount;
        const parsed = safeAmount(rawAmount);
        if (!label) return onNotify('Give the recurring item a name.');
        if (parsed <= 0) return onNotify('Enter an amount greater than $0.00');

        onUpdate((current) => {
          const key = kind === 'income' ? 'weeklyIncome' : 'weeklyExpenses';
          const nextList = [...(current[key] || []), { id: uid(), label, amount: parsed }];
          return { ...current, [key]: nextList };
        });

        if (kind === 'income') {
          setIncomeLabel('');
          setIncomeAmount('');
        } else {
          setExpenseLabel('');
          setExpenseAmount('');
        }
        onNotify('Saved to weekly plan');
      }

      function removeRecurring(kind, id) {
        if (!assertActive()) return;
        onUpdate((current) => {
          const key = kind === 'income' ? 'weeklyIncome' : 'weeklyExpenses';
          return {
            ...current,
            [key]: (current[key] || []).filter((item) => item.id !== id),
          };
        });
      }

      function applyWeeklyPlan() {
        if (!assertActive()) return;
        const incomes = user.weeklyIncome || [];
        const expenses = user.weeklyExpenses || [];
        const chargeSubscription = user.subscriptionActive && safeAmount(user.subscriptionAmount) > 0;
        if (!incomes.length && !expenses.length && !chargeSubscription) {
          return onNotify('Add weekly income, weekly expenses, or enable your subscription before running the update.');
        }
        const runTimestamp = now();
        onUpdate((current) => {
          const transactions = [...(current.transactions || [])];
          incomes.forEach((item) => {
            transactions.push(
              createTransaction({
                amount: safeAmount(item.amount),
                memo: `Weekly income · ${item.label}`,
                type: 'weekly-income',
              })
            );
          });
          expenses.forEach((item) => {
            transactions.push(
              createTransaction({
                amount: -Math.abs(safeAmount(item.amount)),
                memo: `Weekly expense · ${item.label}`,
                type: 'weekly-expense',
              })
            );
          });
          let lastSubscriptionPayment = current.lastSubscriptionPayment || null;
          if (chargeSubscription) {
            const subscriptionAmount = safeAmount(current.subscriptionAmount);
            const alreadyPaid =
              lastSubscriptionPayment && runTimestamp - lastSubscriptionPayment < WEEK_MS;
            if (!alreadyPaid) {
              transactions.push(
                createTransaction({
                  amount: -Math.abs(subscriptionAmount),
                  memo: 'Weekly subscription fee',
                  type: 'subscription',
                })
              );
              lastSubscriptionPayment = runTimestamp;
            }
          }
          return {
            ...current,
            transactions,
            lastWeeklyRun: runTimestamp,
            lastSubscriptionPayment,
          };
        });
        onNotify('Weekly plan applied to your balance');
      }

      function paySubscriptionNow() {
        if (!assertActive()) return;
        const timestamp = now();
        const amount = safeAmount(user.subscriptionAmount);
        if (amount <= 0) {
          return onNotify('Your subscription amount is not set. Ask the admin for help.');
        }
        if (user.lastSubscriptionPayment && timestamp - user.lastSubscriptionPayment < WEEK_MS) {
          return onNotify('You already paid within the last 7 days. Try again later.');
        }
        onUpdate((current) => ({
          ...current,
          transactions: [
            ...(current.transactions || []),
            createTransaction({ amount: -Math.abs(amount), memo: 'Subscription payment', type: 'subscription' }),
          ],
          lastSubscriptionPayment: timestamp,
        }));
        onNotify('Subscription payment recorded');
      }

      return (
        <div className="grid gap-6 lg:grid-cols-3">
          <section className="lg:col-span-2 space-y-6">
            <div className="rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-6 space-y-4">
              <div>
                <h2 className="text-xl font-semibold">Hi {user.name || 'there'}!</h2>
                <p className="text-sm text-slate-600 dark:text-slate-300">
                  Current balance: <strong>{fmtUSD(balance)}</strong>
                </p>
                <p className="text-xs text-slate-500">Every amount you add or remove is saved privately to this device.</p>
                {isFrozen && (
                  <p className="mt-2 rounded border border-amber-300 bg-amber-50 px-3 py-2 text-xs text-amber-700 dark:border-amber-700 dark:bg-amber-900/30 dark:text-amber-200">
                    Your subscription is paused, so this account is read-only until the admin reactivates it.
                  </p>
                )}
              </div>
              <div className="grid gap-4 sm:grid-cols-2">
                <div className="space-y-2">
                  <label className="text-sm font-medium" htmlFor="amount-input">Amount</label>
                  <input
                    id="amount-input"
                    type="number"
                    min="0"
                    step="0.01"
                    value={amount}
                    onChange={(event) => setAmount(event.target.value)}
                    className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                    disabled={isFrozen}
                    placeholder="0.00"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm font-medium" htmlFor="memo-input">Memo</label>
                  <input
                    id="memo-input"
                    type="text"
                    value={memo}
                    onChange={(event) => setMemo(event.target.value)}
                    className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                    disabled={isFrozen}
                    placeholder="What is this for?"
                  />
                </div>
              </div>
              <div className="flex flex-wrap gap-2">
                <button
                  className="rounded bg-emerald-600 px-4 py-2 text-white text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                  onClick={handleDeposit}
                  disabled={isFrozen}
                >
                  Add money
                </button>
                <button
                  className="rounded bg-rose-600 px-4 py-2 text-white text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                  onClick={handleWithdraw}
                  disabled={isFrozen}
                >
                  Spend money
                </button>
              </div>
            </div>

            <div className="rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-6 space-y-6">
              <div className="space-y-2">
                <h3 className="text-lg font-semibold">Weekly plan</h3>
                <p className="text-sm text-slate-600 dark:text-slate-300">
                  Track regular income like allowances and expenses like snacks or clubs. Run the weekly update to copy them into
                  your history automatically.
                </p>
              </div>
              <div className="grid gap-6 md:grid-cols-2">
                <div className="space-y-3">
                  <div className="space-y-2">
                    <label className="text-sm font-medium" htmlFor="income-label">Add weekly income</label>
                    <input
                      id="income-label"
                      type="text"
                      value={incomeLabel}
                      onChange={(event) => setIncomeLabel(event.target.value)}
                      className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="Example: Allowance"
                    />
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      value={incomeAmount}
                      onChange={(event) => setIncomeAmount(event.target.value)}
                      className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="Amount each week"
                    />
                    <button
                      className="rounded bg-emerald-600 px-3 py-2 text-white text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                      onClick={() => addRecurring('income')}
                      disabled={isFrozen}
                    >
                      Save income
                    </button>
                  </div>
                  <RecurringList
                    title="Weekly income"
                    emptyHint="No weekly income saved yet."
                    items={user.weeklyIncome || []}
                    onRemove={!isFrozen ? (id) => removeRecurring('income', id) : null}
                    disabled={isFrozen}
                  />
                </div>
                <div className="space-y-3">
                  <div className="space-y-2">
                    <label className="text-sm font-medium" htmlFor="expense-label">Add weekly expense</label>
                    <input
                      id="expense-label"
                      type="text"
                      value={expenseLabel}
                      onChange={(event) => setExpenseLabel(event.target.value)}
                      className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="Example: Lunch"
                    />
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      value={expenseAmount}
                      onChange={(event) => setExpenseAmount(event.target.value)}
                      className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                      disabled={isFrozen}
                      placeholder="Amount each week"
                    />
                    <button
                      className="rounded bg-indigo-600 px-3 py-2 text-white text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                      onClick={() => addRecurring('expense')}
                      disabled={isFrozen}
                    >
                      Save expense
                    </button>
                  </div>
                  <RecurringList
                    title="Weekly expenses"
                    emptyHint="No weekly expenses saved yet."
                    items={user.weeklyExpenses || []}
                    onRemove={!isFrozen ? (id) => removeRecurring('expense', id) : null}
                    disabled={isFrozen}
                  />
                </div>
              </div>
              <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between rounded-lg bg-slate-50 dark:bg-slate-900 px-4 py-3">
                <div>
                  <p className="text-sm text-slate-600 dark:text-slate-300">
                    Projected change each week: <strong>{fmtUSD(projectedNet)}</strong>
                  </p>
                  <p className="text-xs text-slate-500">
                    Income {fmtUSD(totalIncome)} − Expenses {fmtUSD(totalExpenses)} − Subscription {fmtUSD(weeklySubscription)}
                  </p>
                </div>
                <button
                  className="rounded bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-4 py-2 text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                  onClick={applyWeeklyPlan}
                  disabled={isFrozen}
                >
                  Run weekly update
                </button>
              </div>
            </div>

            <div className="rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-6 space-y-4">
              <div className="space-y-1">
                <h3 className="text-lg font-semibold">Subscription</h3>
                <p className="text-sm text-slate-600 dark:text-slate-300">
                  Status: <strong>{user.subscriptionActive ? 'Active' : 'Paused'}</strong>
                </p>
                <p className="text-sm text-slate-600 dark:text-slate-300">
                  Weekly fee: <strong>{fmtUSD(user.subscriptionAmount || DEFAULT_SUBSCRIPTION_AMOUNT)}</strong>
                </p>
                <p className="text-xs text-slate-500">Last payment: {lastPayment}</p>
                {user.subscriptionActive && !canPaySubscription && nextPaymentDate && (
                  <p className="text-xs text-slate-500">Next payment available after {nextPaymentDate}</p>
                )}
              </div>
              <button
                className="w-full rounded bg-amber-500 px-4 py-2 text-white text-sm font-medium disabled:cursor-not-allowed disabled:opacity-60"
                onClick={paySubscriptionNow}
                disabled={!canPaySubscription}
              >
                Pay subscription now
              </button>
              {!user.subscriptionActive && (
                <p className="text-xs text-slate-500">
                  Need your subscription back on? Ask the admin to activate it so weekly charges resume.
                </p>
              )}
              {user.subscriptionActive && !canPaySubscription && (
                <p className="text-xs text-slate-500">
                  You can only make one subscription payment every 7 days to avoid duplicate charges.
                </p>
              )}
            </div>
          </section>

          <section className="rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-6 space-y-4">
            <div>
              <h3 className="text-lg font-semibold">History</h3>
              <p className="text-sm text-slate-600 dark:text-slate-300">Review every move you have made so nothing is a surprise.</p>
            </div>
            <TransactionHistory transactions={user.transactions || []} />
          </section>
        </div>
      );
    }

    function AdminUserCard({ user, onToggleSubscription, onChangeSubscriptionAmount, onAdjustBalance, onChargeSubscription, onRemoveUser }) {
      const [amount, setAmount] = useState('');
      const [note, setNote] = useState('');
      const [subscription, setSubscription] = useState(user.subscriptionAmount);

      useEffect(() => {
        setSubscription(user.subscriptionAmount);
      }, [user.subscriptionAmount]);

      const balance = useMemo(() => computeBalance(user), [user.transactions]);
      const totalIncome = useMemo(() => totalRecurring(user.weeklyIncome), [user.weeklyIncome]);
      const totalExpenses = useMemo(() => totalRecurring(user.weeklyExpenses), [user.weeklyExpenses]);
      const projectedNet = totalIncome - totalExpenses - (user.subscriptionActive ? safeAmount(user.subscriptionAmount) : 0);
      const lastPayment = user.lastSubscriptionPayment ? new Date(user.lastSubscriptionPayment).toLocaleString() : 'Never';

      return (
        <li className="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 space-y-4">
          <div className="flex flex-col gap-1">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <h3 className="text-lg font-semibold">{user.name || user.email}</h3>
              <span className={`text-xs font-semibold px-2 py-1 rounded-full ${
                user.subscriptionActive ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300' : 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300'
              }`}>
                {user.subscriptionActive ? 'Subscription active' : 'Subscription paused'}
              </span>
            </div>
            <p className="text-sm text-slate-600 dark:text-slate-300">{user.email}</p>
            <p className="text-xs text-slate-500">{user.classNumber ? `Classroom: ${user.classNumber}` : 'No class assigned'}</p>
            <p className="text-sm text-slate-600 dark:text-slate-300">Balance: <strong>{fmtUSD(balance)}</strong></p>
            <p className="text-xs text-slate-500">Last subscription payment: {lastPayment}</p>
            <p className="text-xs text-slate-500">Projected weekly change: {fmtUSD(projectedNet)}</p>
          </div>

          <div className="grid gap-3 md:grid-cols-2">
            <div className="space-y-2 text-sm">
              <h4 className="font-semibold">Weekly income</h4>
              <ul className="space-y-1">
                {(user.weeklyIncome || []).map((item) => (
                  <li key={item.id} className="flex justify-between">
                    <span>{item.label}</span>
                    <span>{fmtUSD(item.amount)}</span>
                  </li>
                ))}
                {(user.weeklyIncome || []).length === 0 && <li className="text-slate-500">None</li>}
              </ul>
            </div>
            <div className="space-y-2 text-sm">
              <h4 className="font-semibold">Weekly expenses</h4>
              <ul className="space-y-1">
                {(user.weeklyExpenses || []).map((item) => (
                  <li key={item.id} className="flex justify-between">
                    <span>{item.label}</span>
                    <span>{fmtUSD(item.amount)}</span>
                  </li>
                ))}
                {(user.weeklyExpenses || []).length === 0 && <li className="text-slate-500">None</li>}
              </ul>
            </div>
          </div>

          <div className="grid gap-3 md:grid-cols-2">
            <div className="space-y-2">
              <label className="text-sm font-medium">Subscription amount</label>
              <div className="flex items-center gap-2">
                <input
                  type="number"
                  min="0"
                  step="0.01"
                  value={subscription}
                  onChange={(event) => setSubscription(event.target.value)}
                  className="w-full rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                />
                <button
                  className="rounded bg-indigo-600 px-3 py-2 text-white text-xs font-medium"
                  onClick={() => onChangeSubscriptionAmount(user.id, subscription)}
                >
                  Save
                </button>
              </div>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-medium">Quick actions</label>
              <div className="flex flex-wrap gap-2">
                <button
                  className="rounded bg-emerald-600 px-3 py-2 text-white text-xs font-medium"
                  onClick={() => onToggleSubscription(user.id, true)}
                >
                  Activate
                </button>
                <button
                  className="rounded bg-rose-600 px-3 py-2 text-white text-xs font-medium"
                  onClick={() => onToggleSubscription(user.id, false)}
                >
                  Pause
                </button>
                <button
                  className="rounded bg-amber-500 px-3 py-2 text-white text-xs font-medium"
                  onClick={() => onChargeSubscription(user.id)}
                >
                  Charge now
                </button>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">Post an adjustment</label>
            <div className="grid gap-2 md:grid-cols-[1fr_2fr_auto]">
              <input
                type="number"
                step="0.01"
                value={amount}
                onChange={(event) => setAmount(event.target.value)}
                className="rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                placeholder="Amount"
              />
              <input
                type="text"
                value={note}
                onChange={(event) => setNote(event.target.value)}
                className="rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900"
                placeholder="Reason"
              />
              <button
                className="rounded bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 px-3 py-2 text-xs font-medium"
                onClick={() => {
                  const value = safeAmount(amount);
                  if (value === 0) return;
                  onAdjustBalance(user.id, value, note || 'Admin adjustment');
                  setAmount('');
                  setNote('');
                }}
              >
                Post
              </button>
            </div>
          </div>

          <div className="flex flex-wrap items-center justify-between gap-2">
            <span className="text-xs text-slate-500">Created {new Date(user.createdAt || now()).toLocaleDateString()}</span>
            <button
              className="text-xs text-rose-600 hover:underline"
              onClick={() => {
                if (window.confirm('Delete this account? All locally stored data will be removed.')) {
                  onRemoveUser(user.id);
                }
              }}
            >
              Delete account
            </button>
          </div>
        </li>
      );
    }

    function AdminDashboard({ users, onToggleSubscription, onChangeSubscriptionAmount, onAdjustBalance, onChargeSubscription, onRemoveUser }) {
      const [query, setQuery] = useState('');
      const [selectedClass, setSelectedClass] = useState('');

      const classes = useMemo(() => {
        const counts = new Map();
        users.forEach((user) => {
          const value = (user.classNumber || '').trim();
          if (!value) return;
          counts.set(value, (counts.get(value) || 0) + 1);
        });
        return Array.from(counts.entries())
          .map(([value, count]) => ({ value, count }))
          .sort((a, b) => a.value.localeCompare(b.value, undefined, { numeric: true, sensitivity: 'base' }));
      }, [users]);

      useEffect(() => {
        if (!selectedClass) return;
        const exists = classes.some((item) => item.value.toLowerCase() === selectedClass.trim().toLowerCase());
        if (!exists) {
          setSelectedClass('');
        }
      }, [classes, selectedClass]);

      const filtered = useMemo(() => {
        const term = query.trim().toLowerCase();
        const normalizedSelection = selectedClass.trim().toLowerCase();
        return users.filter((user) => {
          const userClass = (user.classNumber || '').trim();
          const matchesClass = !normalizedSelection || userClass.toLowerCase() === normalizedSelection;
          if (!matchesClass) return false;
          if (!term) return true;
          return `${user.name} ${user.email} ${userClass}`.toLowerCase().includes(term);
        });
      }, [users, query, selectedClass]);

      return (
        <section className="rounded-2xl bg-white dark:bg-slate-800 shadow-sm p-6 space-y-6">
          <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 className="text-xl font-semibold">Admin control center</h2>
              <p className="text-sm text-slate-600 dark:text-slate-300">
                Review every student account, update subscription status, and help with balances.
              </p>
            </div>
            <input
              type="search"
              value={query}
              onChange={(event) => setQuery(event.target.value)}
              placeholder="Search by name, email, or class"
              className="rounded border border-slate-300 dark:border-slate-700 px-3 py-2 bg-white dark:bg-slate-900 text-sm"
            />
          </div>

          {classes.length > 0 && (
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={() => setSelectedClass('')}
                className={`rounded-full border px-3 py-1 text-xs font-medium transition ${
                  selectedClass === ''
                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:border-indigo-400 dark:bg-indigo-900/30 dark:text-indigo-200'
                    : 'border-slate-300 text-slate-600 hover:border-slate-400 dark:border-slate-700 dark:text-slate-300'
                }`}
              >
                All classes
              </button>
              {classes.map((item) => (
                <button
                  key={item.value}
                  type="button"
                  onClick={() => setSelectedClass(item.value)}
                  className={`rounded-full border px-3 py-1 text-xs font-medium transition ${
                    selectedClass.toLowerCase() === item.value.toLowerCase()
                      ? 'border-indigo-500 bg-indigo-50 text-indigo-700 dark:border-indigo-400 dark:bg-indigo-900/30 dark:text-indigo-200'
                      : 'border-slate-300 text-slate-600 hover:border-slate-400 dark:border-slate-700 dark:text-slate-300'
                  }`}
                >
                  Class {item.value}
                  <span className="ml-2 rounded-full bg-slate-200 px-2 py-0.5 text-[10px] font-semibold text-slate-700 dark:bg-slate-700 dark:text-slate-200">
                    {item.count}
                  </span>
                </button>
              ))}
            </div>
          )}

          <ul className="space-y-5">
            {filtered.map((user) => (
              <AdminUserCard
                key={user.id}
                user={user}
                onToggleSubscription={onToggleSubscription}
                onChangeSubscriptionAmount={onChangeSubscriptionAmount}
                onAdjustBalance={onAdjustBalance}
                onChargeSubscription={onChargeSubscription}
                onRemoveUser={onRemoveUser}
              />
            ))}
            {filtered.length === 0 && <li className="text-sm text-slate-500">No matching accounts.</li>}
          </ul>
        </section>
      );
    }
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    function App() {
      const [users, setUsersState] = useState(loadUsers);
      const [currentUserId, setCurrentUserId] = useState(() => localStorage.getItem(CURRENT_USER_KEY));
      const [toast, setToast] = useState(null);
      const [theme, setTheme] = useState(() => localStorage.getItem(THEME_KEY) || 'light');

      const setUsers = useCallback((updater) => {
        setUsersState((prev) => {
          const nextValue = typeof updater === 'function' ? updater(prev) : updater;
          if (nextValue === prev) {
            return prev;
          }

          const nextArray = Array.isArray(nextValue) ? nextValue : prev;
          if (nextArray === prev) {
            return prev;
          }

          const normalizedForStorage = nextArray.map(normalizeUser);
          saveUsers(normalizedForStorage);
          return nextArray;
        });
      }, []);

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);

      useEffect(() => {
        if (currentUserId) {
          localStorage.setItem(CURRENT_USER_KEY, currentUserId);
        } else {
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      }, [currentUserId]);

      useEffect(() => {
        function handleStorage(event) {
          if (event.key === DB_KEY) {
            setUsersState(loadUsers());
          }
          if (event.key === CURRENT_USER_KEY) {
            setCurrentUserId(event.newValue || null);
          }
          if (event.key === THEME_KEY) {
            setTheme(event.newValue === 'dark' ? 'dark' : 'light');
          }
        }

        window.addEventListener('storage', handleStorage);
        return () => window.removeEventListener('storage', handleStorage);
      }, [setUsersState, setCurrentUserId, setTheme]);

      const currentUser = useMemo(
        () => users.find((user) => user.id === currentUserId) || null,
        [users, currentUserId]
      );

      const isAdmin = currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();

      function notify(message) {
        setToast(message);
      }

      function handleAuthenticate({ email, name, password, classNumber }) {
        const trimmedEmail = (email || '').trim().toLowerCase();
        if (!trimmedEmail || !trimmedEmail.includes('@')) {
          return notify('Enter a valid email address.');
        }
        const trimmedPassword = (password || '').trim();
        if (trimmedPassword.length < 4) {
          return notify('Password must be at least 4 characters.');
        }
        const trimmedClass = (classNumber || '').trim();

        setUsers((prev) => {
          const existing = prev.find((user) => user.email.toLowerCase() === trimmedEmail);
          if (existing) {
            if (existing.password && existing.password !== trimmedPassword) {
              notify('Incorrect password for this account.');
              return prev;
            }
            let nextUsers = prev;
            let message = `Welcome back, ${existing.name || existing.email}!`;
            if (trimmedClass && trimmedClass !== (existing.classNumber || '')) {
              nextUsers = prev.map((user) =>
                user.id === existing.id
                  ? normalizeUser({ ...user, classNumber: trimmedClass })
                  : user
              );
              message = `${message} Class ${trimmedClass} saved.`;
            }
            setCurrentUserId(existing.id);
            notify(message);
            return nextUsers;
          }

          if (!name || !name.trim()) {
            notify('Please tell us your name so we can create your account.');
            return prev;
          }

          const newUser = normalizeUser({
            id: uid(),
            name: name.trim(),
            email: trimmedEmail,
            password: trimmedPassword,
            classNumber: trimmedClass,
            subscriptionActive: trimmedEmail === ADMIN_EMAIL.toLowerCase() ? true : false,
            subscriptionAmount: DEFAULT_SUBSCRIPTION_AMOUNT,
            transactions: [],
            weeklyIncome: [],
            weeklyExpenses: [],
          });

          const updated = [...prev, newUser];
          setCurrentUserId(newUser.id);
          notify('Account created. Start tracking your money!');
          return updated;
        });
      }

      function logout() {
        setCurrentUserId(null);
        notify('Logged out safely');
      }

      function updateUser(id, updater) {
        setUsers((prev) =>
          prev.map((user) => {
            if (user.id !== id) return user;
            const next = typeof updater === 'function' ? updater(user) : updater;
            return normalizeUser({ ...user, ...next });
          })
        );
      }

      function removeUser(id) {
        setUsers((prev) => prev.filter((user) => user.id !== id));
        if (currentUserId === id) {
          setCurrentUserId(null);
        }
        notify('Account deleted');
      }

      function toggleSubscription(id, active) {
        updateUser(id, (user) => ({
          subscriptionActive: Boolean(active),
        }));
        notify(active ? 'Subscription activated' : 'Subscription paused');
      }

      function changeSubscriptionAmount(id, value) {
        const parsed = safeAmount(value);
        updateUser(id, () => ({ subscriptionAmount: parsed }));
        notify('Subscription amount saved');
      }

      function adjustBalance(id, amount, memo) {
        const delta = safeAmount(amount);
        if (delta === 0) return;
        updateUser(id, (user) => ({
          transactions: [
            ...(user.transactions || []),
            createTransaction({ amount: delta, memo, type: 'admin-adjustment' }),
          ],
        }));
        notify('Adjustment posted');
      }

      function chargeSubscription(id) {
        const target = users.find((user) => user.id === id);
        if (!target) return;
        if (!target.subscriptionActive) {
          notify('This subscription is paused. Activate it before charging.');
          return;
        }
        const timestamp = now();
        const amount = safeAmount(target.subscriptionAmount || DEFAULT_SUBSCRIPTION_AMOUNT);
        if (amount <= 0) {
          notify('Set a subscription amount greater than $0 before charging.');
          return;
        }
        if (target.lastSubscriptionPayment && timestamp - target.lastSubscriptionPayment < WEEK_MS) {
          notify('This account already paid within the last 7 days.');
          return;
        }
        updateUser(id, (user) => ({
          transactions: [
            ...(user.transactions || []),
            createTransaction({ amount: -Math.abs(amount), memo: 'Subscription fee', type: 'subscription' }),
          ],
          lastSubscriptionPayment: timestamp,
        }));
        notify('Subscription charge recorded');
      }

      const pageClasses = theme === 'dark' ? 'bg-slate-900 text-slate-100' : 'bg-slate-100 text-slate-900';

      return (
        <div className={`min-h-screen ${pageClasses}`}>
          <div className="mx-auto flex max-w-6xl flex-col gap-6 px-4 py-8">
            <Header
              onLogout={currentUser ? logout : null}
              onToggleTheme={() => setTheme((prev) => (prev === 'dark' ? 'light' : 'dark'))}
              theme={theme}
              isAdmin={isAdmin}
              userName={currentUser ? currentUser.name || currentUser.email : null}
            />

            {!currentUser && (
              <LoginCard
                onAuthenticate={handleAuthenticate}
                onToggleTheme={() => setTheme((prev) => (prev === 'dark' ? 'light' : 'dark'))}
                theme={theme}
              />
            )}

            {currentUser && !isAdmin && (
              <StudentDashboard
                user={currentUser}
                onUpdate={(updater) => updateUser(currentUser.id, updater)}
                onNotify={notify}
              />
            )}

            {currentUser && isAdmin && (
              <AdminDashboard
                users={users}
                onToggleSubscription={toggleSubscription}
                onChangeSubscriptionAmount={changeSubscriptionAmount}
                onAdjustBalance={adjustBalance}
                onChargeSubscription={chargeSubscription}
                onRemoveUser={removeUser}
              />
            )}
          </div>
          <Toast message={toast} onDismiss={() => setToast(null)} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
